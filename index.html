<!DOCTYPE html>
<html lang="de" class="dark antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Promptomizer V5 - Slate</title>
    <meta name="theme-color" content="#020617">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        navy: {
                            deep: '#020617',    // Slate 950 (Main Stage)
                            sidebar: '#0f172a', // Slate 900 (Sidebar)
                            border: '#1e293b',  // Slate 800 (Borders)
                        },
                        brand: {
                            sky: '#0ea5e9',    // DEIN ORIGINAL (Sky 500)
                             hover: '#38bdf8',  // Heller beim Drüberfahren (Hover Effekt umgedreht)
                        },
                        slate: {
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'glow': '0 0 20px -5px rgba(56, 189, 248, 0.3)',
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #020617; }
        
        /* Premium Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; border: 1px solid #0f172a; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        textarea::-webkit-scrollbar { width: 10px; }
        textarea::-webkit-scrollbar-track { background: transparent; }
        textarea::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; border: 1px solid #0f172a; }
        textarea::-webkit-scrollbar-thumb:hover { background: #475569; }


        /* Transitions */
        .sidebar-transition { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .rotate-icon { transition: transform 0.3s ease; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Input Styles - Surface Look */
        textarea { 
            resize: vertical; 
            outline: none; 
            background-color: #0f172a; /* Slate 900 - hebt sich vom Hintergrund ab */
            border: 1px solid #1e293b; /* Slate 800 */
            color: #f1f5f9;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        textarea:focus { 
            background-color: #0f172a;
            border-color: #38bdf8; 
            box-shadow: 0 0 0 1px #38bdf8, 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Toggle Button Style */
        .splitter-toggle {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 48px;
            background-color: #0f172a; /* Match Sidebar */
            border: 1px solid #1e293b;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
            color: #64748b;
            transition: all 0.2s;
        }
        .splitter-toggle:hover { color: #38bdf8; border-color: #38bdf8; background-color: #1e293b; }
        
        .nav-item .nav-indicator { opacity: 0; }
        .nav-item.active-nav .nav-indicator { opacity: 1; }
        .nav-item.active-nav {
            background-color: #1e293b; /* Slate 800 */
            color: white;
        }

        :root{
          --navy-deep:#020617;
          --navy-sidebar:#0f172a;
          --navy-border:#1e293b;
          --brand-sky:#0ea5e9;
          --brand-hover:#38bdf8;
          --text:#e2e8f0;
          --muted:#94a3b8;
        }

        .ui-backdrop{
          position:fixed;
          inset:0;
          background:rgba(0,0,0,.80);
          backdrop-filter:blur(6px);
          display:flex;
          align-items:center;
          justify-content:center;
          padding:16px;
        }

        .ui-modal{
          background:var(--navy-sidebar);
          border:1px solid var(--navy-border);
          border-radius:12px;
          box-shadow:0 25px 50px -12px rgba(0,0,0,.45);
          padding:24px;
          width:100%;
        }
        .ui-modal-sm{ max-width:24rem; }
        .ui-modal-lg{ max-width:32rem; }

        .ui-modal-header{
          display:flex;
          align-items:center;
          justify-content:space-between;
          margin-bottom:16px;
        }
        .ui-modal-title{
          font-size:1.25rem;
          font-weight:700;
          color:#fff;
        }

        .ui-icon-btn{
          color:#64748b;
          transition:color .15s ease, background .15s ease, transform .15s ease;
          border-radius:8px;
          padding:6px;
        }
        .ui-icon-btn:hover{ color:#fff; background:rgba(30,41,59,.40); }
        .ui-icon-btn:active{ transform:scale(.98); }

        .ui-label{
          font-size:.75rem;
          font-weight:700;
          color:#94a3b8;
          text-transform:uppercase;
          letter-spacing:.12em;
        }

        .ui-input, .ui-select, .ui-textarea{
          width:100%;
          margin-top:8px;
          border-radius:10px;
          padding:12px;
          background:var(--navy-deep);
          border:1px solid var(--navy-border);
          color:var(--text);
          outline:none;
          transition:border-color .15s ease, box-shadow .15s ease;
        }
        .ui-textarea{ min-height:120px; resize:vertical; }
        .ui-input:focus, .ui-select:focus, .ui-textarea:focus{
          border-color:var(--brand-sky);
          box-shadow:0 0 0 1px var(--brand-sky);
        }

        .ui-actions{
          display:flex;
          justify-content:flex-end;
          gap:12px;
          margin-top:24px;
        }

        .ui-btn{
          display:inline-flex;
          align-items:center;
          justify-content:center;
          gap:8px;
          padding:10px 16px;
          border-radius:10px;
          font-size:.875rem;
          font-weight:700;
          transition:background .15s ease, color .15s ease, border-color .15s ease, transform .15s ease, box-shadow .15s ease;
          user-select:none;
        }
        .ui-btn:active{ transform:scale(.98); }

        .ui-btn-ghost{
          color:var(--muted);
          background:transparent;
        }
        .ui-btn-ghost:hover{ color:#fff; }

        .ui-btn-primary{
          background:var(--brand-sky);
          color:var(--navy-deep);
          box-shadow:0 0 20px -5px rgba(56,189,248,.30);
        }
        .ui-btn-primary:hover{ background:var(--brand-hover); }

        .ui-btn-danger{
          background:#ef4444;
          color:#fff;
        }
        .ui-btn-danger:hover{ background:#dc2626; }

        #input-free-editor {
          font-family: 'Inter', sans-serif;
          white-space: pre-wrap;
          outline: none;
        }
        #input-free-editor:empty:before {
          content: attr(data-placeholder);
          color: #64748b;
        }
        #input-free-editor h1 { font-size: 1.5rem; font-weight: 700; color: #fff; }
        #input-free-editor h2 { font-size: 1.25rem; font-weight: 700; color: #fff; }
        #input-free-editor h3 { font-size: 1.1rem; font-weight: 700; color: #fff; }
        #input-free-editor blockquote {
          border-left: 2px solid #334155;
          padding-left: 12px;
          color: #cbd5f5;
          font-style: italic;
          margin: 6px 0;
        }
        #input-free-editor ul, #input-free-editor ol { margin-left: 1.25rem; }
    </style>
</head>
<body class="text-slate-400 h-screen flex flex-col w-full bg-navy-deep">

    <header class="h-14 border-b border-navy-border flex items-center justify-center flex-shrink-0 z-40 bg-navy-sidebar w-full relative shadow-sm">
        
        <div id="header-spacer-left" class="w-64 sidebar-transition flex-shrink-0 border-r border-transparent"></div>

        <div class="flex-1 flex justify-center px-6 md:px-10 min-w-0">
            <div class="w-full max-w-4xl flex items-center justify-between">
                
                <div class="flex items-center select-none leading-none">
                    <span class="text-xl font-bold tracking-tight text-white">Prompt</span>
                    <span class="text-xl font-bold tracking-tight text-brand-sky">omizer</span>
                </div>

                <div class="flex bg-navy-deep p-1 rounded-lg border border-navy-border">
                    <button onclick="setEditorMode('structured')" id="btn-mode-structured" class="px-5 py-1 rounded text-xs font-bold transition-all bg-brand-sky text-navy-deep shadow-glow">
                        Strukturiert
                    </button>
                    <button onclick="setEditorMode('free')" id="btn-mode-free" class="px-5 py-1 rounded text-xs font-bold text-slate-500 hover:text-slate-300 transition-all">
                        Frei
                    </button>
                </div>
            </div>
        </div>

    </header>

    <div class="flex-1 flex overflow-hidden relative">

        <aside id="sidebar-left" class="w-64 bg-navy-sidebar border-r border-navy-border flex flex-col sidebar-transition overflow-hidden relative flex-shrink-0 z-20">
            <div class="w-64 flex flex-col h-full">
                <div class="px-2 py-4">
                    <div class="text-[11px] font-bold text-slate-500 uppercase tracking-widest px-2 mb-2">Navigation</div>
                    <div class="space-y-0.5">
                        <div onclick="switchView('editor')" class="nav-item group relative flex items-center gap-3 px-3 py-2.5 rounded-md cursor-pointer active-nav transition-all">
                            <span class="nav-indicator absolute left-0 top-0 bottom-0 w-[3px] bg-brand-sky"></span>
                            <i class="fa-solid fa-pen-to-square w-5 text-center text-brand-sky"></i>
                            <span class="text-sm font-medium">Editor</span>
                        </div>
                        <div onclick="switchView('history')" class="nav-item group relative flex items-center gap-3 px-3 py-2.5 rounded-md cursor-pointer text-slate-500 hover:text-slate-200 hover:bg-slate-800/50 transition-all">
                            <span class="nav-indicator absolute left-0 top-0 bottom-0 w-[3px] bg-brand-sky"></span>
                            <i class="fa-solid fa-clock-rotate-left w-5 text-center group-hover:text-brand-sky transition-colors"></i>
                            <span class="text-sm font-medium">Historie</span>
                        </div>
                        <div onclick="toggleSettingsMenu(event)" class="nav-item group relative flex items-center gap-3 px-3 py-2.5 rounded-md cursor-pointer text-slate-500 hover:text-slate-200 hover:bg-slate-800/50 transition-all">
                            <span class="nav-indicator absolute left-0 top-0 bottom-0 w-[3px] bg-brand-sky"></span>
                            <i class="fa-solid fa-gear w-5 text-center group-hover:text-brand-sky transition-colors"></i>
                            <span class="text-sm font-medium">Einstellungen & Hilfe</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto p-0">
                    
                    <div class="sticky top-0 z-20 bg-navy-sidebar">
                        <button onclick="togglePromptsSection()" class="w-full flex items-center justify-between px-4 py-3 text-left">
                            <span class="flex items-center gap-2 text-base font-bold text-slate-400">
                                <i class="fa-solid fa-layer-group"></i> Prompts
                            </span>
                            <i id="prompts-toggle-icon" class="fa-solid fa-chevron-down text-xs rotate-icon rotate-180"></i>
                        </button>
                    </div>
                    <div id="prompts-body" class="px-4 pt-1 pb-2">
<div id="library-scenarios" class="space-y-0.5">
                            <div class="text-xs text-slate-600 italic py-2">Lade...</div>
                        </div>
                    </div>

                    <div>
                        <button onclick="toggleSnippetsSection()" class="w-full flex items-center justify-between px-4 py-3 text-left">
                            <span class="flex items-center gap-2 text-base font-bold text-slate-400">
                                <i class="fa-solid fa-cube"></i> Bausteine
                            </span>
                            <i id="snippets-toggle-icon" class="fa-solid fa-chevron-down text-xs rotate-icon rotate-180"></i>
                        </button>
                        <div id="snippets-body" class="px-4 pt-1 pb-2">
<div id="library-snippets" class="space-y-0.5">
                            <div class="text-xs text-slate-600 italic py-2">Wähle ein Feld im Editor.</div>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="mt-auto">
                    <div class="p-4 border-t border-navy-border bg-black/10">
                        <button onclick="openAuthModal()" class="w-full flex items-center gap-3 text-slate-400 hover:text-white transition-colors">
                            <div class="w-8 h-8 rounded bg-gradient-to-tr from-slate-700 to-slate-800 border border-slate-600 flex items-center justify-center text-white text-xs font-bold">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div class="text-left overflow-hidden">
                                <div id="user-name-display" class="text-sm font-bold text-slate-200 truncate">Gast</div>
                                <div id="user-status-sub" class="text-[10px] text-brand-sky font-bold tracking-wider uppercase truncate">Login</div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-navy-deep relative z-10 shadow-inner">
            
            <button onclick="toggleSidebar('left')" class="splitter-toggle -left-3 rounded-r-md border-l-0" title="Toggle Navigation">
                <i id="icon-toggle-left" class="fa-solid fa-chevron-left text-xs rotate-icon"></i>
            </button>

            <div id="main-scroll-area" class="flex-1 overflow-y-auto p-6 md:p-10 scroll-smooth">
                
                <div id="view-editor" class="max-w-4xl mx-auto fade-in pb-20">
                    
                    <div id="editor-structured" class="space-y-8 pt-4">
                        </div>

                    <div id="editor-free" class="hidden h-full flex flex-col pt-4">
                        <div class="sticky top-0 z-20 bg-navy-deep p-2 flex items-center justify-between">
                            <div class="flex gap-1">
                                <button id="btn-free-h1" type="button" class="free-format-btn px-2 py-1 rounded text-xs font-bold" onclick="toggleFreeFormat('h1')">H1</button>
                                <button id="btn-free-h2" type="button" class="free-format-btn px-2 py-1 rounded text-xs font-bold" onclick="toggleFreeFormat('h2')">H2</button>
                                <button id="btn-free-h3" type="button" class="free-format-btn px-2 py-1 rounded text-xs font-bold" onclick="toggleFreeFormat('h3')">H3</button>
                                <button id="btn-free-bold" type="button" class="free-format-btn p-2 rounded" onclick="toggleFreeFormat('bold')"><i class="fa-solid fa-bold"></i></button>
                                <button id="btn-free-quote" type="button" class="free-format-btn p-2 rounded" onclick="toggleFreeFormat('quote')"><i class="fa-solid fa-quote-right"></i></button>
                                <button id="btn-free-ul" type="button" class="free-format-btn p-2 rounded" onclick="toggleFreeFormat('ul')"><i class="fa-solid fa-list-ul"></i></button>
                                <button id="btn-free-ol" type="button" class="free-format-btn p-2 rounded" onclick="toggleFreeFormat('ol')"><i class="fa-solid fa-list-ol"></i></button>
                            </div>
                            <button type="button" class="group p-1.5 bg-transparent rounded-md hover:bg-slate-800/60 transition-colors" onclick="openFreeSnippetSaveModal()" title="Als Baustein speichern">
                                <i class="fa-solid fa-floppy-disk text-brand-sky group-hover:text-brand-hover transition-colors"></i>
                            </button>
                        </div>
                        <textarea id="input-free" class="hidden"></textarea>
                        <div id="input-free-editor" contenteditable="true" data-placeholder="Schreibe deinen Prompt hier..." class="w-full min-h-[60vh] bg-navy-sidebar border border-navy-border rounded-md p-6 text-slate-200 text-base leading-relaxed font-sans" onfocus="setActiveField('free')"></div>
                    </div>
                </div>

                <div id="view-history" class="hidden max-w-4xl mx-auto fade-in pt-4">
                    <div class="flex justify-between items-center mb-6 border-b border-navy-border pb-4">
                        <h2 class="text-2xl font-bold text-white">Historie</h2>
                        <button onclick="loadHistory()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-rotate-right"></i></button>
                    </div>
                    <div id="history-list" class="space-y-4"></div>
                </div>

                <div id="view-settings" class="hidden max-w-4xl mx-auto fade-in pt-4">
                    <div class="flex justify-between items-center mb-6 border-b border-navy-border pb-4">
                        <h2 id="settings-title" class="text-2xl font-bold text-white">Kategorien verwalten</h2>
                        <div id="settings-header-action"></div>
                    </div>
                    <div id="settings-content" class="space-y-4">
                        <div class="text-center text-slate-500 py-10">Inhalte folgen.</div>
                    </div>
                </div>

            </div>

            <footer class="h-20 border-t border-navy-border flex items-center justify-center px-8 z-30 flex-shrink-0 bg-navy-deep">
                <div class="w-full max-w-4xl flex items-center gap-4">
                    <div id="footer-save-wrap">
                        <button onclick="saveCurrentToLibrary()" class="bg-brand-sky hover:bg-brand-hover text-navy-deep font-bold py-3 px-8 rounded-md shadow-glow flex items-center gap-3 transform active:scale-95 transition-all">
                            <i class="fa-solid fa-floppy-disk"></i>
                            <span>Prompt speichern</span>
                        </button>
                    </div>
                    <div class="ml-auto flex items-center gap-4">
                        <button onclick="resetCurrentView()" class="px-6 py-3 text-slate-500 hover:text-red-400 font-medium transition-colors text-xs uppercase tracking-wider font-bold">
                            Reset
                        </button>
                        <button id="btn-copy" onclick="handleCopyAndSave()" class="bg-brand-sky hover:bg-brand-hover text-navy-deep font-bold py-3 px-8 rounded-md shadow-glow flex items-center gap-3 transform active:scale-95 transition-all">
                            <i class="fa-solid fa-copy"></i>
                            <span>Kopieren</span>
                        </button>
                    </div>
                </div>
            </footer>

        </main>
    </div>

    <div id="modal-snippet" class="ui-backdrop z-[110] hidden">
        <div class="ui-modal ui-modal-lg">
            <div class="ui-modal-header">
                <h3 id="snippet-modal-title" class="ui-modal-title">Neuer Baustein</h3>
                <button onclick="closeSnippetModal()" class="ui-icon-btn"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="ui-label">Name</label>
                    <input id="snippet-name" type="text" class="ui-input" placeholder="z.B. Kontext-Short" />
                </div>
                <div>
                    <label class="ui-label">Kategorie</label>
                    <select id="snippet-category" class="ui-select">
                        <option value="role">Rolle & Funktion</option>
                        <option value="context">Kontext</option>
                        <option value="task">Aufgabe</option>
                        <option value="style">Stil & Tonalität</option>
                        <option value="format">Format</option>
                        <option value="free">Freie Bausteine</option>
                    </select>
                </div>
                <div>
                    <label class="ui-label">Baustein-Text</label>
                    <textarea id="snippet-content" class="ui-textarea" placeholder="Text für den Baustein..."></textarea>
                </div>
            </div>
            <div class="ui-actions">
                <button onclick="closeSnippetModal()" class="ui-btn ui-btn-ghost">Abbrechen</button>
                <button onclick="saveSnippetFromModal()" class="ui-btn ui-btn-primary">Speichern</button>
            </div>
        </div>
    </div>
    <div id="modal-auth" class="fixed inset-0 z-[100] hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-navy-sidebar border border-navy-border w-full max-w-sm rounded-lg shadow-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white">Login</h3>
                <button onclick="closeAuthModal()" class="text-slate-500 hover:text-white">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">E-Mail</label>
                    <input id="auth-email" type="email"
                           class="w-full mt-2 rounded-md p-3 bg-navy-deep border border-navy-border text-slate-200 focus:border-brand-sky outline-none"
                           placeholder="name@mail.de" />
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Passwort</label>
                    <input id="auth-password" type="password"
                           class="w-full mt-2 rounded-md p-3 bg-navy-deep border border-navy-border text-slate-200 focus:border-brand-sky outline-none"
                           placeholder="••••••••" />
                </div>

                <label class="flex items-center gap-2 text-sm text-slate-300 select-none">
                    <input id="auth-remember" type="checkbox" class="accent-brand-sky" />
                    Angemeldet bleiben
                </label>

                <div id="auth-error" class="hidden text-sm text-red-400"></div>

                <button onclick="handleEmailLogin()"
                        class="w-full py-3 bg-brand-sky hover:bg-brand-hover text-navy-deep font-bold rounded-md shadow-glow transition-all active:scale-95">
                    Einloggen
                </button>

                <div class="h-px bg-navy-border"></div>

                <button onclick="loginWithGoogle()"
                        class="w-full py-3 bg-white text-navy-deep font-bold rounded-md flex justify-center gap-2 hover:bg-slate-100 transition-colors">
                    <i class="fa-brands fa-google"></i> Google Login
                </button>
            </div>
        </div>
    </div>

    <div id="snippet-item-menu" class="fixed z-[120] hidden bg-navy-sidebar border border-navy-border rounded-md shadow-xl w-40">
        <button onclick="handleEditSnippet()" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/60">Bearbeiten</button>
        <button onclick="handleAskDeleteSnippet()" class="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-slate-800/60">Löschen</button>
    </div>

    <div id="prompt-item-menu" class="fixed z-[120] hidden bg-navy-sidebar border border-navy-border rounded-md shadow-xl w-44">
        <button onclick="handleEditPrompt()" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/60">Bearbeiten</button>
        <div id="prompt-menu-category" class="relative group">
            <button class="w-full flex items-center justify-between px-4 py-2 text-left text-sm text-slate-300 hover:bg-slate-800/60" onmouseenter="openPromptCategorySubmenu()" onclick="return false;">
                <span>Kategorie</span>
                <i class="fa-solid fa-chevron-right text-xs text-slate-400"></i>
            </button>
            <div id="prompt-category-submenu" class="absolute top-0 left-full ml-2 w-64 hidden bg-navy-sidebar border border-navy-border rounded-lg shadow-2xl overflow-hidden">
                <button class="w-full flex items-center gap-2 px-4 py-2 text-left text-sm hover:bg-slate-800/60 text-brand-sky" onclick="handlePromptCategoryCreateFromMenu(event)">
                    Kategorie anlegen
                </button>
                <div class="h-px bg-navy-border"></div>
                <div id="prompt-category-submenu-list" class="py-1">
                    <div class="px-3 py-2 text-xs text-slate-500 italic">Lade…</div>
                </div>
            </div>
        </div>
        <button onclick="handleAskDeletePrompt()" class="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-slate-800/60">Löschen</button>
    </div>

    <div id="manage-category-menu" class="fixed z-[120] hidden bg-navy-sidebar border border-navy-border rounded-md shadow-xl w-44">
        <button onclick="handleManageCategoryRename()" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/60">Umbenennen</button>
        <button onclick="handleManageCategoryDelete()" class="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-slate-800/60">Löschen</button>
    </div>
    <div id="manage-snippet-menu" class="fixed z-[120] hidden bg-navy-sidebar border border-navy-border rounded-md shadow-xl w-44">
        <button onclick="handleManageSnippetEdit()" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/60">Bearbeiten</button>
        <button id="manage-snippet-target-trigger" class="w-full flex items-center justify-between px-4 py-2 text-left text-sm text-slate-300 hover:bg-slate-800/60" onmouseenter="openManageSnippetTargetSubmenu()" onclick="return false;">
            <span>Baustein</span>
            <i class="fa-solid fa-chevron-right text-xs text-slate-400"></i>
        </button>
        <button onclick="handleManageSnippetDelete()" class="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-slate-800/60">Löschen</button>
    </div>
    <div id="manage-snippet-target-submenu" class="fixed z-[121] hidden bg-navy-sidebar border border-navy-border rounded-lg shadow-2xl overflow-hidden w-64">
        <div id="manage-snippet-target-submenu-list" class="py-1">
            <div class="px-3 py-2 text-xs text-slate-500 italic">Lade…</div>
        </div>
    </div>
    <div id="settings-nav-menu" class="fixed z-[120] hidden bg-navy-sidebar border border-navy-border rounded-lg shadow-2xl overflow-hidden w-56">
        <button onclick="openSettingsPage('categories')" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/60">Kategorien verwalten</button>
        <button onclick="openSettingsPage('snippets')" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/60">Bausteine verwalten</button>
        <button onclick="openSettingsPage('help')" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/60">Hilfe</button>
    </div>

    <div id="modal-snippet-delete" class="ui-backdrop z-[120] hidden">
        <div class="ui-modal ui-modal-sm">
            <h3 class="ui-modal-title mb-4">Unwiderruflich löschen?</h3>
            <div class="ui-actions">
                <button onclick="closeDeleteSnippetModal()" class="ui-btn ui-btn-ghost">Nein</button>
                <button onclick="confirmDeleteSnippet()" class="ui-btn ui-btn-danger">Ja</button>
            </div>
        </div>
    </div>

    <div id="modal-prompt-delete" class="ui-backdrop z-[120] hidden">
        <div class="ui-modal ui-modal-sm">
            <h3 class="ui-modal-title mb-4">Endgültig löschen?</h3>
            <div class="ui-actions">
                <button onclick="closeDeletePromptModal()" class="ui-btn ui-btn-ghost">Nein</button>
                <button onclick="confirmDeletePrompt()" class="ui-btn ui-btn-danger">Ja</button>
            </div>
        </div>
    </div>

    <div id="modal-prompt-edit" class="ui-backdrop z-[120] hidden">
        <div class="ui-modal ui-modal-sm">
            <h3 class="ui-modal-title mb-2">Prompt bearbeiten</h3>
            <p class="text-sm text-slate-400">Modal folgt im nÃ¤chsten Schritt.</p>
            <div class="ui-actions">
                <button onclick="closePromptEditModal()" class="ui-btn ui-btn-ghost">SchlieÃŸen</button>
            </div>
        </div>
    </div>

    <div id="modal-prompt-category" class="ui-backdrop z-[140] hidden">
        <div class="ui-modal ui-modal-lg">
            <div class="ui-modal-header">
                <h3 class="ui-modal-title">Kategorie anlegen</h3>
                <button onclick="closePromptCategoryModal()" class="ui-icon-btn">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <label class="ui-label">Name der Kategorie</label>
            <input id="prompt-category-name" type="text" class="ui-input" placeholder="z. B. Verwaltung, Workshop, ..." />
            <div class="ui-actions">
                <button onclick="closePromptCategoryModal()" class="ui-btn ui-btn-ghost">Abbrechen</button>
                <button onclick="savePromptCategoryFromModal()" class="ui-btn ui-btn-primary">Speichern</button>
            </div>
        </div>
    </div>

    <div id="modal-category-rename" class="ui-backdrop z-[120] hidden">
        <div class="ui-modal ui-modal-sm">
            <div class="ui-modal-header">
                <h3 class="ui-modal-title">Kategorie umbenennen</h3>
                <button onclick="closeRenameCategoryModal()" class="ui-icon-btn">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <label class="ui-label">Neuer Name</label>
            <input id="rename-category-name" type="text" class="ui-input" placeholder="z. B. Marketing, Workshop, ..." />
            <div class="ui-actions">
                <button onclick="closeRenameCategoryModal()" class="ui-btn ui-btn-ghost">Abbrechen</button>
                <button onclick="confirmRenameCategory()" class="ui-btn ui-btn-primary">Speichern</button>
            </div>
        </div>
    </div>

    <div id="modal-category-delete" class="ui-backdrop z-[120] hidden">
        <div class="ui-modal ui-modal-sm">
            <h3 class="ui-modal-title mb-3">Kategorie löschen</h3>
            <p class="text-sm text-slate-400 mb-4">Die Prompts in dieser Kategorie werden nicht gelöscht. Sie erscheinen anschließend unter „Ohne Kategorie“.</p>
            <div class="ui-actions">
                <button onclick="closeDeleteCategoryModal()" class="ui-btn ui-btn-ghost">Abbrechen</button>
                <button onclick="confirmDeleteCategory()" class="ui-btn ui-btn-danger">Löschen</button>
            </div>
        </div>
    </div>
    <div id="modal-save-prompt" class="fixed inset-0 z-[120] hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-navy-sidebar border border-navy-border w-full max-w-lg rounded-lg shadow-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white">Prompt speichern</h3>
                <button onclick="closeSavePromptModal()" class="text-slate-500 hover:text-white">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Name</label>
            <input id="save-prompt-name" type="text"
                   class="w-full mt-2 rounded-md p-3 bg-navy-deep border border-navy-border text-slate-200 focus:border-brand-sky outline-none"
                   placeholder="z.B. Workshop Auftakt" />

            <div id="save-prompt-category-field" class="mt-4 relative">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-wider block">Kategorie (optional)</label>
                <button type="button" id="save-prompt-category-trigger"
                        class="w-full mt-2 rounded-md p-3 bg-navy-deep border border-navy-border text-slate-200 focus:border-brand-sky outline-none flex items-center justify-between"
                        onclick="openSavePromptCategoryMenu(event)">
                    <span id="save-prompt-category-value" class="truncate">Ohne Kategorie</span>
                    <i class="fa-solid fa-chevron-down text-xs text-slate-400"></i>
                </button>
                <div id="save-prompt-category-menu" class="absolute left-0 right-0 mt-2 hidden bg-navy-sidebar border border-navy-border rounded-lg shadow-2xl overflow-hidden z-20">
                    <button class="w-full flex items-center gap-2 px-4 py-2 text-left text-sm hover:bg-slate-800/60 text-brand-sky"
                            onclick="handleSavePromptCategoryCreate(event)">
                        Kategorie anlegen
                    </button>
                    <div class="h-px bg-navy-border"></div>
                    <div id="save-prompt-category-list" class="py-1"></div>
                </div>
            </div>

            <div id="save-prompt-error" class="hidden text-sm text-red-400 mt-3"></div>

            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeSavePromptModal()" class="px-4 py-2 text-slate-400 hover:text-white">Abbrechen</button>
                <button onclick="confirmSavePromptModal()" class="px-5 py-2 bg-brand-sky hover:bg-brand-hover text-navy-deep font-bold rounded-md">
                    Speichern
                </button>
            </div>
        </div>
    </div>

    <div id="modal-reset" class="fixed inset-0 z-[120] hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-navy-sidebar border border-navy-border w-full max-w-sm rounded-lg shadow-2xl p-6">
            <h3 class="text-xl font-bold text-white mb-3">Wirklich alles leeren?</h3>
            <p class="text-sm text-slate-400 mb-6">Der aktuelle Inhalt im Editor wird zurückgesetzt.</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeResetModal()" class="px-4 py-2 text-slate-400 hover:text-white">Abbrechen</button>
                <button onclick="confirmReset()" class="px-5 py-2 bg-red-500 hover:bg-red-600 text-white font-bold rounded-md">Reset</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const FIELDS = [
            { id: 'role', label: 'Rolle & Funktion', icon: 'fa-user-tie', placeholder: 'Wer soll die KI sein? (z.B. Senior SEO Experte)' },
            { id: 'context', label: 'Kontext', icon: 'fa-earth-europe', placeholder: 'Hintergrundinfos (Zielgruppe, Kanal, Produkt...)' },
            { id: 'task', label: 'Aufgabe', icon: 'fa-bullseye', placeholder: 'Was soll getan werden? (Schreibe 3 Headlines...)' },
            { id: 'style', label: 'Stil & Tonalität', icon: 'fa-palette', placeholder: 'Wie soll es klingen? (Professionell, witzig, kurz...)' },
            { id: 'format', label: 'Format', icon: 'fa-list-check', placeholder: 'Ausgabeformat (Tabelle, Markdown, Liste...)' }
        ];

        const SNIPPET_CATEGORIES = [
            { id: 'role', label: 'Rolle & Funktion', mode: 'structured' },
            { id: 'context', label: 'Kontext', mode: 'structured' },
            { id: 'task', label: 'Aufgabe', mode: 'structured' },
            { id: 'style', label: 'Stil & Tonalität', mode: 'structured' },
            { id: 'format', label: 'Format', mode: 'structured' },
            { id: 'free', label: 'Freie Bausteine', mode: 'free' }
        ];

        let currentMode = 'structured';
        let isLeftOpen = true;
        let isPromptsOpen = true;
        let isSnippetsOpen = true;
        let activeFieldId = null;
        let fieldFullscreenState = {};
        let snippetOpenState = { role: false, context: false, task: false, style: false, format: false, free: false };
        let snippetMenuOpen = false;
        let snippetMenuSnippetId = null;
        let snippetMenuCategoryId = null;
        let snippetCacheById = {};
        let editingSnippetId = null;
        let pendingDeleteSnippetId = null;
        let pendingDeleteCategoryId = null;
        let promptOpenState = {};
        let promptCategoriesCache = [];
        let promptLibraryCache = [];
        let promptCategoryKeyToName = {};
        let promptMenuOpen = false;
        let promptMenuPromptId = null;
        let promptMenuCategoryKey = null;
        let pendingDeletePromptId = null;
        let pendingDeletePromptCategoryKey = null;
        let savePromptSelectedCategory = '';
        let savePromptCategoryMenuOpen = false;
        let settingsMenuOpen = false;
        let settingsCurrentPage = 'categories';
        let manageCategoryOpenState = {};
        window.manageCategoryOpenState = manageCategoryOpenState;
        let manageCategoryMenuOpen = false;
        let manageCategoryMenuId = null;
        let manageCategoryMenuName = '';
        let pendingRenameCategoryId = null;
        let pendingRenameCategoryName = '';
        let pendingDeleteManageCategoryId = null;
        let pendingDeleteManageCategoryName = '';
        let manageCategoriesCache = [];
        let managePromptsCache = [];
        let manageSnippetsOpenState = {};
        let manageSnippetsCacheByCat = {};
        let manageSnippetCacheById = {};
        let manageSnippetMenuOpen = false;
        let manageSnippetMenuSnippetId = null;
        let manageSnippetMenuCategoryId = null;
        let editingSnippetOriginalCategoryId = null;
        let freeFormatActive = 'none';

        /// --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderStructuredFields();
            renderSnippetsAccordion();
            initFreeEditor();
            document.addEventListener('click', (ev) => {
                if (snippetMenuOpen) closeSnippetItemMenu();
                if (promptMenuOpen) closePromptItemMenu();
                if (manageSnippetMenuOpen) closeManageSnippetMenu();
                if (savePromptCategoryMenuOpen) {
                    const field = document.getElementById('save-prompt-category-field');
                    if (!field || !field.contains(ev.target)) closeSavePromptCategoryMenu();
                }
                if (manageCategoryMenuOpen) closeManageCategoryMenu();
                if (settingsMenuOpen) closeSettingsMenu();
            });
            document.addEventListener('keydown', (ev) => {
                if (ev.key === 'Escape' && savePromptCategoryMenuOpen) closeSavePromptCategoryMenu();
                if (ev.key === 'Escape' && manageSnippetMenuOpen) closeManageSnippetMenu();
                if (ev.key === 'Escape' && manageCategoryMenuOpen) closeManageCategoryMenu();
                if (ev.key === 'Escape' && settingsMenuOpen) closeSettingsMenu();
            });

            // 1. Event Listener: Feuert sofort, wenn Supabase den Login bestätigt
            window.addEventListener('auth-state-changed', (event) => {
                const user = event.detail;
                console.log("🚀 Auth Status Update:", user ? "Eingeloggt" : "Gast");
                
                // UI und Bibliothek sofort aktualisieren
                updateUIAuth(user);
                loadLibrary(); 
            });

            // 2. Fallback Start: Versucht es einmalig kurz nach Start 
            // (Wichtig für Gast-Modus oder falls der Login extrem schnell war)
            setTimeout(() => {
                if(window.db && window.db.getScenarios) loadLibrary();
                if(window.currentUser) updateUIAuth(window.currentUser);
            }, 500);
        });

        // --- AUTH UI UPDATE ---
        function updateUIAuth(user) {
          const nameEl = document.getElementById('user-name-display');
          const subEl = document.getElementById('user-status-sub');
          if(nameEl && subEl) {
              if(user) {
                 nameEl.innerText = user.email.split('@')[0];
                 subEl.innerText = 'Pro Plan';
                 subEl.classList.add('text-brand-sky');
              } else {
                 nameEl.innerText = 'Gast';
                 subEl.innerText = 'Klicken zum Login';
                 subEl.classList.remove('text-brand-sky');
              }
          }
        }

        function closeAuthModal() {
            document.getElementById('modal-auth').classList.add('hidden');
        }

        function openAuthModal() {
            const remember = localStorage.getItem('promptomizer_remember') !== 'false';
            const cb = document.getElementById('auth-remember');
            if (cb) {
                cb.checked = remember;
                cb.onchange = () => {
                    if (window.setRememberPref) window.setRememberPref(cb.checked);
                };
            }

            const err = document.getElementById('auth-error');
            if (err) {
                err.classList.add('hidden');
                err.innerText = '';
            }

            document.getElementById('modal-auth').classList.remove('hidden');
        }

        async function handleEmailLogin() {
            const email = (document.getElementById('auth-email')?.value || '').trim();
            const password = (document.getElementById('auth-password')?.value || '').trim();
            const remember = !!document.getElementById('auth-remember')?.checked;

            const err = document.getElementById('auth-error');
            const showErr = (msg) => {
                if (!err) return;
                err.innerText = msg;
                err.classList.remove('hidden');
            };

            if (!email || !password) {
                showErr('Bitte E-Mail und Passwort eingeben.');
                return;
            }

            if (window.setRememberPref) window.setRememberPref(remember);

            const { data, error } = await loginUser(email, password);
            if (error) {
                showErr(error.message || 'Login fehlgeschlagen.');
                return;
            }

            closeAuthModal();
        }

        // --- RENDER ---
        function renderStructuredFields() {
            const container = document.getElementById('editor-structured');
            container.innerHTML = FIELDS.map(f => `
                <div class="group relative">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fa-solid ${f.icon} text-brand-sky"></i>
                        <label class="font-bold text-brand-sky text-xl">${f.label}</label>
                    </div>
                    <textarea id="input-${f.id}" 
                        class="w-full h-32 rounded-md p-4 text-slate-200 placeholder-slate-600 text-base leading-relaxed"
                        placeholder="${f.placeholder}"
                        onfocus="setActiveField('${f.id}')"></textarea>
                    <div class="absolute top-0 right-0 flex items-center gap-1">
                        <button class="group p-1.5 bg-transparent rounded-md hover:bg-slate-800/60 transition-colors" onclick="event.stopPropagation(); toggleFieldFullscreen('${f.id}')" title="Feld vergrößern">
                            <i id="field-fullscreen-icon-${f.id}" class="fa-solid fa-up-right-and-down-left-from-center text-brand-sky group-hover:text-brand-hover transition-colors"></i>
                        </button>
                        <button class="group p-1.5 bg-transparent rounded-md hover:bg-slate-800/60 transition-colors" onclick="event.stopPropagation(); openSnippetModalFromField('${f.id}')" title="Als Baustein speichern">
                            <i class="fa-solid fa-floppy-disk text-brand-sky group-hover:text-brand-hover transition-colors"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function toggleFieldFullscreen(fieldId) {
            const ta = document.getElementById(`input-${fieldId}`);
            const icon = document.getElementById(`field-fullscreen-icon-${fieldId}`);
            if (!ta || !icon) return;

            const isExpanded = !!fieldFullscreenState[fieldId];
            if (!isExpanded) {
                const baseHeight = ta.offsetHeight;
                ta.dataset.baseHeightPx = baseHeight;
                ta.style.height = (baseHeight * 3) + 'px';
                fieldFullscreenState[fieldId] = true;
                icon.classList.remove('fa-up-right-and-down-left-from-center');
                icon.classList.add('fa-down-left-and-up-right-to-center');
            } else {
                const baseHeight = parseFloat(ta.dataset.baseHeightPx || '0');
                ta.style.height = baseHeight ? (baseHeight + 'px') : '';
                fieldFullscreenState[fieldId] = false;
                icon.classList.remove('fa-down-left-and-up-right-to-center');
                icon.classList.add('fa-up-right-and-down-left-from-center');
            }
        }
        // --- LAYOUT LOGIC ---
        function toggleSidebar(side) {
            const el = document.getElementById(`sidebar-${side}`);
            const icon = document.getElementById(`icon-toggle-${side}`);
            const spacer = document.getElementById(`header-spacer-${side}`);
            
            if (side === 'right') return;

            if (side === 'left') {
                if (isLeftOpen) {
                    el.classList.replace('w-64', 'w-0');
                    spacer.classList.replace('w-64', 'w-0');
                    icon.classList.add('rotate-180');
                } else {
                    el.classList.replace('w-0', 'w-64');
                    spacer.classList.replace('w-0', 'w-64');
                    icon.classList.remove('rotate-180');
                }
                isLeftOpen = !isLeftOpen;
            }
        }

        function togglePromptsSection() {
            isPromptsOpen = !isPromptsOpen;
            const body = document.getElementById('prompts-body');
            const icon = document.getElementById('prompts-toggle-icon');
            if (body) body.classList.toggle('hidden', !isPromptsOpen);
            if (icon) icon.classList.toggle('rotate-180', isPromptsOpen);
        }

        function toggleSnippetsSection() {
            isSnippetsOpen = !isSnippetsOpen;
            const body = document.getElementById('snippets-body');
            const icon = document.getElementById('snippets-toggle-icon');
            if (body) body.classList.toggle('hidden', !isSnippetsOpen);
            if (icon) icon.classList.toggle('rotate-180', isSnippetsOpen);
        }

        function toggleSettingsMenu(ev) {
            if (ev) ev.stopPropagation();
            const menu = document.getElementById('settings-nav-menu');
            const target = ev?.currentTarget;
            if (!menu || !target) return;

            if (settingsMenuOpen) {
                closeSettingsMenu();
                return;
            }

            if (snippetMenuOpen) closeSnippetItemMenu();
            if (promptMenuOpen) closePromptItemMenu();
            if (manageSnippetMenuOpen) closeManageSnippetMenu();
            if (savePromptCategoryMenuOpen) closeSavePromptCategoryMenu();
            if (manageCategoryMenuOpen) closeManageCategoryMenu();

            menu.classList.remove('hidden');
            const rect = target.getBoundingClientRect();
            const menuWidth = menu.offsetWidth || 220;
            const menuHeight = menu.offsetHeight || 120;
            const maxLeft = Math.max(8, window.innerWidth - menuWidth - 8);
            const maxTop = Math.max(8, window.innerHeight - menuHeight - 8);
            const left = Math.min(rect.right + 10, maxLeft);
            const top = Math.min(rect.top, maxTop);
            menu.style.left = left + 'px';
            menu.style.top = top + 'px';
            settingsMenuOpen = true;
            menu.onclick = (e) => e.stopPropagation();
        }

        function closeSettingsMenu() {
            const menu = document.getElementById('settings-nav-menu');
            if (menu) menu.classList.add('hidden');
            settingsMenuOpen = false;
        }

        function renderSettingsPage() {
            const titleEl = document.getElementById('settings-title');
            const contentEl = document.getElementById('settings-content');
            const actionEl = document.getElementById('settings-header-action');
            const map = {
                categories: 'Kategorien verwalten',
                snippets: 'Bausteine verwalten',
                help: 'Hilfe',
                import: 'Import & Export'
            };
            const title = map[settingsCurrentPage] || 'Einstellungen & Hilfe';
            if (titleEl) titleEl.textContent = title;
            if (actionEl) {
                if (settingsCurrentPage === 'categories') {
                    actionEl.innerHTML = `
                        <button onclick="openPromptCategoryModal()" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-slate-800/50">
                            <span class="text-brand-sky text-sm font-medium">Kategorie anlegen</span>
                        </button>
                    `;
                } else {
                    actionEl.innerHTML = '';
                }
            }
            if (contentEl) {
                if (settingsCurrentPage === 'categories') {
                    contentEl.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Lade...</div>';
                    loadManageCategoriesPage();
                    return;
                }
                if (settingsCurrentPage === 'snippets') {
                    contentEl.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Lade...</div>';
                    loadManageSnippetsPage();
                    return;
                }
                contentEl.innerHTML = '<div class="text-center text-slate-500 py-10">Inhalte folgen.</div>';
            }
        }

        function openSettingsPage(pageKey) {
            settingsCurrentPage = pageKey || 'categories';
            renderSettingsPage();
            closeSettingsMenu();
            switchView('settings');
        }
        function manageCategoryStateKey(name) {
            const normalized = normalizeCategoryName(name);
            return normalized ? normalized : '__uncat__';
        }

        async function loadManageCategoriesPage() {
            const contentEl = document.getElementById('settings-content');
            if (!contentEl) return;

            if (!window.currentUser) {
                contentEl.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Bitte einloggen, um Kategorien zu verwalten.</div>';
                return;
            }

            if (!window.db) {
                contentEl.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Datenbank nicht verfügbar.</div>';
                return;
            }

            manageCategoriesCache = window.db.getPromptCategories ? await window.db.getPromptCategories() : [];
            managePromptsCache = window.db.getScenarios ? await window.db.getScenarios() : [];

            renderManageCategoriesAccordion();
        }

        function renderManageCategoriesAccordion() {
            const container = document.getElementById('settings-content');
            if (!container) return;

            const categories = [
                { id: null, name: '', label: 'Ohne Kategorie', isPseudo: true },
                ...(manageCategoriesCache || []).map(c => ({ id: c.id, name: c.name, label: c.name, isPseudo: false }))
            ];

            if (!categories.length) {
                container.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Keine Kategorien.</div>';
                return;
            }

            container.innerHTML = categories.map(cat => {
                const key = manageCategoryStateKey(cat.name);
                if (manageCategoryOpenState[key] === undefined) manageCategoryOpenState[key] = false;

                const catName = normalizeCategoryName(cat.name);
                const filtered = (managePromptsCache || []).filter(p => {
                    const normalized = normalizeCategoryName(p.category);
                    if (!catName) return !normalized;
                    return normalized === catName;
                });

                const catKey = categoryKeyFromName(catName);
                const promptList = filtered.length ? `
                    <div class="space-y-0.5">
                        ${filtered.map(p => `
                            <div id="manage-prompt-${p.id}" class="group w-full py-1 px-1 rounded hover:bg-slate-800/50 cursor-pointer transition-colors" onclick="handlePromptClick(${p.id})">
                                <div class="flex items-center justify-between w-full">
                                    <div class="text-sm text-slate-300 group-hover:text-white truncate leading-tight min-w-0 flex-1" title=${JSON.stringify(p.name || '')}>${p.name}</div>
                                    <button class="p-1 rounded hover:bg-slate-800 text-slate-400 hover:text-white leading-none flex-none" onclick="openPromptItemMenu(event, '${catKey}', ${p.id})">
                                        <i class="fa-solid fa-ellipsis"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : '<div class="text-xs text-slate-600 italic py-2 pl-1">Keine Prompts.</div>';

                const menuButton = cat.isPseudo ? '' : `
                    <button type="button" class="p-1 rounded hover:bg-slate-800 text-slate-400 hover:text-white leading-none flex-none" onclick='return openManageCategoryMenu(event, ${JSON.stringify(cat.id)}, ${JSON.stringify(cat.name)})'>
                        <i class="fa-solid fa-ellipsis"></i>
                    </button>
                `;

                return `                    <div>
                        <div class="group w-full flex items-center justify-between p-2 text-left hover:bg-slate-800/50 rounded cursor-pointer" role="button" tabindex="0" onclick="toggleManageCategory('${key}')">
                            <div class="flex items-center gap-2 min-w-0 flex-1">
                                <i class="fa-regular fa-folder text-sm text-slate-400 group-hover:text-slate-200 transition-colors"></i>
                                <span class="truncate text-sm font-bold text-slate-300">${cat.label}</span>
                            </div>
                            <div class="flex items-center gap-2 shrink-0">
                                ${menuButton}
                                <i id="manage-cat-icon-${key}" class="fa-solid fa-chevron-down text-xs transition-transform ${manageCategoryOpenState[key] ? 'rotate-180' : ''}"></i>
                            </div>
                        </div>
                        <div id="manage-cat-body-${key}" class="${manageCategoryOpenState[key] ? '' : 'hidden'} pl-8 pr-0 pb-2">
                            ${promptList}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleManageCategory(key) {
            const body = document.getElementById(`manage-cat-body-${key}`);
            const icon = document.getElementById(`manage-cat-icon-${key}`);
            if (!body) return;

            manageCategoryOpenState[key] = !manageCategoryOpenState[key];
            body.classList.toggle('hidden', !manageCategoryOpenState[key]);
            if (icon) icon.classList.toggle('rotate-180', manageCategoryOpenState[key]);
        }

        async function loadManageSnippetsPage() {
            const contentEl = document.getElementById('settings-content');
            if (!contentEl) return;

            if (!window.currentUser) {
                contentEl.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Bitte einloggen, um Bausteine zu verwalten.</div>';
                return;
            }

            if (!window.db || !window.db.getSnippets) {
                contentEl.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Datenbank nicht verfügbar.</div>';
                return;
            }

            manageSnippetsCacheByCat = {};
            manageSnippetCacheById = {};

            for (const cat of SNIPPET_CATEGORIES) {
                if (manageSnippetsOpenState[cat.id] === undefined) manageSnippetsOpenState[cat.id] = false;
                const rows = await window.db.getSnippets({ mode: cat.mode, fieldId: cat.id });
                const list = Array.isArray(rows) ? rows : [];
                manageSnippetsCacheByCat[cat.id] = list;
                list.forEach(s => { manageSnippetCacheById[s.id] = s; });
            }

            renderManageSnippetsAccordion();
        }

        function renderManageSnippetsAccordion() {
            const container = document.getElementById('settings-content');
            if (!container) return;

            container.innerHTML = SNIPPET_CATEGORIES.map(cat => {
                if (manageSnippetsOpenState[cat.id] === undefined) manageSnippetsOpenState[cat.id] = false;
                const snippets = manageSnippetsCacheByCat[cat.id] || [];
                const snippetList = snippets.length ? `
                    <div class="space-y-0.5">
                        ${snippets.map(snippet => {
                            manageSnippetCacheById[snippet.id] = snippet;
                            return `
                                <div id="manage-snippet-${snippet.id}" class="group w-full py-1 px-1 rounded hover:bg-slate-800/50 transition-colors">
                                    <div class="flex items-center justify-between w-full">
                                        <div class="text-sm text-slate-300 group-hover:text-white truncate leading-tight min-w-0 flex-1" title=${JSON.stringify(snippet.name || '')}>${snippet.name}</div>
                                        <button class="p-1 rounded hover:bg-slate-800 text-slate-400 hover:text-white leading-none flex-none" onclick="openManageSnippetMenu(event, '${cat.id}', ${snippet.id})">
                                            <i class="fa-solid fa-ellipsis"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : '<div class="text-xs text-slate-600 italic py-2 pl-1">Keine Bausteine.</div>';

                return `                    <div>
                        <div class="group w-full flex items-center justify-between p-2 text-left hover:bg-slate-800/50 rounded cursor-pointer" role="button" tabindex="0" onclick="toggleManageSnippetCategory('${cat.id}')">
                            <div class="flex items-center gap-2 min-w-0 flex-1">
                                <i class="fa-regular fa-folder text-sm text-slate-400 group-hover:text-slate-200 transition-colors"></i>
                                <span class="truncate text-sm font-bold text-slate-300">${cat.label}</span>
                            </div>
                            <i id="manage-snippet-icon-${cat.id}" class="fa-solid fa-chevron-down text-xs transition-transform ${manageSnippetsOpenState[cat.id] ? 'rotate-180' : ''}"></i>
                        </div>
                        <div id="manage-snippet-body-${cat.id}" class="${manageSnippetsOpenState[cat.id] ? '' : 'hidden'} pl-8 pr-0 pb-2">
                            ${snippetList}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleManageSnippetCategory(catId) {
            const body = document.getElementById(`manage-snippet-body-${catId}`);
            const icon = document.getElementById(`manage-snippet-icon-${catId}`);
            if (!body) return;

            manageSnippetsOpenState[catId] = !manageSnippetsOpenState[catId];
            body.classList.toggle('hidden', !manageSnippetsOpenState[catId]);
            if (icon) icon.classList.toggle('rotate-180', manageSnippetsOpenState[catId]);
        }

        async function refreshManageSnippetCategory(catId) {
            const cat = SNIPPET_CATEGORIES.find(c => c.id === catId);
            if (!cat || !window.db || !window.db.getSnippets) return;
            const rows = await window.db.getSnippets({ mode: cat.mode, fieldId: cat.id });
            const list = Array.isArray(rows) ? rows : [];
            manageSnippetsCacheByCat[cat.id] = list;
            list.forEach(s => { manageSnippetCacheById[s.id] = s; });
        }

        function openManageSnippetMenu(ev, catId, snippetId) {
            const e = ev || window.event;
            if (e) {
                if (e.stopPropagation) e.stopPropagation();
                if (e.preventDefault) e.preventDefault();
                if (e.stopImmediatePropagation) e.stopImmediatePropagation();
            }
            const menu = document.getElementById('manage-snippet-menu');
            if (!menu) return false;

            if (snippetMenuOpen) closeSnippetItemMenu();
            if (promptMenuOpen) closePromptItemMenu();
            if (manageCategoryMenuOpen) closeManageCategoryMenu();
            if (settingsMenuOpen) closeSettingsMenu();
            if (manageSnippetMenuOpen) closeManageSnippetMenu();

            manageSnippetMenuSnippetId = snippetId;
            manageSnippetMenuCategoryId = catId;

            const submenu = document.getElementById('manage-snippet-target-submenu');
            if (submenu) submenu.classList.add('hidden');
            const list = document.getElementById('manage-snippet-target-submenu-list');
            if (list) list.innerHTML = '<div class="px-3 py-2 text-xs text-slate-500 italic">Lade…</div>';

            menu.classList.remove('hidden');
            const target = e && e.currentTarget ? e.currentTarget : null;
            const positionMenu = (attempt = 0) => {
                if (!target) return;
                const rect = target.getBoundingClientRect();
                const menuWidth = menu.offsetWidth;
                const menuHeight = menu.offsetHeight;
                if ((!menuWidth || !menuHeight) && attempt < 2) {
                    requestAnimationFrame(() => positionMenu(attempt + 1));
                    return;
                }
                if (!menuWidth || !menuHeight) return;

                let left = rect.right - menuWidth;
                let top = rect.bottom + 6;

                if (rect.bottom + menuHeight + 8 > window.innerHeight && rect.top - menuHeight - 6 >= 8) {
                    top = rect.top - menuHeight - 6;
                }

                const maxLeft = window.innerWidth - menuWidth - 8;
                const maxTop = window.innerHeight - menuHeight - 8;
                left = Math.min(Math.max(8, left), Math.max(8, maxLeft));
                top = Math.min(Math.max(8, top), Math.max(8, maxTop));

                menu.style.left = left + 'px';
                menu.style.top = top + 'px';
            };
            requestAnimationFrame(() => positionMenu());
            manageSnippetMenuOpen = true;
            menu.onclick = (evt) => evt.stopPropagation();
            return false;
        }

        function closeManageSnippetMenu() {
            const menu = document.getElementById('manage-snippet-menu');
            const submenu = document.getElementById('manage-snippet-target-submenu');
            if (menu) menu.classList.add('hidden');
            if (submenu) submenu.classList.add('hidden');
            manageSnippetMenuOpen = false;
            manageSnippetMenuSnippetId = null;
            manageSnippetMenuCategoryId = null;
        }

        function openManageSnippetTargetSubmenu() {
            const menu = document.getElementById('manage-snippet-target-submenu');
            const list = document.getElementById('manage-snippet-target-submenu-list');
            const trigger = document.getElementById('manage-snippet-target-trigger');
            if (!menu || !list || !trigger) return;

            const items = SNIPPET_CATEGORIES.map(cat => `
                <button class="w-full px-4 py-2 text-left text-sm text-slate-200 hover:bg-slate-800/60 truncate"
                        title=${JSON.stringify(cat.label)}
                        onclick="selectManageSnippetTarget(event, '${cat.id}')">
                    ${escapeHtml(cat.label)}
                </button>
            `);
            list.innerHTML = items.join('');

            menu.classList.remove('hidden');
            menu.onclick = (evt) => evt.stopPropagation();

            requestAnimationFrame(() => {
                const rect = trigger.getBoundingClientRect();
                const menuWidth = menu.offsetWidth;
                const menuHeight = menu.offsetHeight;

                let left = rect.right + 8;
                let top = rect.top;

                if (rect.top + menuHeight + 8 > window.innerHeight && rect.bottom - menuHeight >= 8) {
                    top = rect.bottom - menuHeight;
                }

                const maxLeft = window.innerWidth - menuWidth - 8;
                const maxTop = window.innerHeight - menuHeight - 8;
                left = Math.min(Math.max(8, left), Math.max(8, maxLeft));
                top = Math.min(Math.max(8, top), Math.max(8, maxTop));

                menu.style.left = left + 'px';
                menu.style.top = top + 'px';
            });
        }

        function handleManageSnippetEdit() {
            const id = manageSnippetMenuSnippetId;
            const categoryId = manageSnippetMenuCategoryId;
            const snippet = manageSnippetCacheById[id];
            closeManageSnippetMenu();
            if (!snippet) return;
            openSnippetModalForEdit(categoryId, snippet);
        }

        function handleManageSnippetDelete() {
            const categoryId = manageSnippetMenuCategoryId;
            const snippetId = manageSnippetMenuSnippetId;
            closeManageSnippetMenu();
            openDeleteSnippetModal(categoryId, snippetId);
        }

        async function selectManageSnippetTarget(ev, targetCatId) {
            try {
                const e = ev || window.event;
                if (e && e.stopPropagation) e.stopPropagation();
            } catch (_) {}

            const snippetId = manageSnippetMenuSnippetId;
            const oldCatId = manageSnippetMenuCategoryId;
            if (!snippetId) return;

            if (!window.db || !window.db.updateSnippet) {
                console.error('window.db.updateSnippet fehlt');
                return;
            }

            const patch = targetCatId === 'free'
                ? { mode: 'free', field_id: 'free' }
                : { mode: 'structured', field_id: targetCatId };

            try {
                const ok = await window.db.updateSnippet(snippetId, patch);
                if (!ok) {
                    alert('Baustein konnte nicht verschoben werden.');
                    return;
                }
            } catch (err) {
                console.error('Baustein Update Fehler:', err);
                alert('Baustein konnte nicht verschoben werden. Bitte Konsole prüfen.');
                return;
            }

            await refreshManageSnippetCategory(oldCatId);
            if (oldCatId !== targetCatId) await refreshManageSnippetCategory(targetCatId);

            renderManageSnippetsAccordion();
            closeManageSnippetMenu();

            if (oldCatId) {
                const oldBody = document.getElementById(`snip-body-${oldCatId}`);
                if (oldBody) oldBody.dataset.loaded = 'false';
                if (snippetOpenState[oldCatId]) await loadSnippetSection(oldCatId);
            }
            const newBody = document.getElementById(`snip-body-${targetCatId}`);
            if (newBody) newBody.dataset.loaded = 'false';
            if (snippetOpenState[targetCatId]) await loadSnippetSection(targetCatId);
        }
        function openManageCategoryMenu(ev, categoryId, categoryName) {
            const e = ev || window.event;
            if (e) {
                if (e.stopPropagation) e.stopPropagation();
                if (e.preventDefault) e.preventDefault();
                if (e.stopImmediatePropagation) e.stopImmediatePropagation();
            }
            const menu = document.getElementById('manage-category-menu');
            if (!menu) return false;

            if (snippetMenuOpen) closeSnippetItemMenu();
            if (promptMenuOpen) closePromptItemMenu();
            if (manageSnippetMenuOpen) closeManageSnippetMenu();
            if (savePromptCategoryMenuOpen) closeSavePromptCategoryMenu();
            if (settingsMenuOpen) closeSettingsMenu();

            manageCategoryMenuId = categoryId;
            manageCategoryMenuName = categoryName || '';

            menu.classList.remove('hidden');
            const target = e && e.currentTarget ? e.currentTarget : null;
            const positionMenu = (attempt = 0) => {
                if (!target) return;
                const rect = target.getBoundingClientRect();
                const menuWidth = menu.offsetWidth;
                const menuHeight = menu.offsetHeight;
                if ((!menuWidth || !menuHeight) && attempt < 2) {
                    requestAnimationFrame(() => positionMenu(attempt + 1));
                    return;
                }
                if (!menuWidth || !menuHeight) return;

                let left = rect.right - menuWidth;
                let top = rect.bottom + 6;

                if (rect.bottom + menuHeight + 8 > window.innerHeight && rect.top - menuHeight - 6 >= 8) {
                    top = rect.top - menuHeight - 6;
                }

                const maxLeft = window.innerWidth - menuWidth - 8;
                const maxTop = window.innerHeight - menuHeight - 8;
                left = Math.min(Math.max(8, left), Math.max(8, maxLeft));
                top = Math.min(Math.max(8, top), Math.max(8, maxTop));

                menu.style.left = left + 'px';
                menu.style.top = top + 'px';
            };
            requestAnimationFrame(() => positionMenu());
            manageCategoryMenuOpen = true;
            menu.onclick = (evt) => evt.stopPropagation();
            return false;
        }

        function closeManageCategoryMenu() {
            const menu = document.getElementById('manage-category-menu');
            if (menu) menu.classList.add('hidden');
            manageCategoryMenuOpen = false;
            manageCategoryMenuId = null;
            manageCategoryMenuName = '';
        }

        function handleManageCategoryRename() {
            const id = manageCategoryMenuId;
            const name = manageCategoryMenuName;
            closeManageCategoryMenu();
            openManageCategoryRenameModal(id, name);
        }

        function handleManageCategoryDelete() {
            const id = manageCategoryMenuId;
            const name = manageCategoryMenuName;
            closeManageCategoryMenu();
            openManageCategoryDeleteModal(id, name);
        }

        function openManageCategoryRenameModal(categoryId, categoryName) {
            pendingRenameCategoryId = categoryId;
            pendingRenameCategoryName = categoryName || '';
            const modal = document.getElementById('modal-category-rename');
            const input = document.getElementById('rename-category-name');
            if (input) input.value = pendingRenameCategoryName;
            if (modal) modal.classList.remove('hidden');
            setTimeout(() => { if (input) input.focus(); }, 50);
        }

        function closeRenameCategoryModal() {
            const modal = document.getElementById('modal-category-rename');
            if (modal) modal.classList.add('hidden');
            pendingRenameCategoryId = null;
            pendingRenameCategoryName = '';
        }

        async function confirmRenameCategory() {
            const id = pendingRenameCategoryId;
            const oldName = (pendingRenameCategoryName || '').trim();
            const input = document.getElementById('rename-category-name');
            const newName = (input?.value || '').trim();

            if (!id) {
                closeRenameCategoryModal();
                return;
            }

            if (!newName) {
                alert('Bitte einen Namen eingeben.');
                return;
            }

            if (normalizeCategoryName(newName).toLowerCase() === normalizeCategoryName(oldName).toLowerCase()) {
                closeRenameCategoryModal();
                return;
            }

            const exists = (manageCategoriesCache || []).some(c => {
                const n = normalizeCategoryName(c.name).toLowerCase();
                return n === normalizeCategoryName(newName).toLowerCase() && c.id !== id;
            });

            if (exists) {
                alert('Kategorie existiert bereits.');
                return;
            }

            if (!window.db || !window.db.renamePromptCategory) {
                console.error('window.db.renamePromptCategory fehlt');
                return;
            }

            const ok = await window.db.renamePromptCategory(id, oldName, newName);
            if (!ok) {
                alert('Kategorie konnte nicht umbenannt werden. Bitte Konsole prüfen.');
                return;
            }

            closeRenameCategoryModal();
            await refreshPromptLibraryAndCategories();
            await loadManageCategoriesPage();
        }

        function openManageCategoryDeleteModal(categoryId, categoryName) {
            pendingDeleteManageCategoryId = categoryId;
            pendingDeleteManageCategoryName = categoryName || '';
            const modal = document.getElementById('modal-category-delete');
            if (modal) modal.classList.remove('hidden');
        }

        function closeDeleteCategoryModal() {
            const modal = document.getElementById('modal-category-delete');
            if (modal) modal.classList.add('hidden');
            pendingDeleteManageCategoryId = null;
            pendingDeleteManageCategoryName = '';
        }

        async function confirmDeleteCategory() {
            const id = pendingDeleteManageCategoryId;
            const name = (pendingDeleteManageCategoryName || '').trim();

            if (!id) {
                closeDeleteCategoryModal();
                return;
            }

            if (!window.db || !window.db.deletePromptCategory) {
                console.error('window.db.deletePromptCategory fehlt');
                return;
            }

            const ok = await window.db.deletePromptCategory(id, name);
            if (!ok) {
                alert('Kategorie konnte nicht gelöscht werden. Bitte Konsole prüfen.');
                return;
            }

            closeDeleteCategoryModal();
            await refreshPromptLibraryAndCategories();
            await loadManageCategoriesPage();
        }

        function switchView(viewId) {
            ['view-editor', 'view-history', 'view-settings'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            
            // Reset Nav Styles
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('active-nav');
                btn.classList.remove('bg-gray-800/50', 'border-brand-sky', 'text-white');
                btn.classList.add('text-slate-500', 'border-transparent');
            });
            
            // Set Active Style
            const index = viewId === 'editor' ? 0 : viewId === 'history' ? 1 : 2;
            const activeBtn = document.querySelectorAll('.nav-item')[index];
            if(activeBtn) {
                activeBtn.classList.remove('text-slate-500', 'border-transparent');
                activeBtn.classList.add('active-nav');
            }
            const saveWrap = document.getElementById('footer-save-wrap');
            if (saveWrap) saveWrap.classList.toggle('hidden', viewId !== 'editor');

            if(viewId === 'history' && window.db) window.db.getHistory().then(renderHistoryList);
        }

        function setEditorMode(mode) {
            currentMode = mode;
            const btnStruct = document.getElementById('btn-mode-structured');
            const btnFree = document.getElementById('btn-mode-free');
            const divStruct = document.getElementById('editor-structured');
            const divFree = document.getElementById('editor-free');

            if (mode === 'structured') {
                btnStruct.classList.add('bg-brand-sky', 'text-navy-deep', 'shadow-glow');
                btnStruct.classList.remove('text-slate-500', 'hover:text-slate-300');
                btnFree.classList.remove('bg-brand-sky', 'text-navy-deep', 'shadow-glow');
                btnFree.classList.add('text-slate-500', 'hover:text-slate-300');
                divStruct.classList.remove('hidden');
                divFree.classList.add('hidden');
            } else {
                btnFree.classList.add('bg-brand-sky', 'text-navy-deep', 'shadow-glow');
                btnFree.classList.remove('text-slate-500', 'hover:text-slate-300');
                btnStruct.classList.remove('bg-brand-sky', 'text-navy-deep', 'shadow-glow');
                btnStruct.classList.add('text-slate-500', 'hover:text-slate-300');
                divFree.classList.remove('hidden');
                divStruct.classList.add('hidden');
                freeSetMarkdown(freeGetMarkdown());
            }
        }

        function getFreeEditorEl() {
            return document.getElementById('input-free-editor');
        }

        function freeGetMarkdown() {
            const ta = document.getElementById('input-free');
            return ta ? ta.value : '';
        }

        function freeSetMarkdown(md) {
            const ta = document.getElementById('input-free');
            const editor = getFreeEditorEl();
            const value = md || '';
            if (ta) ta.value = value;
            if (editor) editor.innerHTML = freeMarkdownToHtml(value);
            freeFormatActive = 'none';
            setFreeActiveButton('none');
        }

        function initFreeEditor() {
            const editor = getFreeEditorEl();
            if (!editor) return;
            editor.addEventListener('input', () => freeSyncHtmlToMarkdown());
            editor.addEventListener('keydown', (ev) => handleFreeEditorKeydown(ev));
            editor.addEventListener('blur', () => freeSyncHtmlToMarkdown());
            freeSetMarkdown(freeGetMarkdown());
        }

        function setFreeActiveButton(format) {
            const btns = {
                h1: document.getElementById('btn-free-h1'),
                h2: document.getElementById('btn-free-h2'),
                h3: document.getElementById('btn-free-h3'),
                bold: document.getElementById('btn-free-bold'),
                quote: document.getElementById('btn-free-quote'),
                ul: document.getElementById('btn-free-ul'),
                ol: document.getElementById('btn-free-ol')
            };

            Object.keys(btns).forEach(key => {
                const btn = btns[key];
                if (!btn) return;
                btn.classList.remove('bg-slate-800', 'text-white');
                btn.classList.add('text-slate-400', 'hover:text-white', 'hover:bg-slate-800');
            });

            if (format && format !== 'none' && btns[format]) {
                const btn = btns[format];
                btn.classList.add('bg-slate-800', 'text-white');
                btn.classList.remove('text-slate-400');
            }
        }

        function getClosestTag(node, tags) {
            let cur = node;
            while (cur) {
                if (cur.nodeType === 1 && tags.includes(cur.tagName)) return cur;
                cur = cur.parentNode;
            }
            return null;
        }

        function clearFreeFormattingContext() {
            const sel = window.getSelection();
            const anchor = sel && sel.anchorNode ? sel.anchorNode : null;
            const inUl = getClosestTag(anchor, ['UL']);
            const inOl = getClosestTag(anchor, ['OL']);
            const inBlock = getClosestTag(anchor, ['BLOCKQUOTE']);

            if (inUl) document.execCommand('insertUnorderedList');
            if (inOl) document.execCommand('insertOrderedList');
            if (inBlock) document.execCommand('formatBlock', false, 'P');
            document.execCommand('formatBlock', false, 'P');
            document.execCommand('removeFormat');
        }

        function toggleFreeFormat(format) {
            const editor = getFreeEditorEl();
            if (!editor) return;
            editor.focus();

            if (freeFormatActive === format) {
                clearFreeFormattingContext();
                freeFormatActive = 'none';
                setFreeActiveButton('none');
                freeSyncHtmlToMarkdown();
                return;
            }

            clearFreeFormattingContext();

            if (format === 'h1') document.execCommand('formatBlock', false, 'H1');
            if (format === 'h2') document.execCommand('formatBlock', false, 'H2');
            if (format === 'h3') document.execCommand('formatBlock', false, 'H3');
            if (format === 'quote') document.execCommand('formatBlock', false, 'BLOCKQUOTE');
            if (format === 'ul') document.execCommand('insertUnorderedList');
            if (format === 'ol') document.execCommand('insertOrderedList');
            if (format === 'bold') document.execCommand('bold');

            freeFormatActive = format;
            setFreeActiveButton(format);
            freeSyncHtmlToMarkdown();
        }

        function handleFreeEditorKeydown(ev) {
            if (ev.key !== 'Enter') return;
            const sel = window.getSelection();
            const anchor = sel && sel.anchorNode ? sel.anchorNode : null;
            const li = getClosestTag(anchor, ['LI']);
            if (!li) return;
            const list = getClosestTag(li, ['UL', 'OL']);
            if (!list) return;
            if (li.textContent.trim() === '') {
                ev.preventDefault();
                if (list.tagName === 'UL') document.execCommand('insertUnorderedList');
                if (list.tagName === 'OL') document.execCommand('insertOrderedList');
                document.execCommand('formatBlock', false, 'P');
                freeFormatActive = 'none';
                setFreeActiveButton('none');
                freeSyncHtmlToMarkdown();
            }
        }

        function freeSyncHtmlToMarkdown() {
            const editor = getFreeEditorEl();
            const ta = document.getElementById('input-free');
            if (!editor || !ta) return;
            const md = freeHtmlToMarkdown(editor);
            ta.value = md.trim();
        }

        function freeHtmlToMarkdown(root) {
            const blockTags = ['H1','H2','H3','P','DIV','BLOCKQUOTE','UL','OL'];

            const inlineToMd = (node) => {
                if (node.nodeType === 3) return node.nodeValue;
                if (node.nodeType !== 1) return '';
                const tag = node.tagName;
                if (tag === 'BR') return '\n';
                const inner = Array.from(node.childNodes).map(inlineToMd).join('');
                if (tag === 'STRONG' || tag === 'B') return `**${inner}**`;
                return inner;
            };

            const blockToMd = (node) => {
                if (node.nodeType === 3) {
                    const text = node.nodeValue || '';
                    return text.trim() ? text + '\n\n' : '';
                }
                if (node.nodeType !== 1) return '';
                const tag = node.tagName;
                if (tag === 'H1') return `# ${inlineToMd(node).trim()}\n\n`;
                if (tag === 'H2') return `## ${inlineToMd(node).trim()}\n\n`;
                if (tag === 'H3') return `### ${inlineToMd(node).trim()}\n\n`;
                if (tag === 'BLOCKQUOTE') {
                    const text = inlineToMd(node).trim();
                    const lines = text ? text.split('\n') : [''];
                    return lines.map(l => `> ${l}`.trimEnd()).join('\n') + '\n\n';
                }
                if (tag === 'UL') {
                    const items = Array.from(node.children).filter(c => c.tagName === 'LI');
                    const rows = items.map(li => `- ${inlineToMd(li).trim()}`);
                    return rows.join('\n') + '\n\n';
                }
                if (tag === 'OL') {
                    const items = Array.from(node.children).filter(c => c.tagName === 'LI');
                    const rows = items.map((li, idx) => `${idx + 1}. ${inlineToMd(li).trim()}`);
                    return rows.join('\n') + '\n\n';
                }
                if (tag === 'P' || tag === 'DIV') {
                    const text = inlineToMd(node).trim();
                    if (!text) return '';
                    return text + '\n\n';
                }
                if (blockTags.includes(tag)) return inlineToMd(node).trim() + '\n\n';
                return inlineToMd(node).trim();
            };

            let out = '';
            root.childNodes.forEach(node => {
                out += blockToMd(node);
            });
            return out.trimEnd();
        }

        function freeMarkdownToHtml(md) {
            const lines = (md || '').replace(/\r\n/g, '\n').split('\n');
            const blocks = [];
            let i = 0;

            const parseInline = (text) => {
                const safe = escapeHtml(text);
                return safe.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            };

            while (i < lines.length) {
                const line = lines[i];
                if (!line.trim()) {
                    i += 1;
                    continue;
                }
                if (/^#{1,3}\s+/.test(line)) {
                    const level = line.match(/^#{1,3}/)[0].length;
                    const content = line.replace(/^#{1,3}\s+/, '');
                    blocks.push(`<h${level}>${parseInline(content)}</h${level}>`);
                    i += 1;
                    continue;
                }
                if (/^>\s?/.test(line)) {
                    const buf = [];
                    while (i < lines.length && /^>\s?/.test(lines[i])) {
                        buf.push(lines[i].replace(/^>\s?/, ''));
                        i += 1;
                    }
                    const content = parseInline(buf.join('\n')).replace(/\n/g, '<br>');
                    blocks.push(`<blockquote>${content}</blockquote>`);
                    continue;
                }
                if (/^-\s+/.test(line)) {
                    const items = [];
                    while (i < lines.length && /^-\s+/.test(lines[i])) {
                        items.push(lines[i].replace(/^-+\s+/, ''));
                        i += 1;
                    }
                    blocks.push(`<ul>${items.map(it => `<li>${parseInline(it)}</li>`).join('')}</ul>`);
                    continue;
                }
                if (/^\d+\.\s+/.test(line)) {
                    const items = [];
                    while (i < lines.length && /^\d+\.\s+/.test(lines[i])) {
                        items.push(lines[i].replace(/^\d+\.\s+/, ''));
                        i += 1;
                    }
                    blocks.push(`<ol>${items.map(it => `<li>${parseInline(it)}</li>`).join('')}</ol>`);
                    continue;
                }
                const para = [];
                while (i < lines.length && lines[i].trim() && !/^#{1,3}\s+/.test(lines[i]) && !/^>\s?/.test(lines[i]) && !/^-\s+/.test(lines[i]) && !/^\d+\.\s+/.test(lines[i])) {
                    para.push(lines[i]);
                    i += 1;
                }
                const content = parseInline(para.join('\n')).replace(/\n/g, '<br>');
                blocks.push(`<p>${content}</p>`);
            }

            return blocks.join('');
        }

        function insertMarkdown(syntax) {
            const textarea = document.getElementById('input-free');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + syntax + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + syntax.length;
            textarea.focus();
        }

        async function handleCopyAndSave() {
            let finalText = "";
            if (currentMode === 'structured') {
                const headerMap = { 'role': '🎭 ROLLE', 'context': '🌍 KONTEXT', 'task': '🎯 AUFGABE', 'style': '🎨 STIL', 'format': '🧪 VARIANTEN' };
                FIELDS.forEach(f => {
                    const val = document.getElementById(`input-${f.id}`).value.trim();
                    if (val) finalText += `**${headerMap[f.id]}**\n${val}\n\n`;
                });
            } else {
                freeSyncHtmlToMarkdown();
                finalText = freeGetMarkdown().trim();
            }

            if (!finalText) {
                alert("Bitte gib erst etwas ein!");
                return;
            }

            try {
                await navigator.clipboard.writeText(finalText);
                if (window.db && window.db.savePrompt) {
                    await window.db.savePrompt({
                        text: finalText,
                        title: "Auto-Save",
                        mode: currentMode,
                        timestamp: new Date().toISOString()
                    });
                }
                const btn = document.getElementById('btn-copy');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> <span>COPIED!</span>';
                btn.classList.replace('bg-brand-sky', 'bg-green-500');
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.replace('bg-green-500', 'bg-brand-sky');
                }, 2000);
            } catch (err) {
                console.error('Copy failed', err);
            }
        }

        function openResetModal() {
            document.getElementById('modal-reset').classList.remove('hidden');
        }

        function closeResetModal() {
            document.getElementById('modal-reset').classList.add('hidden');
        }

        function confirmReset() {
            closeResetModal();
            resetFields();
        }

        function resetCurrentView() {
            openResetModal();
        }

        function resetFields() {
            if(currentMode === 'structured') {
                FIELDS.forEach(f => document.getElementById(`input-${f.id}`).value = '');
            } else {
                freeSetMarkdown('');
            }
        }

        async function loadLibrary() {
            if(!window.db) return;
            promptLibraryCache = await window.db.getScenarios();
            promptCategoriesCache = window.db.getPromptCategories ? await window.db.getPromptCategories() : [];
            renderPromptsAccordion();
        }

        async function refreshPromptLibraryAndCategories() {
            if (!window.db) return;
            promptLibraryCache = await window.db.getScenarios();
            promptCategoriesCache = window.db.getPromptCategories ? await window.db.getPromptCategories() : [];
            renderPromptsAccordion();

            if (promptMenuOpen) {
                const sub = document.getElementById('prompt-category-submenu');
                if (sub && !sub.classList.contains('hidden')) {
                    await openPromptCategorySubmenu();
                }
            }

            if (isSavePromptModalOpen()) {
                await refreshSavePromptCategoryMenu();
            }
        }

        function loadScenario(id) {
            window.db.getScenarios().then(scenarios => {
                const s = scenarios.find(x => x.id == id);
                if (!s) return;

                if (Array.isArray(s.fields)) {
                    setEditorMode('structured');
                    s.fields.forEach((val, index) => { 
                        if (FIELDS[index]) document.getElementById(`input-${FIELDS[index].id}`).value = val;
                    });
                    return;
                }

                if (!s.fields || typeof s.fields !== 'object') return;

                if (s.fields.mode === 'free') {
                    setEditorMode('free');
                    freeSetMarkdown(s.fields.text || '');
                    setActiveField('free');
                    return;
                }

                if (s.fields.mode === 'structured') {
                    setEditorMode('structured');
                    if (Array.isArray(s.fields.fields)) {
                        s.fields.fields.forEach((val, index) => { 
                            if (FIELDS[index]) document.getElementById(`input-${FIELDS[index].id}`).value = val;
                        });
                        return;
                    }
                    if (s.fields.fields && typeof s.fields.fields === 'object') {
                        FIELDS.forEach(f => {
                            if (s.fields.fields[f.id] !== undefined) {
                                document.getElementById(`input-${f.id}`).value = s.fields.fields[f.id];
                            }
                        });
                    }
                }
            });
        }

        function isFreePrompt(s) {
            if (!s || !s.fields) return false;
            if (typeof s.fields === 'object' && s.fields.mode === 'free') return true;
            if (typeof s.fields === 'object' && typeof s.fields.text === 'string') return true;
            return false;
        }

        function extractStructuredFields(s) {
            const out = { role:'', context:'', task:'', style:'', format:'' };

            if (Array.isArray(s.fields)) {
                s.fields.forEach((val, idx) => {
                    if (FIELDS[idx]) out[FIELDS[idx].id] = val ?? '';
                });
                return out;
            }

            if (!s.fields || typeof s.fields !== 'object') return out;

            if (s.fields.mode === 'structured') {
                if (Array.isArray(s.fields.fields)) {
                    s.fields.fields.forEach((val, idx) => {
                        if (FIELDS[idx]) out[FIELDS[idx].id] = val ?? '';
                    });
                    return out;
                }
                if (s.fields.fields && typeof s.fields.fields === 'object') {
                    FIELDS.forEach(f => {
                        if (s.fields.fields[f.id] !== undefined) out[f.id] = s.fields.fields[f.id] ?? '';
                    });
                    return out;
                }
            }

            return out;
        }

        function applyStructuredToEditor(s) {
            const data = extractStructuredFields(s);
            FIELDS.forEach(f => {
                const el = document.getElementById(`input-${f.id}`);
                if (el) el.value = data[f.id] ?? '';
            });
        }

        function structuredPromptToText(s) {
            const headerMap = { role:'ðŸŽ­ ROLLE', context:'ðŸŒ KONTEXT', task:'ðŸŽ¯ AUFGABE', style:'ðŸŽ¨ STIL', format:'ðŸ§ª VARIANTEN' };
            const data = extractStructuredFields(s);
            let finalText = '';
            FIELDS.forEach(f => {
                const val = (data[f.id] ?? '').toString().trim();
                if (val) finalText += `**${headerMap[f.id]}**\n${val}\n\n`;
            });
            return finalText.trim();
        }

        async function handlePromptClick(id) {
            let scenarios = [];
            if (Array.isArray(promptLibraryCache) && promptLibraryCache.length) {
                scenarios = promptLibraryCache;
            } else {
                scenarios = await window.db.getScenarios();
                promptLibraryCache = scenarios;
            }

            const s = scenarios.find(x => x.id == id);
            if (!s) return;

            const freePrompt = isFreePrompt(s);

            if (currentMode === 'structured') {
                if (!freePrompt) {
                    applyStructuredToEditor(s);
                    return;
                }
                setEditorMode('free');
                freeSetMarkdown(s.fields.text || '');
                setActiveField('free');
                return;
            }

            if (freePrompt) {
                freeSetMarkdown(s.fields.text || '');
                setActiveField('free');
                return;
            }

            freeSetMarkdown(structuredPromptToText(s));
            setActiveField('free');
        }

        function loadSnippetsForFieldDemo(fieldId) {
            const container = document.getElementById('library-snippets');
            const fieldLabel = FIELDS.find(f => f.id === fieldId)?.label || 'Feld';
            container.innerHTML = `
                <div class="text-[10px] text-brand-sky font-bold mb-1 uppercase tracking-wider opacity-70">Passend für: ${fieldLabel}</div>
                <div class="group flex items-center p-2 rounded hover:bg-slate-800/50 cursor-pointer transition-colors" onclick="insertSnippet('${fieldId}', 'Beispiel Textbaustein')">
                    <div class="text-sm text-slate-300 group-hover:text-white truncate">Beispiel Baustein</div>
                </div>
            `;
        }

        function insertSnippet(fieldId, text) {
            insertSnippetText(text, fieldId);
        }

        function insertSnippetText(text, targetFieldId = null) {
            if (currentMode === 'free') {
                const editor = getFreeEditorEl();
                if (!editor) { alert('Freies Textfeld nicht gefunden.'); return; }
                editor.focus();
                document.execCommand('insertText', false, text);
                freeSyncHtmlToMarkdown();
                return;
            }

            let target = targetFieldId;

            if (target === 'free') {
                target = (activeFieldId && activeFieldId !== 'free') ? activeFieldId : 'context';
            }

            if (!target) {
                target = (activeFieldId && activeFieldId !== 'free') ? activeFieldId : 'context';
            }

            const ta = document.getElementById(`input-${target}`);
            if (!ta) { alert('Zielfeld nicht gefunden: ' + target); return; }
            ta.focus();
            const start = (ta.selectionStart ?? ta.value.length);
            const end = (ta.selectionEnd ?? ta.value.length);
            ta.value = ta.value.slice(0, start) + text + ta.value.slice(end);
            const pos = start + text.length;
            ta.setSelectionRange(pos, pos);
        }

        async function loadSnippetsForField(fieldId) {
            const container = document.getElementById('library-snippets');
            activeFieldId = fieldId;

            if (!isLeftOpen) toggleSidebar('left');

            if (currentMode === 'structured' && (!fieldId || fieldId === 'free')) {
                container.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Wähle ein Feld im Editor.</div>';
                return;
            }

            if (!window.db || !window.db.getSnippets) {
                container.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Keine Bausteine.</div>';
                return;
            }

            const snippets = await window.db.getSnippets({ mode: currentMode, fieldId: activeFieldId });
            const fieldLabel = FIELDS.find(f => f.id === fieldId)?.label || 'Feld';
            const headerLabel = currentMode === 'free' ? 'Bausteine (Frei)' : `Passend für: ${fieldLabel}`;

            if (!snippets || snippets.length === 0) {
                container.innerHTML = `
                    <div class="text-[10px] text-brand-sky font-bold mb-1 uppercase tracking-wider opacity-70">${headerLabel}</div>
                    <div class="text-xs text-slate-600 italic py-2">Keine Bausteine.</div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="text-[10px] text-brand-sky font-bold mb-1 uppercase tracking-wider opacity-70">${headerLabel}</div>
                ${snippets.map(snippet => `
                    <div class="group flex items-center p-2 rounded hover:bg-slate-800/50 cursor-pointer transition-colors" onclick='insertSnippetText(${JSON.stringify(snippet.content)}, ${JSON.stringify(fieldId)})'>
                        <div class="text-sm text-slate-300 group-hover:text-white truncate">${snippet.name}</div>
                    </div>
                `).join('')}
            `;
        }

        function setActiveField(fieldId) {
            activeFieldId = fieldId;
        }

        function normalizeCategoryName(v) {
            return (v || '').trim();
        }

        function categoryKeyFromName(name) {
            const normalized = normalizeCategoryName(name);
            if (!normalized) return '__uncat__';
            return 'cat_' + encodeURIComponent(normalized).replace(/%/g, '_');
        }

        function buildPromptCategoryMeta() {
            const meta = [];
            const seen = {};
            promptCategoryKeyToName = {};

            const addCategory = (name, labelOverride = null) => {
                const normalized = normalizeCategoryName(name);
                const key = categoryKeyFromName(normalized);
                if (seen[key]) return;
                seen[key] = true;
                const label = labelOverride !== null ? labelOverride : normalized;
                meta.push({ key, name: normalized, label });
                promptCategoryKeyToName[key] = normalized;
                if (promptOpenState[key] === undefined) promptOpenState[key] = false;
            };

            addCategory('', 'Ohne Kategorie');
            (promptCategoriesCache || []).forEach(c => addCategory(c.name));
            (promptLibraryCache || []).forEach(s => {
                const name = normalizeCategoryName(s.category);
                if (name) addCategory(name);
            });

            return meta;
        }

        function renderPromptsAccordion() {
            const container = document.getElementById('library-scenarios');
            if (!container) return;

            const meta = buildPromptCategoryMeta();
            container.innerHTML = meta.map(cat => `
                <div>
                    <button class="group w-full flex items-center justify-between p-2 text-left hover:bg-slate-800/50 rounded" onclick="togglePromptCategory('${cat.key}')">
                        <div class="flex items-center gap-2 min-w-0">
                            <i class="fa-regular fa-folder text-sm text-slate-400 group-hover:text-slate-200 transition-colors"></i>
                            <span class="truncate text-sm font-bold text-slate-300">${cat.label}</span>
                        </div>
                        <i id="prompt-icon-${cat.key}" class="fa-solid fa-chevron-down text-xs transition-transform ${promptOpenState[cat.key] ? 'rotate-180' : ''}"></i>
                    </button>
                    <div id="prompt-body-${cat.key}" class="${promptOpenState[cat.key] ? '' : 'hidden'} pl-2 pr-0 pb-2" data-loaded="false">
                        <div class="text-xs text-slate-600 italic py-2">Noch nicht geladen.</div>
                    </div>
                </div>
            `).join('');
        }

        async function togglePromptCategory(catKey) {
            const body = document.getElementById(`prompt-body-${catKey}`);
            const icon = document.getElementById(`prompt-icon-${catKey}`);
            if (!body) return;

            promptOpenState[catKey] = !promptOpenState[catKey];
            if (promptOpenState[catKey]) {
                body.classList.remove('hidden');
                if (icon) icon.classList.add('rotate-180');
                if (body.dataset.loaded !== 'true') {
                    await loadPromptCategory(catKey);
                }
            } else {
                body.classList.add('hidden');
                if (icon) icon.classList.remove('rotate-180');
            }
        }

        async function loadPromptCategory(catKey) {
            const body = document.getElementById(`prompt-body-${catKey}`);
            if (!body) return;

            body.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Lade...</div>';

            if (!window.currentUser) {
                body.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Bitte einloggen, um Prompts zu sehen.</div>';
                body.dataset.loaded = 'false';
                return;
            }

            const categoryName = promptCategoryKeyToName[catKey] || '';
            const prompts = promptLibraryCache || [];
            const filtered = prompts.filter(s => {
                const normalized = normalizeCategoryName(s.category);
                if (catKey === '__uncat__' || !categoryName) {
                    return !normalized;
                }
                return normalized === categoryName;
            });

            if (!filtered.length) {
                body.innerHTML = '<div class="text-xs text-slate-600 italic py-2 pl-1">Keine Prompts.</div>';
                body.dataset.loaded = 'true';
                return;
            }

            body.innerHTML = `
                <div class="space-y-0.5">
                    ${filtered.map(s => `
                        <div id="prompt-item-${s.id}" class="group w-full py-1 px-2 rounded hover:bg-slate-800/50 cursor-pointer transition-colors" onclick="handlePromptClick(${s.id})">
                            <div class="flex items-center justify-between w-full">
                                <div class="text-sm text-slate-300 group-hover:text-white truncate leading-tight min-w-0 flex-1" title=${JSON.stringify(s.name || '')}>${s.name}</div>
                                <button class="p-1 rounded hover:bg-slate-800 text-slate-400 hover:text-white leading-none flex-none" onclick="openPromptItemMenu(event, '${catKey}', ${s.id})">
                                    <i class="fa-solid fa-ellipsis"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            body.dataset.loaded = 'true';
        }

        function openPromptItemMenu(ev, catKey, promptId) {
            ev.stopPropagation();
            const menu = document.getElementById('prompt-item-menu');
            if (!menu) return;

            promptMenuPromptId = promptId;
            promptMenuCategoryKey = catKey;

            menu.classList.remove('hidden');
            const sub = document.getElementById('prompt-category-submenu');
            if (sub) sub.classList.add('hidden');
            const list = document.getElementById('prompt-category-submenu-list');
            if (list) list.innerHTML = '<div class="px-3 py-2 text-xs text-slate-500 italic">Lade…</div>';
            const r = ev.currentTarget.getBoundingClientRect();
            menu.style.top = (r.bottom + 6) + 'px';
            menu.style.left = (r.right - menu.offsetWidth) + 'px';
            if (menu.offsetWidth === 0) {
                menu.classList.remove('hidden');
                menu.style.left = (r.right - menu.offsetWidth) + 'px';
            }
            promptMenuOpen = true;
            menu.onclick = (e) => e.stopPropagation();
        }

        function closePromptItemMenu() {
            const menu = document.getElementById('prompt-item-menu');
            if (menu) menu.classList.add('hidden');
            const sub = document.getElementById('prompt-category-submenu');
            if (sub) sub.classList.add('hidden');
            const list = document.getElementById('prompt-category-submenu-list');
            if (list) list.innerHTML = '<div class="px-3 py-2 text-xs text-slate-500 italic">Lade…</div>';
            promptMenuOpen = false;
            promptMenuPromptId = null;
            promptMenuCategoryKey = null;
        }

        function handleEditPrompt() {
            const id = promptMenuPromptId;
            closePromptItemMenu();
            openPromptEditModal(id);
        }

        function handlePromptCategoryPlaceholder() {
            closePromptItemMenu();
            alert('Kategorie-Funktion folgt im nÃ¤chsten Schritt.');
        }

        function handleAskDeletePrompt() {
            const catKey = promptMenuCategoryKey;
            const id = promptMenuPromptId;
            closePromptItemMenu();
            openDeletePromptModal(catKey, id);
        }

        function openDeletePromptModal(catKey, promptId) {
            pendingDeletePromptCategoryKey = catKey;
            pendingDeletePromptId = promptId;
            const modal = document.getElementById('modal-prompt-delete');
            if (modal) modal.classList.remove('hidden');
        }

        function closeDeletePromptModal() {
            const modal = document.getElementById('modal-prompt-delete');
            if (modal) modal.classList.add('hidden');
            pendingDeletePromptCategoryKey = null;
            pendingDeletePromptId = null;
        }

        async function confirmDeletePrompt() {
            const id = pendingDeletePromptId;
            const catKey = pendingDeletePromptCategoryKey;

            if (!id || !window.db || !window.db.deleteScenario) {
                closeDeletePromptModal();
                return;
            }

            await window.db.deleteScenario(id);

            const el = document.getElementById(`prompt-item-${id}`);
            if (el) el.remove();

            if (Array.isArray(promptLibraryCache)) {
                promptLibraryCache = promptLibraryCache.filter(p => p.id != id);
            }

            closeDeletePromptModal();

            if (catKey) {
                await loadPromptCategory(catKey);
            }
        }

        function openPromptEditModal(id) {
            const modal = document.getElementById('modal-prompt-edit');
            if (modal) modal.classList.remove('hidden');
        }

        function closePromptEditModal() {
            const modal = document.getElementById('modal-prompt-edit');
            if (modal) modal.classList.add('hidden');
        }

        function openPromptCategoryModal(prefill = '') {
            if (!window.currentUser) {
                alert('Bitte einloggen.');
                openAuthModal();
                return;
            }
            const modal = document.getElementById('modal-prompt-category');
            const inp = document.getElementById('prompt-category-name');
            if (inp) inp.value = prefill || '';
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.zIndex = '140';
            }
            setTimeout(() => { if (inp) inp.focus(); }, 50);
        }

        function closePromptCategoryModal() {
            const modal = document.getElementById('modal-prompt-category');
            if (modal) modal.classList.add('hidden');
        }

        async function savePromptCategoryFromModal() {
            const inp = document.getElementById('prompt-category-name');
            const name = (inp?.value || '').trim();
            if (!name) {
                alert('Bitte einen Namen eingeben.');
                return;
            }
            const ok = await window.db.createPromptCategory(name);
            if (!ok) {
                alert('Fehler beim Speichern.');
                return;
            }
            await refreshPromptLibraryAndCategories();
            if (isSavePromptModalOpen()) {
                setSavePromptCategory(name);
            }
            closePromptCategoryModal();
        }

        async function openPromptCategorySubmenu() {
            const menu = document.getElementById('prompt-category-submenu');
            const list = document.getElementById('prompt-category-submenu-list');
            if (!menu || !list) return;

            menu.classList.remove('hidden');

            const names1 = (promptCategoriesCache || [])
                .map(x => (typeof x === 'string' ? x : x.name))
                .filter(Boolean)
                .map(s => s.trim())
                .filter(Boolean);
            const names2 = Array.isArray(promptLibraryCache)
                ? [...new Set(promptLibraryCache.map(p => (p.category || '').trim()).filter(Boolean))]
                : [];

            const all = [...new Set([...names1, ...names2])].sort((a, b) => a.localeCompare(b, 'de'));

            const items = [];
            items.push(`
                <button class="w-full px-4 py-2 text-left text-sm text-slate-200 hover:bg-slate-800/60 truncate"
                        onclick="selectPromptCategory(event, '')">
                    Ohne Kategorie
                </button>
            `);

            if (!all.length) {
                items.push('<div class="px-3 py-2 text-xs text-slate-500 italic">Keine Kategorien.</div>');
                list.innerHTML = items.join('');
                return;
            }

            items.push(all.map(n => `
                <button class="w-full px-4 py-2 text-left text-sm text-slate-200 hover:bg-slate-800/60 truncate"
                        title=${JSON.stringify(n)}
                        onclick='selectPromptCategory(event, ${JSON.stringify(n)})'>
                    ${escapeHtml(n)}
                </button>
            `).join(''));

            list.innerHTML = items.join('');
        }

        function handlePromptCategoryCreateFromMenu(ev) {
            ev.stopPropagation();
            closePromptItemMenu();
            openPromptCategoryModal();
        }

                        async function selectPromptCategory(ev, categoryName) {
            try {
                const e = ev || window.event;
                if (e && e.stopPropagation) e.stopPropagation();
            } catch (_) {}

            const id = promptMenuPromptId;
            const oldKey = promptMenuCategoryKey;
            if (!id) return;

            if (!window.db || !window.db.updateScenario) {
                console.error('window.db.updateScenario fehlt');
                return;
            }

            const normalized = (categoryName || '').trim();
            const catVal = normalized ? normalized : null;
            const newKey = categoryKeyFromName(catVal || '');

            try {
                console.log('move prompt', id, 'to category', catVal);
                const ok = await window.db.updateScenario(id, { category: catVal });
                if (!ok) {
                    console.error('Kategorie konnte nicht gespeichert werden.');
                    alert('Kategorie konnte nicht gespeichert werden. Bitte Konsole prüfen.');
                    return;
                }
            } catch (err) {
                console.error('Kategorie Update Fehler:', err);
                alert('Kategorie konnte nicht gespeichert werden. Bitte Konsole prüfen.');
                return;
            }

            if (oldKey) promptOpenState[oldKey] = true;
            promptOpenState[newKey] = true;

            promptLibraryCache = await window.db.getScenarios();
            renderPromptsAccordion();

            if (settingsCurrentPage === 'categories') {
                managePromptsCache = promptLibraryCache;
                manageCategoriesCache = window.db.getPromptCategories ? await window.db.getPromptCategories() : manageCategoriesCache;

                const oldName = oldKey ? (promptCategoryKeyToName[oldKey] || '') : '';
                const oldManageKey = manageCategoryStateKey(oldName);
                const newManageKey = manageCategoryStateKey(catVal || '');
                manageCategoryOpenState[oldManageKey] = true;
                manageCategoryOpenState[newManageKey] = true;

                renderManageCategoriesAccordion();
            }

            const oldBody = oldKey ? document.getElementById(`prompt-body-${oldKey}`) : null;
            const newBody = document.getElementById(`prompt-body-${newKey}`);
            if (oldBody) oldBody.dataset.loaded = 'false';
            if (newBody) newBody.dataset.loaded = 'false';

            closePromptItemMenu();

            if (oldKey && oldKey !== newKey) await loadPromptCategory(oldKey);
            await loadPromptCategory(newKey);
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderSnippetsAccordion() {
            const container = document.getElementById('library-snippets');
            if (!container) return;

            container.innerHTML = SNIPPET_CATEGORIES.map(cat => `
                <div>
                    <button class="group w-full flex items-center justify-between p-2 text-left hover:bg-slate-800/50 rounded" onclick="toggleSnippetSection('${cat.id}')">
                        <div class="flex items-center gap-2 min-w-0">
                            <i class="fa-regular fa-folder text-sm text-slate-400 group-hover:text-slate-200 transition-colors"></i>
                            <span class="truncate text-sm font-bold text-slate-300">${cat.label}</span>
                        </div>
                        <i id="snip-icon-${cat.id}" class="fa-solid fa-chevron-down text-xs transition-transform ${snippetOpenState[cat.id] ? 'rotate-180' : ''}"></i>
                    </button>
                    <div id="snip-body-${cat.id}" class="${snippetOpenState[cat.id] ? '' : 'hidden'} pl-2 pr-0 pb-2" data-loaded="false">
                        <div class="text-xs text-slate-600 italic py-2">Noch nicht geladen.</div>
                    </div>
                </div>
            `).join('');
        }

        async function toggleSnippetSection(catId) {
            const body = document.getElementById(`snip-body-${catId}`);
            const icon = document.getElementById(`snip-icon-${catId}`);
            if (!body) return;

            snippetOpenState[catId] = !snippetOpenState[catId];
            if (snippetOpenState[catId]) {
                body.classList.remove('hidden');
                if (icon) icon.classList.add('rotate-180');
                if (body.dataset.loaded !== 'true') {
                    await loadSnippetSection(catId);
                }
            } else {
                body.classList.add('hidden');
                if (icon) icon.classList.remove('rotate-180');
            }
        }

        async function loadSnippetSection(catId) {
            const body = document.getElementById(`snip-body-${catId}`);
            if (!body) return;

            body.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Lade...</div>';

            if (!window.currentUser) {
                body.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Bitte einloggen, um Bausteine zu sehen.</div>';
                body.dataset.loaded = 'false';
                return;
            }

            const cat = SNIPPET_CATEGORIES.find(c => c.id === catId);
            if (!cat || !window.db || !window.db.getSnippets) {
                body.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Keine Bausteine.</div>';
                body.dataset.loaded = 'true';
                return;
            }

            const snippets = await window.db.getSnippets({ mode: cat.mode, fieldId: cat.id });
            if (!snippets || snippets.length === 0) {
                body.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Keine Bausteine.</div>';
                body.dataset.loaded = 'true';
                return;
            }

            body.innerHTML = `
                <div class="space-y-0.5">
                    ${snippets.map(snippet => {
                        snippetCacheById[snippet.id] = snippet;
                        const encoded = encodeURIComponent(snippet.content || '');
                        return `
                            <div id="snippet-item-${snippet.id}" class="group w-full py-1 px-2 rounded hover:bg-slate-800/50 cursor-pointer transition-colors" onclick="insertSnippetEncoded('${encoded}','${cat.id}')">
                                <div class="flex items-center justify-between w-full">
                                    <div class="text-sm text-slate-300 group-hover:text-white truncate leading-tight min-w-0 flex-1" title=${JSON.stringify(snippet.name || '')}>${snippet.name}</div>
                                    <button class="p-1 rounded hover:bg-slate-800 text-slate-400 hover:text-white leading-none flex-none" onclick="openSnippetItemMenu(event, '${cat.id}', ${snippet.id})">
                                        <i class="fa-solid fa-ellipsis"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            body.dataset.loaded = 'true';
        }

        function insertSnippetEncoded(encoded, targetFieldId) {
            const text = decodeURIComponent(encoded || '');
            insertSnippetText(text, targetFieldId);
        }

        function openSnippetItemMenu(ev, categoryId, snippetId) {
            ev.stopPropagation();
            const menu = document.getElementById('snippet-item-menu');
            if (!menu) return;

            snippetMenuSnippetId = snippetId;
            snippetMenuCategoryId = categoryId;

            menu.classList.remove('hidden');
            const r = ev.currentTarget.getBoundingClientRect();
            menu.style.top = (r.bottom + 6) + 'px';
            menu.style.left = (r.right - menu.offsetWidth) + 'px';
            if (menu.offsetWidth === 0) {
                menu.classList.remove('hidden');
                menu.style.left = (r.right - menu.offsetWidth) + 'px';
            }
            snippetMenuOpen = true;
            menu.onclick = (e) => e.stopPropagation();
        }

        function closeSnippetItemMenu() {
            const menu = document.getElementById('snippet-item-menu');
            if (menu) menu.classList.add('hidden');
            snippetMenuOpen = false;
            snippetMenuSnippetId = null;
            snippetMenuCategoryId = null;
        }

        function handleEditSnippet() {
            const snippet = snippetCacheById[snippetMenuSnippetId];
            const categoryId = snippetMenuCategoryId;
            closeSnippetItemMenu();
            if (!snippet) return;
            openSnippetModalForEdit(categoryId, snippet);
        }

        function handleAskDeleteSnippet() {
            const categoryId = snippetMenuCategoryId;
            const snippetId = snippetMenuSnippetId;
            closeSnippetItemMenu();
            openDeleteSnippetModal(categoryId, snippetId);
        }

        function openSnippetModalForEdit(categoryId, snippet) {
            openSnippetModal({
                id: snippet.id,
                name: snippet.name,
                categoryId: categoryId,
                content: snippet.content
            });
        }

        function openSnippetModalFromField(fieldId) {
            const ta = document.getElementById(`input-${fieldId}`);
            const text = ta ? ta.value : '';
            openSnippetModal({
                id: null,
                name: '',
                categoryId: fieldId,
                content: text
            });
        }

        function openFreeSnippetSaveModal() {
            freeSyncHtmlToMarkdown();
            const text = freeGetMarkdown();
            openSnippetModal({
                id: null,
                name: '',
                categoryId: 'free',
                content: text
            });
        }

        function openDeleteSnippetModal(categoryId, snippetId) {
            pendingDeleteCategoryId = categoryId;
            pendingDeleteSnippetId = snippetId;
            const modal = document.getElementById('modal-snippet-delete');
            if (modal) modal.classList.remove('hidden');
        }

        function closeDeleteSnippetModal() {
            const modal = document.getElementById('modal-snippet-delete');
            if (modal) modal.classList.add('hidden');
            pendingDeleteCategoryId = null;
            pendingDeleteSnippetId = null;
        }

        async function confirmDeleteSnippet() {
            if (!pendingDeleteSnippetId || !window.db || !window.db.deleteSnippet) {
                closeDeleteSnippetModal();
                return;
            }
            const ok = await window.db.deleteSnippet(pendingDeleteSnippetId);
            if (ok) {
                const el = document.getElementById(`snippet-item-${pendingDeleteSnippetId}`);
                if (el) el.remove();
                if (snippetCacheById && snippetCacheById[pendingDeleteSnippetId]) {
                    delete snippetCacheById[pendingDeleteSnippetId];
                }
            }
            closeDeleteSnippetModal();
            if (ok && pendingDeleteCategoryId) {
                await loadSnippetSection(pendingDeleteCategoryId);
            }
            if (ok && settingsCurrentPage === 'snippets') {
                await loadManageSnippetsPage();
            }
        }

        function insertSnippetText(text, targetFieldId = null) {
            if (currentMode === 'free') {
                const editor = getFreeEditorEl();
                if (!editor) { alert('Freies Textfeld nicht gefunden.'); return; }
                editor.focus();
                document.execCommand('insertText', false, text);
                freeSyncHtmlToMarkdown();
                return;
            }

            let target = targetFieldId;

            if (target === 'free') {
                target = (activeFieldId && activeFieldId !== 'free') ? activeFieldId : 'context';
            }

            if (!target) {
                target = (activeFieldId && activeFieldId !== 'free') ? activeFieldId : 'context';
            }

            const ta = document.getElementById(`input-${target}`);
            if (!ta) { alert('Zielfeld nicht gefunden: ' + target); return; }
            ta.focus();
            const start = (ta.selectionStart ?? ta.value.length);
            const end = (ta.selectionEnd ?? ta.value.length);
            ta.value = ta.value.slice(0, start) + text + ta.value.slice(end);
            const pos = start + text.length;
            ta.setSelectionRange(pos, pos);
        }

        async function openSnippetCategory(id) {
            if (!isLeftOpen) toggleSidebar('left');
            activeFieldId = id;
            snippetOpenState[id] = true;
            renderSnippetsAccordion();
            await loadSnippetSection(id);
            const header = document.getElementById(`snip-body-${id}`)?.previousElementSibling;
            if (header && header.scrollIntoView) header.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function loadSnippetsForField(fieldId) {
            await openSnippetCategory(fieldId);
        }

        function loadSnippetsForFieldDemo(fieldId) {
            openSnippetCategory(fieldId);
        }

        function renderHistoryList(history) {
            const container = document.getElementById('history-list');
            if(!history || history.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-10">Keine Einträge.</div>';
                return;
            }
            container.innerHTML = history.map(item => `
                <div class="bg-navy-sidebar rounded-md border border-navy-border p-4 hover:border-slate-500 transition-colors">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold text-slate-500">${new Date(item.timestamp).toLocaleDateString()}</span>
                        <button class="text-slate-500 hover:text-brand-sky"><i class="fa-solid fa-copy"></i></button>
                    </div>
                    <div class="text-sm font-mono text-slate-400 h-20 overflow-y-auto custom-scrollbar">
                        ${item.text.substring(0, 150)}...
                    </div>
                </div>
            `).join('');
        }

        async function loadHistory() {
            if (!window.db) return;
            const history = await window.db.getHistory();
            renderHistoryList(history);
        }

        function renderFavoritesList(history) {
            const favs = history.filter(h => h.favorite);
            const container = document.getElementById('favorites-list');
            if(favs.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-10">Keine Favoriten.</div>';
                return;
            }
            container.innerHTML = favs.map(item => `
                <div class="bg-navy-sidebar rounded-md border border-navy-border p-4 border-l-4 border-l-brand-sky">
                    <div class="text-sm font-mono text-slate-300">
                        ${item.text.substring(0, 100)}...
                    </div>
                </div>
            `).join('');
        }

        function openSnippetModal(prefill = {}) {
            if (!window.currentUser) {
                alert("Bitte einloggen...");
                openAuthModal();
                return;
            }
            const modal = document.getElementById('modal-snippet');
            const titleEl = document.getElementById('snippet-modal-title');
            const nameEl = document.getElementById('snippet-name');
            const categoryEl = document.getElementById('snippet-category');
            const contentEl = document.getElementById('snippet-content');

            editingSnippetId = prefill.id || null;
            editingSnippetOriginalCategoryId = editingSnippetId ? (prefill.categoryId || null) : null;
            if (titleEl) titleEl.innerText = editingSnippetId ? 'Baustein bearbeiten' : 'Neuer Baustein';

            if (nameEl) nameEl.value = prefill.name || '';
            if (categoryEl) categoryEl.value = prefill.categoryId || 'context';
            if (contentEl) contentEl.value = prefill.content || '';

            if (modal) modal.classList.remove('hidden');
            if (nameEl) nameEl.focus();
        }

        function closeSnippetModal() {
            const modal = document.getElementById('modal-snippet');
            if (modal) modal.classList.add('hidden');
            editingSnippetId = null;
            editingSnippetOriginalCategoryId = null;
        }

        async function saveSnippetFromModal() {
            const nameEl = document.getElementById('snippet-name');
            const categoryEl = document.getElementById('snippet-category');
            const contentEl = document.getElementById('snippet-content');

            const name = nameEl?.value.trim();
            const content = contentEl?.value.trim();
            const category = categoryEl?.value;

            if (!name || !content) {
                alert("Name und Text sind Pflicht.");
                return;
            }

            let mode = 'structured';
            let field_id = category;
            if (category === 'free') {
                mode = 'free';
                field_id = 'free';
            }

            let success = false;
            if (editingSnippetId && window.db && window.db.updateSnippet) {
                success = await window.db.updateSnippet(editingSnippetId, { name, content, mode, field_id });
            } else if (window.db && window.db.saveSnippet) {
                success = await window.db.saveSnippet({ name, content, mode, field_id });
            }

            if (success) {
                closeSnippetModal();
                const oldCategory = editingSnippetOriginalCategoryId;
                editingSnippetOriginalCategoryId = null;
                snippetOpenState[category] = true;
                renderSnippetsAccordion();
                if (oldCategory && oldCategory !== category) {
                    const oldBody = document.getElementById(`snip-body-${oldCategory}`);
                    if (oldBody) oldBody.dataset.loaded = 'false';
                    if (snippetOpenState[oldCategory]) {
                        await loadSnippetSection(oldCategory);
                    }
                }
                await loadSnippetSection(category);
                if (settingsCurrentPage === 'snippets') {
                    await loadManageSnippetsPage();
                }
            } else {
                alert("Fehler beim Speichern.");
            }
        }

        function isSavePromptModalOpen() {
            const modal = document.getElementById('modal-save-prompt');
            return !!(modal && !modal.classList.contains('hidden'));
        }

        function setSavePromptCategory(value) {
            savePromptSelectedCategory = (value || '').trim();
            const label = savePromptSelectedCategory || 'Ohne Kategorie';
            const el = document.getElementById('save-prompt-category-value');
            if (el) el.textContent = label;
            closeSavePromptCategoryMenu();
        }

        function renderSavePromptCategoryMenu(categories) {
            const list = document.getElementById('save-prompt-category-list');
            if (!list) return;
            const items = [];
            items.push(`
                <button class="w-full px-4 py-2 text-left text-sm text-slate-200 hover:bg-slate-800/60 truncate"
                        onclick="setSavePromptCategory('')">
                    Ohne Kategorie
                </button>
            `);
            (categories || []).forEach(n => {
                items.push(`
                    <button class="w-full px-4 py-2 text-left text-sm text-slate-200 hover:bg-slate-800/60 truncate"
                            title=${JSON.stringify(n)}
                            onclick='setSavePromptCategory(${JSON.stringify(n)})'>
                        ${escapeHtml(n)}
                    </button>
                `);
            });
            list.innerHTML = items.join('');
        }

        function openSavePromptCategoryMenu(ev) {
            if (ev) ev.stopPropagation();
            const menu = document.getElementById('save-prompt-category-menu');
            const trigger = document.getElementById('save-prompt-category-trigger');
            if (!menu || !trigger) return;
            menu.classList.remove('hidden');
            savePromptCategoryMenuOpen = true;
            menu.onclick = (e) => e.stopPropagation();
            requestAnimationFrame(() => {
                const rect = trigger.getBoundingClientRect();
                const menuHeight = menu.offsetHeight;
                const spaceBelow = window.innerHeight - rect.bottom;
                const spaceAbove = rect.top;
                if (spaceBelow < menuHeight && spaceAbove > spaceBelow) {
                    menu.style.top = 'auto';
                    menu.style.bottom = 'calc(100% + 6px)';
                } else {
                    menu.style.bottom = 'auto';
                    menu.style.top = 'calc(100% + 6px)';
                }
            });
        }

        function closeSavePromptCategoryMenu() {
            const menu = document.getElementById('save-prompt-category-menu');
            if (menu) menu.classList.add('hidden');
            savePromptCategoryMenuOpen = false;
        }

        async function refreshSavePromptCategoryMenu() {
            try {
                const rows = window.db.getPromptCategories ? await window.db.getPromptCategories() : [];
                const names = (rows || [])
                    .map(r => (typeof r === 'string' ? r : r.name))
                    .filter(Boolean)
                    .map(s => s.trim())
                    .filter(Boolean);
                const unique = [...new Set(names)].sort((a, b) => a.localeCompare(b, 'de'));
                renderSavePromptCategoryMenu(unique);
            } catch (e) {
                console.error('Kategorie Dropdown Laden Fehler', e);
                renderSavePromptCategoryMenu([]);
            }
        }

        function handleSavePromptCategoryCreate(ev) {
            if (ev) ev.stopPropagation();
            closeSavePromptCategoryMenu();
            openPromptCategoryModal();
        }

        async function openSavePromptModal() {
            const modal = document.getElementById('modal-save-prompt');
            const inp = document.getElementById('save-prompt-name');
            const err = document.getElementById('save-prompt-error');
            if (err) {
                err.classList.add('hidden');
                err.innerText = '';
            }
            if (inp) inp.value = '';
            setSavePromptCategory('');
            await refreshSavePromptCategoryMenu();
            if (modal) modal.classList.remove('hidden');
            setTimeout(() => inp && inp.focus(), 50);
        }

        function closeSavePromptModal() {
            const modal = document.getElementById('modal-save-prompt');
            if (modal) modal.classList.add('hidden');
            closeSavePromptCategoryMenu();
        }

        async function confirmSavePromptModal() {
            const name = (document.getElementById('save-prompt-name')?.value || '').trim();
            const err = document.getElementById('save-prompt-error');
            if (!name) {
                if (err) {
                    err.innerText = 'Bitte einen Namen eingeben.';
                    err.classList.remove('hidden');
                }
                return;
            }
            closeSavePromptModal();
            await saveCurrentToLibraryWithName(name);
        }

        async function saveCurrentToLibrary() {
            if (!window.currentUser) {
                openAuthModal();
                return;
            }
            openSavePromptModal();
        }

        async function saveCurrentToLibraryWithName(name) {
            if (!window.currentUser) {
                openAuthModal();
                return;
            }

            const catVal = (savePromptSelectedCategory || '').trim() || null;

            if (currentMode === 'structured') {
                const fieldsData = FIELDS.map(f => document.getElementById(`input-${f.id}`).value);
                if (window.db && window.db.saveScenario) {
                    const success = await window.db.saveScenario({
                        name: name,
                        category: catVal,
                        fields: fieldsData
                    });

                    if (success) {
                        loadLibrary();
                    } else {
                        alert("Fehler beim Speichern.");
                    }
                }
            } else {
                freeSyncHtmlToMarkdown();
                const text = freeGetMarkdown().trim();
                if (!text) {
                    alert("Bitte Text eingeben.");
                    return;
                }
                if (window.db && window.db.saveScenario) {
                    const success = await window.db.saveScenario({
                        name: name,
                        category: catVal,
                        fields: { mode: 'free', text: text }
                    });

                    if (success) {
                        loadLibrary();
                    } else {
                        alert("Fehler beim Speichern.");
                    }
                }
            }
        }

        window.openSnippets = (id) => {
            openSnippetCategory(id);
        };
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="db.js"></script>
</body>
</html>



























