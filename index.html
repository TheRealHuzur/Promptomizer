<!DOCTYPE html>
<html lang="de" class="dark antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Promptomizer V5 - Zen Cockpit</title>
    <meta name="theme-color" content="#0B162A">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        navy: {
                            deep: '#0B162A',   // Global Background
                            light: '#15233b',  // Panels / Sidebars
                            border: '#1e293b', // Borders
                        },
                        brand: {
                            sky: '#0ea5e9',    // Accent
                            hover: '#38bdf8',  
                        },
                        slate: {
                            500: '#64748b',
                            800: '#1e293b',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; } /* No body scroll */
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0B162A; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #334155; }

        /* Transitions */
        .sidebar-transition { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s ease; }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Input Styles */
        textarea { resize: vertical; outline: none; transition: border-color 0.1s; }
        textarea:focus { border-color: #0ea5e9; }
        
        /* Segmented Control Active State */
        .segment-active { background-color: #0ea5e9; color: #0B162A; }
    </style>
</head>
<body class="bg-navy-deep text-slate-200 h-screen flex overflow-hidden">

    <!-- LEFT SIDEBAR (Navigation) -->
    <aside id="sidebar-left" class="w-16 md:w-64 bg-navy-light border-r border-navy-border flex flex-col justify-between sidebar-transition z-30 flex-shrink-0">
        <!-- Top: Logo & Nav -->
        <div>
            <div class="h-16 flex items-center px-4 border-b border-navy-border">
                <div class="w-8 h-8 rounded bg-gradient-to-br from-brand-sky to-blue-600 flex items-center justify-center shadow-lg shadow-brand-sky/20 flex-shrink-0">
                    <i class="fa-solid fa-cube text-white text-sm"></i>
                </div>
                <span class="ml-3 font-bold text-lg tracking-tight text-white hidden md:block whitespace-nowrap">Promptomizer</span>
            </div>

            <nav class="p-2 space-y-1">
                <button onclick="switchView('editor')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-slate-400 hover:bg-slate-800 hover:text-white transition-colors group active-nav">
                    <i class="fa-solid fa-pen-to-square w-5 text-center group-hover:text-brand-sky"></i>
                    <span class="hidden md:block text-sm font-medium">Editor</span>
                </button>
                <button onclick="switchView('history')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-slate-400 hover:bg-slate-800 hover:text-white transition-colors group">
                    <i class="fa-solid fa-clock-rotate-left w-5 text-center group-hover:text-brand-sky"></i>
                    <span class="hidden md:block text-sm font-medium">Historie</span>
                </button>
                <button onclick="switchView('favorites')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-slate-400 hover:bg-slate-800 hover:text-white transition-colors group">
                    <i class="fa-solid fa-star w-5 text-center group-hover:text-brand-sky"></i>
                    <span class="hidden md:block text-sm font-medium">Favoriten</span>
                </button>
            </nav>
        </div>

        <!-- Bottom: User & Settings -->
        <div class="p-2 border-t border-navy-border">
            <button onclick="openAuthModal()" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-slate-400 hover:bg-slate-800 hover:text-white transition-colors">
                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid fa-user text-xs"></i>
                </div>
                <div class="hidden md:block text-left overflow-hidden">
                    <div id="user-name-display" class="text-sm font-medium truncate">Gast</div>
                    <div class="text-xs text-slate-500">Login</div>
                </div>
            </button>
        </div>
    </aside>

    <!-- CENTER STAGE (Main Content) -->
    <main class="flex-1 flex flex-col min-w-0 bg-navy-deep relative">
        
        <!-- HEADER (Toolbar) -->
        <header class="h-16 border-b border-navy-border bg-navy-deep/95 backdrop-blur flex items-center justify-between px-4 z-20 flex-shrink-0">
            <div class="flex items-center gap-4 flex-1">
                <button onclick="toggleSidebar('left')" class="text-slate-400 hover:text-white">
                    <i class="fa-solid fa-bars"></i>
                </button>
                
                <!-- Project Title Input -->
                <div class="flex items-center gap-2 group">
                    <i class="fa-solid fa-pen text-xs text-slate-600 group-hover:text-slate-400"></i>
                    <input type="text" id="project-title" value="Unbenanntes Projekt" class="bg-transparent border-none text-white font-medium focus:ring-0 p-0 w-48 md:w-64 placeholder-slate-600">
                </div>
            </div>

            <!-- Mode Switcher -->
            <div class="flex bg-navy-light p-1 rounded-lg border border-navy-border">
                <button onclick="setEditorMode('structured')" id="btn-mode-structured" class="px-4 py-1.5 rounded-md text-xs font-bold transition-all segment-active">
                    Strukturiert
                </button>
                <button onclick="setEditorMode('free')" id="btn-mode-free" class="px-4 py-1.5 rounded-md text-xs font-bold text-slate-400 hover:text-white transition-all">
                    Frei
                </button>
            </div>

            <div class="flex items-center gap-4 flex-1 justify-end">
                <button onclick="toggleSidebar('right')" class="text-slate-400 hover:text-white">
                    <i class="fa-solid fa-book-open"></i>
                </button>
            </div>
        </header>

        <!-- CONTENT AREA (Scrollable) -->
        <div id="main-scroll-area" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
            
            <!-- VIEW: EDITOR -->
            <div id="view-editor" class="max-w-4xl mx-auto fade-in">
                
                <!-- MODE A: STRUCTURED -->
                <div id="editor-structured" class="space-y-8">
                    <!-- Fields injected via JS -->
                </div>

                <!-- MODE B: FREE TEXT -->
                <div id="editor-free" class="hidden h-full flex flex-col">
                    <!-- Markdown Toolbar -->
                    <div class="sticky top-0 z-10 bg-navy-light border border-slate-600 rounded-t-md p-2 flex gap-1 shadow-md">
                        <button onclick="insertMarkdown('# ')" class="p-2 hover:bg-slate-700 rounded text-slate-300" title="H1"><i class="fa-solid fa-heading"></i></button>
                        <button onclick="insertMarkdown('## ')" class="p-2 hover:bg-slate-700 rounded text-slate-300" title="H2"><i class="fa-solid fa-heading text-sm"></i></button>
                        <div class="w-px bg-slate-600 mx-1"></div>
                        <button onclick="insertMarkdown('**text**')" class="p-2 hover:bg-slate-700 rounded text-slate-300" title="Bold"><i class="fa-solid fa-bold"></i></button>
                        <button onclick="insertMarkdown('*text*')" class="p-2 hover:bg-slate-700 rounded text-slate-300" title="Italic"><i class="fa-solid fa-italic"></i></button>
                        <div class="w-px bg-slate-600 mx-1"></div>
                        <button onclick="insertMarkdown('- ')" class="p-2 hover:bg-slate-700 rounded text-slate-300" title="List"><i class="fa-solid fa-list-ul"></i></button>
                        <button onclick="insertMarkdown('1. ')" class="p-2 hover:bg-slate-700 rounded text-slate-300" title="Ordered"><i class="fa-solid fa-list-ol"></i></button>
                        <button onclick="insertMarkdown('> ')" class="p-2 hover:bg-slate-700 rounded text-slate-300" title="Quote"><i class="fa-solid fa-quote-right"></i></button>
                    </div>
                    <textarea id="input-free" class="w-full min-h-[60vh] bg-navy-deep border-x-2 border-b-2 border-slate-600 rounded-b-md p-6 text-lg text-slate-200 font-mono leading-relaxed focus:border-brand-sky placeholder-slate-600" placeholder="Schreibe deinen Prompt hier..."></textarea>
                </div>

            </div>

            <!-- VIEW: HISTORY (Placeholder) -->
            <div id="view-history" class="hidden max-w-4xl mx-auto fade-in">
                <h2 class="text-2xl font-bold text-white mb-6">Historie</h2>
                <div id="history-list" class="space-y-4"></div>
            </div>

            <!-- VIEW: FAVORITES (Placeholder) -->
            <div id="view-favorites" class="hidden max-w-4xl mx-auto fade-in">
                <h2 class="text-2xl font-bold text-white mb-6">Favoriten</h2>
                <div id="favorites-list" class="space-y-4"></div>
            </div>

        </div>

        <!-- FOOTER (Sticky Action Bar) -->
        <footer class="h-20 bg-navy-deep border-t border-navy-border flex items-center justify-end px-8 z-30 flex-shrink-0">
            <div class="flex gap-4">
                <button onclick="resetCurrentView()" class="px-6 py-3 text-slate-400 hover:text-red-500 font-medium transition-colors">
                    Reset
                </button>
                <button onclick="handleCopyAndSave()" class="bg-brand-sky hover:bg-brand-hover text-navy-deep font-bold py-3 px-8 rounded-md shadow-lg shadow-brand-sky/20 flex items-center gap-3 transform active:scale-95 transition-all">
                    <i class="fa-solid fa-copy"></i>
                    <span>COPY & SAVE</span>
                </button>
            </div>
        </footer>

    </main>

    <!-- RIGHT SIDEBAR (Library) -->
    <aside id="sidebar-right" class="w-80 bg-navy-light border-l border-navy-border flex flex-col sidebar-transition z-30 flex-shrink-0 transform translate-x-0">
        <div class="p-4 border-b border-navy-border">
            <h3 class="font-bold text-slate-400 text-xs uppercase tracking-wider mb-3">Bibliothek</h3>
            <div class="relative">
                <i class="fa-solid fa-search absolute left-3 top-3 text-slate-500 text-sm"></i>
                <input type="text" placeholder="Suchen..." class="w-full bg-navy-deep border border-slate-700 rounded-md py-2 pl-9 pr-3 text-sm text-white focus:border-brand-sky focus:ring-0">
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 space-y-6">
            <!-- Scenarios Section -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-white text-sm">Szenarien</h4>
                    <button class="text-xs text-brand-sky hover:text-white"><i class="fa-solid fa-plus"></i> Neu</button>
                </div>
                <div id="library-scenarios" class="space-y-2">
                    <!-- Injected via JS -->
                    <div class="text-xs text-slate-500 italic">Lade...</div>
                </div>
            </div>

            <!-- Snippets Section -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-white text-sm">Bausteine</h4>
                </div>
                <div id="library-snippets" class="space-y-2">
                    <div class="text-xs text-slate-500 italic">W√§hle ein Feld im Editor.</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- JAVASCRIPT -->
    <script>
        // --- CONFIG ---
        const FIELDS = [
            { id: 'role', label: 'Rolle & Funktion', icon: 'fa-user-tie', placeholder: 'Wer soll die KI sein?' },
            { id: 'context', label: 'Kontext', icon: 'fa-earth-europe', placeholder: 'Hintergrundinfos...' },
            { id: 'task', label: 'Aufgabe', icon: 'fa-bullseye', placeholder: 'Was soll getan werden?' },
            { id: 'style', label: 'Stil & Tonalit√§t', icon: 'fa-palette', placeholder: 'Wie soll es klingen?' },
            { id: 'format', label: 'Format', icon: 'fa-list-check', placeholder: 'Ausgabeformat...' }
        ];

        let currentMode = 'structured'; // 'structured' or 'free'

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderStructuredFields();
            // Mock loading library
            setTimeout(() => {
                document.getElementById('library-scenarios').innerHTML = `
                    <div class="p-2 bg-navy-deep border border-slate-700 rounded text-sm text-slate-300 hover:border-brand-sky cursor-pointer transition-colors">Meeting Protokoll</div>
                    <div class="p-2 bg-navy-deep border border-slate-700 rounded text-sm text-slate-300 hover:border-brand-sky cursor-pointer transition-colors">E-Mail Antwort</div>
                `;
            }, 500);
        });

        // --- RENDER ---
        function renderStructuredFields() {
            const container = document.getElementById('editor-structured');
            container.innerHTML = FIELDS.map(f => `
                <div class="group relative">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fa-solid ${f.icon} text-brand-sky"></i>
                        <label class="font-bold text-brand-sky text-sm uppercase tracking-wide">${f.label}</label>
                    </div>
                    <textarea id="input-${f.id}" 
                        class="w-full h-32 bg-navy-deep border-2 border-slate-500 rounded-md p-4 text-slate-200 placeholder-slate-600 input-hard-swap text-base leading-relaxed"
                        placeholder="${f.placeholder}"></textarea>
                    
                    <!-- Quick Actions (Hover) -->
                    <div class="absolute top-0 right-0 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                        <button class="text-xs bg-navy-light border border-slate-600 px-2 py-1 rounded text-slate-400 hover:text-white" onclick="openSnippets('${f.id}')">
                            <i class="fa-solid fa-book"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // --- LAYOUT LOGIC ---
        function toggleSidebar(side) {
            const el = document.getElementById(`sidebar-${side}`);
            if (side === 'left') {
                // Toggle width classes for left sidebar
                el.classList.toggle('w-16');
                el.classList.toggle('w-0'); // Mobile hide
                el.classList.toggle('md:w-64');
                // Simple toggle logic for demo, can be refined
                if(el.classList.contains('w-0')) el.classList.remove('w-0');
                else el.classList.add('w-0');
            } else {
                // Right sidebar translate toggle
                el.classList.toggle('translate-x-full');
                el.classList.toggle('!w-0');
                el.classList.toggle('hidden');
            }
        }

        function switchView(viewId) {
            // Hide all views
            ['view-editor', 'view-history', 'view-favorites', 'view-help'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
            // Show target
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            
            // Update Nav State
            // (Simplified for this demo)
        }

        function setEditorMode(mode) {
            currentMode = mode;
            const btnStruct = document.getElementById('btn-mode-structured');
            const btnFree = document.getElementById('btn-mode-free');
            const divStruct = document.getElementById('editor-structured');
            const divFree = document.getElementById('editor-free');

            if (mode === 'structured') {
                btnStruct.classList.add('segment-active', 'text-navy-deep');
                btnStruct.classList.remove('text-slate-400');
                btnFree.classList.remove('segment-active', 'text-navy-deep');
                btnFree.classList.add('text-slate-400');
                
                divStruct.classList.remove('hidden');
                divFree.classList.add('hidden');
            } else {
                btnFree.classList.add('segment-active', 'text-navy-deep');
                btnFree.classList.remove('text-slate-400');
                btnStruct.classList.remove('segment-active', 'text-navy-deep');
                btnStruct.classList.add('text-slate-400');

                divFree.classList.remove('hidden');
                divStruct.classList.add('hidden');
            }
        }

        // --- MARKDOWN TOOLBAR ---
        function insertMarkdown(syntax) {
            const textarea = document.getElementById('input-free');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const before = text.substring(0, start);
            const after = text.substring(end, text.length);
            
            textarea.value = before + syntax + after;
            textarea.selectionStart = textarea.selectionEnd = start + syntax.length;
            textarea.focus();
        }

        // --- CORE LOGIC: COPY & SAVE ---
        async function handleCopyAndSave() {
            let finalText = "";
            
            if (currentMode === 'structured') {
                const headerMap = { 'role': 'üé≠ ROLLE', 'context': 'üåç KONTEXT', 'task': 'üéØ AUFGABE', 'style': 'üé® STIL', 'format': 'üß™ VARIANTEN' };
                FIELDS.forEach(f => {
                    const val = document.getElementById(`input-${f.id}`).value.trim();
                    if (val) finalText += `**${headerMap[f.id]}**\n${val}\n\n`;
                });
            } else {
                finalText = document.getElementById('input-free').value.trim();
            }

            if (!finalText) {
                alert("Bitte gib erst etwas ein!");
                return;
            }

            // 1. Copy
            try {
                await navigator.clipboard.writeText(finalText);
                // 2. Save (Implizit)
                if (window.db && window.db.savePrompt) {
                    const title = document.getElementById('project-title').value;
                    await window.db.savePrompt({
                        text: finalText,
                        title: title, // New field for V5
                        mode: currentMode,
                        timestamp: new Date().toISOString()
                    });
                    console.log("Auto-Saved to History");
                }
                
                // Feedback
                const btn = document.querySelector('footer button:last-child');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> <span>COPIED!</span>';
                btn.classList.replace('bg-brand-sky', 'bg-green-500');
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.replace('bg-green-500', 'bg-brand-sky');
                }, 2000);

            } catch (err) {
                console.error('Copy failed', err);
                alert("Fehler beim Kopieren");
            }
        }

        function resetCurrentView() {
            if(confirm("Wirklich alles leeren?")) {
                if(currentMode === 'structured') {
                    FIELDS.forEach(f => document.getElementById(`input-${f.id}`).value = '');
                } else {
                    document.getElementById('input-free').value = '';
                }
            }
        }

        // --- MOCK DB INTEGRATION ---
        // Placeholder for db.js functions if not present
        window.openSnippets = (id) => {
            console.log("Open Snippets for", id);
            // Logic to load snippets into right sidebar
            const container = document.getElementById('library-snippets');
            container.innerHTML = `
                <div class="p-2 bg-navy-deep border border-slate-700 rounded text-sm text-slate-300 hover:border-brand-sky cursor-pointer">Beispiel Snippet f√ºr ${id}</div>
            `;
            // Ensure right sidebar is open
            const sb = document.getElementById('sidebar-right');
            if(sb.classList.contains('hidden') || sb.classList.contains('!w-0')) toggleSidebar('right');
        };

    </script>
    
    <!-- Supabase & DB Logic -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="db.js"></script>
</body>
</html>