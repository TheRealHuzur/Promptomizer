<!DOCTYPE html>
<html lang="de" class="dark antialiased">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Promptomizer Beta</title>
    <meta name="theme-color" content="#020617">

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        navy: {
                            deep: '#020617',    // Slate 950 (Main Stage)
                            sidebar: '#0f172a', // Slate 900 (Sidebar)
                            border: '#1e293b',  // Slate 800 (Borders)
                        },
                        brand: {
                            sky: '#0ea5e9',    // DEIN ORIGINAL (Sky 500)
                            hover: '#38bdf8',  // Heller beim Drüberfahren (Hover Effekt umgedreht)
                        },
                        slate: {
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'glow': '0 0 20px -5px rgba(56, 189, 248, 0.3)',
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-color: #020617;
        }

        /* Premium Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
            border: 1px solid #0f172a;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        textarea::-webkit-scrollbar {
            width: 10px;
        }

        textarea::-webkit-scrollbar-track {
            background: transparent;
        }

        textarea::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
            border: 1px solid #0f172a;
        }

        textarea::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }


        /* Transitions */
        .sidebar-transition {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .rotate-icon {
            transition: transform 0.3s ease;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Input Styles - Surface Look */
        textarea {
            resize: vertical;
            outline: none;
            background-color: #0f172a;
            /* Slate 900 - hebt sich vom Hintergrund ab */
            border: 1px solid #1e293b;
            /* Slate 800 */
            color: #f1f5f9;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        textarea:focus {
            background-color: #0f172a;
            border-color: #38bdf8;
            box-shadow: 0 0 0 1px #38bdf8, 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Toggle Button Style */
        .splitter-toggle {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 48px;
            background-color: #0f172a;
            /* Match Sidebar */
            border: 1px solid #1e293b;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
            color: #64748b;
            transition: all 0.2s;
        }

        .splitter-toggle:hover {
            color: #38bdf8;
            border-color: #38bdf8;
            background-color: #1e293b;
        }

        .nav-item .nav-indicator {
            opacity: 0;
        }

        .nav-item.active-nav .nav-indicator {
            opacity: 1;
        }

        .nav-item.active-nav {
            background-color: #1e293b;
            /* Slate 800 */
            color: white;
        }

        :root {
            --navy-deep: #020617;
            --navy-sidebar: #0f172a;
            --navy-border: #1e293b;
            --brand-sky: #0ea5e9;
            --brand-hover: #38bdf8;
            --text: #e2e8f0;
            --muted: #94a3b8;
            --sidebar-w: 16rem;
            --sidebar-w-collapsed: 4rem;
            --sidebar-current-w: var(--sidebar-w);
        }

        body.sidebar-collapsed {
            --sidebar-current-w: var(--sidebar-w-collapsed);
        }

        #sidebar-left {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: var(--sidebar-current-w);
        }

        #header-spacer-left {
            width: var(--sidebar-current-w);
        }

        #app-body {
            margin-left: var(--sidebar-current-w);
            transition: margin-left .3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #sidebar-inner {
            padding-top: 0;
            height: auto;
            min-height: 0;
        }

        #sidebar-library {
            min-height: 0;
        }

        body.sidebar-collapsed #sidebar-topbar {
            justify-content: center;
        }

        body.sidebar-collapsed #sidebar-left .nav-label {
            display: none;
        }

        body.sidebar-collapsed #sidebar-left .sidebar-nav-title {
            display: none;
        }

        body.sidebar-collapsed #sidebar-library {
            display: none;
        }

        body.sidebar-collapsed #sidebar-left .nav-item {
            justify-content: center;
            gap: 0;
        }

        body.sidebar-collapsed #sidebar-left .nav-item i {
            margin: 0;
        }

        body.sidebar-collapsed #sidebar-left .sidebar-user-text {
            display: none;
        }

        .ui-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .80);
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .ui-modal {
            background: var(--navy-sidebar);
            border: 1px solid var(--navy-border);
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, .45);
            padding: 24px;
            width: 100%;
        }

        .ui-modal-sm {
            max-width: 24rem;
        }

        .ui-modal-lg {
            max-width: 32rem;
        }

        .ui-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .ui-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #fff;
        }

        .ui-icon-btn {
            color: #64748b;
            transition: color .15s ease, background .15s ease, transform .15s ease;
            border-radius: 8px;
            padding: 6px;
        }

        .ui-icon-btn:hover {
            color: #fff;
            background: rgba(30, 41, 59, .40);
        }

        .ui-icon-btn:active {
            transform: scale(.98);
        }

        .ui-label {
            font-size: .75rem;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: .12em;
        }

        .ui-input,
        .ui-select,
        .ui-textarea {
            width: 100%;
            margin-top: 8px;
            border-radius: 10px;
            padding: 12px;
            background: var(--navy-deep);
            border: 1px solid var(--navy-border);
            color: var(--text);
            outline: none;
            transition: border-color .15s ease, box-shadow .15s ease;
        }

        .ui-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .ui-input:focus,
        .ui-select:focus,
        .ui-textarea:focus {
            border-color: var(--brand-sky);
            box-shadow: 0 0 0 1px var(--brand-sky);
        }

        .ui-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        .ui-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: .875rem;
            font-weight: 700;
            transition: background .15s ease, color .15s ease, border-color .15s ease, transform .15s ease, box-shadow .15s ease;
            user-select: none;
        }

        .ui-btn:active {
            transform: scale(.98);
        }

        .ui-btn-ghost {
            color: var(--muted);
            background: transparent;
        }

        .ui-btn-ghost:hover {
            color: #fff;
        }

        .ui-btn-primary {
            background: var(--brand-sky);
            color: var(--navy-deep);
            box-shadow: 0 0 20px -5px rgba(56, 189, 248, .30);
        }

        .ui-btn-primary:hover {
            background: var(--brand-hover);
        }

        .ui-btn-danger {
            background: #ef4444;
            color: #fff;
        }

        .ui-btn-danger:hover {
            background: #dc2626;
        }

        #input-free {
            font-family: 'Inter', sans-serif;
            white-space: pre-wrap;
            outline: none;
            overflow-y: auto;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }

        #input-free:empty:before {
            content: attr(data-placeholder);
            color: #64748b;
        }

        #input-free h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
        }

        #input-free h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #fff;
        }

        #input-free h3 {
            font-size: 1.1rem;
            font-weight: 700;
            color: #fff;
        }

        #input-free ul {
            list-style: disc;
            padding-left: 1.5rem;
        }

        #input-free ol {
            list-style: decimal;
            padding-left: 1.5rem;
        }

        #input-free li {
            margin: 0.15rem 0;
        }

        #input-free code,
        #input-free pre {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            background-color: rgba(30, 41, 59, 0.5);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            color: #38bdf8;
            font-size: 0.9em;
            white-space: pre-wrap;
            word-break: break-all;
        }

        #input-free pre {
            display: block;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid rgba(56, 189, 248, 0.2);
        }

        #input-free blockquote {
            font-style: italic;
            border-left: 3px solid rgba(148, 163, 184, 0.5);
            padding-left: 0.75rem;
            color: #cbd5f5;
            margin: 6px 0;
        }
    </style>
</head>

<body class="text-slate-400 h-screen flex flex-col w-full bg-navy-deep">

    <header id="app-header" class="h-14 flex-shrink-0 w-full relative z-40 shadow-sm pointer-events-none">
        <!-- Hintergrund + Bottom-Border nur für den Main-Bereich (rechts neben der Sidebar) -->
        <div id="header-bg" class="absolute inset-y-0 right-0 bg-navy-sidebar border-b border-navy-border"
            style="left: var(--sidebar-current-w);"></div>

        <!-- Inhalt -->
        <div class="relative z-10 w-full h-full flex items-center justify-center">
            <!-- Spacer bleibt, damit Logo/Controls weiterhin korrekt zentriert sind; klickt sich durch (pointer-events-none) -->
            <div id="header-spacer-left"
                class="sidebar-transition flex-shrink-0 border-r border-transparent pointer-events-none"></div>

            <!-- Interaktiver Bereich (Buttons etc.) wieder klickbar -->
            <div class="flex-1 flex justify-center px-6 md:px-10 min-w-0 pointer-events-auto">
                <div class="w-full max-w-4xl flex items-center justify-between">
                    <div class="flex items-center select-none leading-none">
                        <span class="text-xl font-bold tracking-tight text-white">Prompt</span>
                        <span class="text-xl font-bold tracking-tight text-brand-sky">omizer</span>
                    </div>

                    <div class="flex bg-navy-deep p-1 rounded-lg border border-navy-border">
                        <button onclick="setEditorMode('structured')" id="btn-mode-structured"
                            class="px-5 py-1 rounded text-xs font-bold transition-all bg-brand-sky text-navy-deep shadow-glow">
                            Strukturiert
                        </button>
                        <button onclick="setEditorMode('free')" id="btn-mode-free"
                            class="px-5 py-1 rounded text-xs font-bold text-slate-500 hover:text-slate-300 transition-all">
                            Frei
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div id="app-body" class="flex-1 flex overflow-hidden relative">

        <aside id="sidebar-left"
            class="w-64 bg-navy-sidebar border-r border-navy-border flex flex-col sidebar-transition overflow-hidden relative flex-shrink-0 z-20">
            <div id="sidebar-topbar" class="h-14 flex items-center justify-end px-3 border-r border-transparent">
                <button id="btn-sidebar-collapse"
                    class="ui-icon-btn w-9 h-9 flex items-center justify-center leading-none"
                    onclick="toggleSidebar('left')" title="Sidebar umschalten">
                    <i class="fa-solid fa-table-columns leading-none relative top-px"></i>
                </button>
            </div>
            <div id="sidebar-inner" class="flex flex-col flex-1 min-h-0">
                <div class="px-2 py-4">
                    <div
                        class="sidebar-nav-title text-[11px] font-bold text-slate-500 uppercase tracking-widest px-2 mb-2">
                        Navigation</div>
                    <div class="space-y-0.5">
                        <div onclick="switchView('editor')"
                            class="nav-item group relative flex items-center gap-3 px-3 py-2.5 rounded-md cursor-pointer active-nav transition-all">
                            <span class="nav-indicator absolute left-0 top-0 bottom-0 w-[3px] bg-brand-sky"></span>
                            <i class="fa-solid fa-pen-to-square w-5 text-center text-brand-sky"></i>
                            <span class="nav-label text-sm font-medium">Editor</span>
                        </div>
                        <div onclick="switchView('history')"
                            class="nav-item group relative flex items-center gap-3 px-3 py-2.5 rounded-md cursor-pointer text-slate-500 hover:text-slate-200 hover:bg-slate-800/50 transition-all">
                            <span class="nav-indicator absolute left-0 top-0 bottom-0 w-[3px] bg-brand-sky"></span>
                            <i
                                class="fa-solid fa-clock-rotate-left w-5 text-center group-hover:text-brand-sky transition-colors"></i>
                            <span class="nav-label text-sm font-medium">Historie</span>
                        </div>
                        <div onclick="toggleSettingsMenu(event)"
                            class="nav-item group relative flex items-center gap-3 px-3 py-2.5 rounded-md cursor-pointer text-slate-500 hover:text-slate-200 hover:bg-slate-800/50 transition-all">
                            <span class="nav-indicator absolute left-0 top-0 bottom-0 w-[3px] bg-brand-sky"></span>
                            <i
                                class="fa-solid fa-gear w-5 text-center group-hover:text-brand-sky transition-colors"></i>
                            <span class="nav-label text-sm font-medium">Einstellungen & Hilfe</span>
                        </div>
                    </div>
                </div>

                <div id="sidebar-library" class="flex-1 min-h-0 overflow-y-auto p-0">

                    <div class="bg-navy-sidebar">
                        <button onclick="togglePromptsSection()"
                            class="w-full flex items-center justify-between px-4 py-3 text-left">
                            <span class="flex items-center gap-2 text-base font-bold text-slate-400">
                                <i class="fa-solid fa-layer-group"></i> Prompts
                            </span>
                            <i id="prompts-toggle-icon"
                                class="fa-solid fa-chevron-down text-xs rotate-icon rotate-180"></i>
                        </button>
                    </div>
                    <div id="prompts-body" class="px-4 pt-1 pb-2">
                        <div id="library-scenarios" class="space-y-0.5">
                            <div class="text-xs text-slate-600 italic py-2">Lade...</div>
                        </div>
                    </div>

                    <div>
                        <button onclick="toggleSnippetsSection()"
                            class="w-full flex items-center justify-between px-4 py-3 text-left">
                            <span class="flex items-center gap-2 text-base font-bold text-slate-400">
                                <i class="fa-solid fa-cube"></i> Bausteine
                            </span>
                            <i id="snippets-toggle-icon"
                                class="fa-solid fa-chevron-down text-xs rotate-icon rotate-180"></i>
                        </button>
                        <div id="snippets-body" class="px-4 pt-1 pb-2">
                            <div id="library-snippets" class="space-y-0.5">
                                <div class="text-xs text-slate-600 italic py-2">Wähle ein Feld im Editor.</div>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="mt-auto flex-shrink-0">
                    <div class="h-20 px-4 border-t border-navy-border bg-black/10 flex items-center">
                        <button onclick="switchView('konto')"
                            class="user-button w-full flex items-center gap-3 text-slate-400 hover:text-white transition-colors">
                            <div
                                class="w-8 h-8 rounded bg-gradient-to-tr from-slate-700 to-slate-800 border border-slate-600 flex items-center justify-center text-white text-xs font-bold">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div class="sidebar-user-text text-left overflow-hidden">
                                <div id="user-name-display" class="text-sm font-bold text-slate-200 truncate">Gast</div>
                                <div id="user-status-sub"
                                    class="text-[10px] text-brand-sky font-bold tracking-wider uppercase truncate">Login
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-navy-deep relative z-10 shadow-inner">

            <button onclick="toggleSidebar('left')" class="splitter-toggle -left-3 rounded-r-md border-l-0 hidden"
                title="Toggle Navigation">
                <i id="icon-toggle-left" class="fa-solid fa-chevron-left text-xs rotate-icon"></i>
            </button>

            <div id="main-scroll-area" class="flex-1 overflow-y-auto p-6 md:p-10 scroll-smooth">

                <div id="view-editor" class="max-w-4xl mx-auto fade-in pb-20 h-full flex flex-col min-h-0">

                    <div id="editor-structured" class="space-y-8 pt-4">
                    </div>

                    <div id="editor-free" class="hidden flex-1 min-h-0 flex flex-col pt-4">
                        <div class="sticky top-0 z-20 bg-navy-deep p-2 flex items-center justify-between">
                            <div class="flex gap-1">
                                <button id="btn-free-h1" type="button" data-format="h1"
                                    class="free-format-btn px-2 py-1 rounded text-xs font-bold"
                                    onmousedown="event.preventDefault()" onclick="toggleFreeFormat('h1')">H1</button>
                                <button id="btn-free-h2" type="button" data-format="h2"
                                    class="free-format-btn px-2 py-1 rounded text-xs font-bold"
                                    onmousedown="event.preventDefault()" onclick="toggleFreeFormat('h2')">H2</button>
                                <button id="btn-free-h3" type="button" data-format="h3"
                                    class="free-format-btn px-2 py-1 rounded text-xs font-bold"
                                    onmousedown="event.preventDefault()" onclick="toggleFreeFormat('h3')">H3</button>
                                <button id="btn-free-bold" type="button" data-format="bold"
                                    class="free-format-btn p-2 rounded" onmousedown="event.preventDefault()"
                                    onclick="toggleFreeFormat('bold')"><i class="fa-solid fa-bold"></i></button>
                                <button id="btn-free-quote" type="button" data-format="quote"
                                    class="free-format-btn p-2 rounded" onmousedown="event.preventDefault()"
                                    onclick="toggleFreeFormat('quote')"><i class="fa-solid fa-quote-right"></i></button>
                                <button id="btn-free-ul" type="button" data-format="ul"
                                    class="free-format-btn p-2 rounded" onmousedown="event.preventDefault()"
                                    onclick="toggleFreeFormat('ul')"><i class="fa-solid fa-list-ul"></i></button>
                                <button id="btn-free-ol" type="button" data-format="ol"
                                    class="free-format-btn p-2 rounded" onmousedown="event.preventDefault()"
                                    onclick="toggleFreeFormat('ol')"><i class="fa-solid fa-list-ol"></i></button>
                                <button id="btn-free-code" type="button" data-format="code"
                                    class="free-format-btn p-2 rounded" onmousedown="event.preventDefault()"
                                    onclick="toggleFreeFormat('code')" title="Code/Monospaced"><i
                                        class="fa-solid fa-code"></i></button>
                            </div>
                            <button type="button"
                                class="group p-1.5 bg-transparent rounded-md hover:bg-slate-800/60 transition-colors"
                                onclick="openFreeSnippetSaveModal()" title="Als Baustein speichern">
                                <i
                                    class="fa-solid fa-floppy-disk text-brand-sky group-hover:text-brand-hover transition-colors"></i>
                            </button>
                        </div>
                        <div id="input-free" contenteditable="true" data-placeholder="Schreibe deinen Prompt hier..."
                            class="w-full flex-1 min-h-0 overflow-y-auto bg-navy-sidebar border border-navy-border rounded-md p-6 text-slate-200 text-base leading-relaxed font-sans"
                            onfocus="setActiveField('free')"></div>
                    </div>
                </div>

                <div id="view-history" class="hidden max-w-4xl mx-auto fade-in pt-4">
                    <div class="flex items-center mb-6 border-b border-navy-border pb-4">
                        <h2 class="text-2xl font-bold text-white">Historie</h2>
                    </div>
                    <div id="history-list" class="space-y-4"></div>
                </div>

                <div id="view-settings" class="hidden max-w-4xl mx-auto fade-in pt-4">
                    <div class="flex justify-between items-center mb-6 border-b border-navy-border pb-4">
                        <h2 id="settings-title" class="text-2xl font-bold text-white">Kategorien verwalten</h2>
                        <div id="settings-header-action"></div>
                    </div>
                    <div id="settings-content" class="space-y-4">
                        <div class="text-center text-slate-500 py-10">Inhalte folgen.</div>
                    </div>
                </div>

                <!-- KONTO VIEW -->
                <div id="view-konto" class="hidden max-w-4xl mx-auto fade-in pt-4 pb-20">
                    <div class="mb-8 border-b border-navy-border pb-4">
                        <h2 class="text-2xl font-bold text-white">Konto</h2>
                    </div>

                    <div class="space-y-12">
                        <!-- Profil -->
                        <section>
                            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-widest mb-4">Profil</h3>
                            <div class="bg-navy-sidebar border border-navy-border rounded-lg p-6">
                                <div class="flex items-center gap-4 mb-4">
                                    <div
                                        class="w-12 h-12 rounded bg-gradient-to-tr from-slate-700 to-slate-800 border border-slate-600 flex items-center justify-center text-white text-xl font-bold">
                                        <i class="fa-solid fa-user"></i>
                                    </div>
                                    <div>
                                        <div id="konto-user-name" class="text-lg font-bold text-white">Gast</div>
                                        <div id="konto-user-email" class="text-sm text-slate-400">Nicht eingeloggt</div>
                                    </div>
                                </div>
                                <p class="text-xs text-slate-500 italic">Weitere Einstellungen folgen.</p>
                            </div>
                        </section>

                        <!-- Plan & Abonnement -->
                        <section>
                            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-widest mb-4">Plan &
                                Abonnement</h3>
                            <div class="bg-navy-sidebar border border-navy-border rounded-lg p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <div class="text-lg font-bold text-white" id="konto-plan-name">Free Plan</div>
                                        <div class="text-sm text-slate-400">Aktueller Status</div>
                                    </div>
                                    <div
                                        class="px-3 py-1 bg-brand-sky/10 border border-brand-sky/20 rounded text-brand-sky text-xs font-bold uppercase tracking-wider">
                                        Aktiv</div>
                                </div>
                                <p class="text-xs text-slate-500 italic">Abo-Verwaltung folgt in Kürze.</p>
                            </div>
                        </section>

                        <!-- Rechtliches -->
                        <section>
                            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-widest mb-4">Rechtliches</h3>
                            <div class="bg-navy-sidebar border border-navy-border rounded-lg overflow-hidden">
                                <button onclick="switchView('impressum')"
                                    class="w-full flex items-center justify-between p-4 hover:bg-slate-800/50 border-b border-navy-border transition-colors group">
                                    <span
                                        class="text-slate-300 group-hover:text-white transition-colors">Impressum</span>
                                    <i class="fa-solid fa-chevron-right text-xs text-slate-500"></i>
                                </button>
                                <button onclick="switchView('datenschutz')"
                                    class="w-full flex items-center justify-between p-4 hover:bg-slate-800/50 border-b border-navy-border transition-colors group">
                                    <span
                                        class="text-slate-300 group-hover:text-white transition-colors">Datenschutzerklärung</span>
                                    <i class="fa-solid fa-chevron-right text-xs text-slate-500"></i>
                                </button>
                                <button onclick="switchView('agb')"
                                    class="w-full flex items-center justify-between p-4 hover:bg-slate-800/50 transition-colors group">
                                    <span class="text-slate-300 group-hover:text-white transition-colors">AGB &
                                        Widerrufsbelehrung</span>
                                    <i class="fa-solid fa-chevron-right text-xs text-slate-500"></i>
                                </button>
                            </div>
                        </section>

                        <!-- Konto löschen -->
                        <section>
                            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-widest mb-4">Gefahrenzone
                            </h3>
                            <div class="bg-navy-sidebar border border-red-500/20 rounded-lg p-6">
                                <button disabled
                                    class="px-4 py-2 bg-red-500/10 border border-red-500/20 text-red-400 rounded-md font-bold text-sm opacity-50 cursor-not-allowed">
                                    Konto löschen — demnächst verfügbar
                                </button>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- RECHTSEITEN VIEWS -->
                <div id="view-impressum" class="hidden h-full flex flex-col pt-4">
                    <div class="max-w-4xl mx-auto w-full px-4 mb-6">
                        <button onclick="switchView('konto')"
                            class="text-brand-sky hover:text-brand-hover flex items-center gap-2 font-medium transition-colors">
                            <i class="fa-solid fa-arrow-left"></i> Zurück zum Konto
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto bg-white rounded-t-3xl p-8 md:p-12 text-slate-800 shadow-2xl">
                        <div id="content-impressum" class="prose prose-slate max-w-none">
                            <!-- Inhalt wird nachgereicht -->
                        </div>
                    </div>
                </div>

                <div id="view-datenschutz" class="hidden h-full flex flex-col pt-4">
                    <div class="max-w-4xl mx-auto w-full px-4 mb-6">
                        <button onclick="switchView('konto')"
                            class="text-brand-sky hover:text-brand-hover flex items-center gap-2 font-medium transition-colors">
                            <i class="fa-solid fa-arrow-left"></i> Zurück zum Konto
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto bg-white rounded-t-3xl p-8 md:p-12 text-slate-800 shadow-2xl">
                        <div id="content-datenschutz" class="prose prose-slate max-w-none">
                            <!-- Inhalt wird nachgereicht -->
                        </div>
                    </div>
                </div>

                <div id="view-agb" class="hidden h-full flex flex-col pt-4">
                    <div class="max-w-4xl mx-auto w-full px-4 mb-6">
                        <button onclick="switchView('konto')"
                            class="text-brand-sky hover:text-brand-hover flex items-center gap-2 font-medium transition-colors">
                            <i class="fa-solid fa-arrow-left"></i> Zurück zum Konto
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto bg-white rounded-t-3xl p-8 md:p-12 text-slate-800 shadow-2xl">
                        <div id="content-agb" class="prose prose-slate max-w-none">
                            <!-- Inhalt wird nachgereicht -->
                        </div>
                    </div>
                </div>

            </div>

            <footer
                class="h-20 border-t border-navy-border flex items-center justify-center px-8 z-30 flex-shrink-0 bg-navy-deep">
                <div class="w-full max-w-4xl flex items-center gap-4">
                    <div id="footer-save-wrap">
                        <button onclick="saveCurrentToLibrary()"
                            class="bg-brand-sky hover:bg-brand-hover text-navy-deep font-bold py-3 px-8 rounded-md shadow-glow flex items-center gap-3 transform active:scale-95 transition-all">
                            <i class="fa-solid fa-floppy-disk"></i>
                            <span>Prompt speichern</span>
                        </button>
                    </div>
                    <div class="ml-auto flex items-center gap-4">
                        <button onclick="resetCurrentView()"
                            class="px-6 py-3 text-slate-500 hover:text-red-400 font-medium transition-colors text-xs uppercase tracking-wider font-bold">
                            Reset
                        </button>
                        <button id="btn-copy" onclick="handleCopyAndSave()"
                            class="bg-brand-sky hover:bg-brand-hover text-navy-deep font-bold py-3 px-8 rounded-md shadow-glow flex items-center gap-3 transform active:scale-95 transition-all">
                            <i class="fa-solid fa-copy"></i>
                            <span>Kopieren</span>
                        </button>
                    </div>
                </div>
            </footer>

        </main>
    </div>

    <div id="modal-snippet" class="ui-backdrop z-[110] hidden">
        <div class="ui-modal ui-modal-lg">
            <div class="ui-modal-header">
                <h3 id="snippet-modal-title" class="ui-modal-title">Neuer Baustein</h3>
                <button onclick="closeSnippetModal()" class="ui-icon-btn"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="ui-label">Name</label>
                    <input id="snippet-name" type="text" class="ui-input" placeholder="z.B. Kontext-Short" />
                </div>
                <div>
                    <label class="ui-label">Kategorie</label>
                    <select id="snippet-category" class="ui-select">
                        <option value="role">Rolle & Funktion</option>
                        <option value="context">Kontext</option>
                        <option value="task">Aufgabe</option>
                        <option value="format">Format</option>
                        <option value="free">Freie Bausteine</option>
                    </select>
                </div>
                <div>
                    <label class="ui-label">Baustein-Text</label>
                    <textarea id="snippet-content" class="ui-textarea"
                        placeholder="Text für den Baustein..."></textarea>
                </div>
            </div>
            <div class="ui-actions">
                <button onclick="closeSnippetModal()" class="ui-btn ui-btn-ghost">Abbrechen</button>
                <button onclick="saveSnippetFromModal()" class="ui-btn ui-btn-primary">Speichern</button>
            </div>
        </div>
    </div>
    <div id="modal-auth"
        class="fixed inset-0 z-[100] hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-navy-sidebar border border-navy-border w-full max-w-sm rounded-lg shadow-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white">Login</h3>
                <button onclick="closeAuthModal()" class="text-slate-500 hover:text-white">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">E-Mail</label>
                    <input id="auth-email" type="email"
                        class="w-full mt-2 rounded-md p-3 bg-navy-deep border border-navy-border text-slate-200 focus:border-brand-sky outline-none"
                        placeholder="name@mail.de" />
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Passwort</label>
                    <input id="auth-password" type="password"
                        class="w-full mt-2 rounded-md p-3 bg-navy-deep border border-navy-border text-slate-200 focus:border-brand-sky outline-none"
                        placeholder="••••••••" />
                </div>

                <label class="flex items-center gap-2 text-sm text-slate-300 select-none">
                    <input id="auth-remember" type="checkbox" class="accent-brand-sky" />
                    Angemeldet bleiben
                </label>

                <div id="auth-error" class="hidden text-sm text-red-400"></div>

                <button onclick="handleEmailLogin()"
                    class="w-full py-3 bg-brand-sky hover:bg-brand-hover text-navy-deep font-bold rounded-md shadow-glow transition-all active:scale-95">
                    Einloggen
                </button>

                <div class="h-px bg-navy-border"></div>

                <button onclick="loginWithGoogle()"
                    class="w-full py-3 bg-white text-navy-deep font-bold rounded-md flex justify-center gap-2 hover:bg-slate-100 transition-colors">
                    <i class="fa-brands fa-google"></i> Google Login
                </button>
            </div>
        </div>
    </div>

    <div id="snippet-item-menu"
        class="fixed z-[120] hidden bg-navy-sidebar border border-navy-border rounded-md shadow-xl w-40">
        <button onclick="handleEditSnippet()"
            class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/60">Bearbeiten</button>
        <button onclick="handleAskDeleteSnippet()"
            class="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-slate-800/60">Löschen</button>
    </div>

    <div id="prompt-item-menu"
        class="fixed z-[120] hidden bg-navy-sidebar border border-navy-border rounded-md shadow-xl w-44">
        <button onclick="handleEditPrompt()"
            class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/60">Bearbeiten</button>
        <div id="prompt-menu-category" class="relative group">
            <button
                class="w-full flex items-center justify-between px-4 py-2 text-left text-sm text-slate-300 hover:bg-slate-800/60"
                onmouseenter="openPromptCategorySubmenu()" onclick="return false;">
                <span>Kategorie</span>
                <i class="fa-solid fa-chevron-right text-xs text-slate-400"></i>
            </button>
            <div id="prompt-category-submenu"
                class="absolute top-0 left-full ml-2 w-64 hidden bg-navy-sidebar border border-navy-border rounded-lg shadow-2xl overflow-hidden">
                <button
                    class="w-full flex items-center gap-2 px-4 py-2 text-left text-sm hover:bg-slate-800/60 text-brand-sky"
                    onclick="handlePromptCategoryCreateFromMenu(event)">
                    Kategorie anlegen
                </button>
                <div class="h-px bg-navy-border"></div>
                <div id="prompt-category-submenu-list" class="py-1">
                    <div class="px-3 py-2 text-xs text-slate-500 italic">Lade…</div>
                </div>
            </div>
        </div>
        <button onclick="handleAskDeletePrompt()"
            class="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-slate-800/60">Löschen</button>
    </div>

    <div id="manage-category-menu"
        class="fixed z-[120] hidden bg-navy-sidebar border border-navy-border rounded-md shadow-xl w-44">
        <button onclick="handleManageCategoryRename()"
            class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/60">Umbenennen</button>
        <button onclick="handleManageCategoryDelete()"
            class="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-slate-800/60">Löschen</button>
    </div>
    <div id="manage-snippet-menu"
        class="fixed z-[120] hidden bg-navy-sidebar border border-navy-border rounded-md shadow-xl w-44">
        <button onclick="handleManageSnippetEdit()"
            class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/60">Bearbeiten</button>
        <button id="manage-snippet-target-trigger"
            class="w-full flex items-center justify-between px-4 py-2 text-left text-sm text-slate-300 hover:bg-slate-800/60"
            onmouseenter="openManageSnippetTargetSubmenu()" onclick="return false;">
            <span>Baustein</span>
            <i class="fa-solid fa-chevron-right text-xs text-slate-400"></i>
        </button>
        <button onclick="handleManageSnippetDelete()"
            class="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-slate-800/60">Löschen</button>
    </div>
    <div id="manage-snippet-target-submenu"
        class="fixed z-[121] hidden bg-navy-sidebar border border-navy-border rounded-lg shadow-2xl overflow-hidden w-64">
        <div id="manage-snippet-target-submenu-list" class="py-1">
            <div class="px-3 py-2 text-xs text-slate-500 italic">Lade…</div>
        </div>
    </div>
    <div id="settings-nav-menu"
        class="fixed z-[120] hidden bg-navy-sidebar border border-navy-border rounded-lg shadow-2xl overflow-hidden w-56">
        <button onclick="openSettingsPage('categories')"
            class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/60">Kategorien
            verwalten</button>
        <button onclick="openSettingsPage('snippets')"
            class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/60">Bausteine verwalten</button>
        <button onclick="openSettingsPage('help')"
            class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-800/60">Hilfe</button>
    </div>

    <div id="modal-snippet-delete" class="ui-backdrop z-[120] hidden">
        <div class="ui-modal ui-modal-sm">
            <h3 class="ui-modal-title mb-4">Unwiderruflich löschen?</h3>
            <div class="ui-actions">
                <button onclick="closeDeleteSnippetModal()" class="ui-btn ui-btn-ghost">Nein</button>
                <button onclick="confirmDeleteSnippet()" class="ui-btn ui-btn-danger">Ja</button>
            </div>
        </div>
    </div>

    <div id="modal-prompt-delete" class="ui-backdrop z-[120] hidden">
        <div class="ui-modal ui-modal-sm">
            <h3 class="ui-modal-title mb-4">Endgültig löschen?</h3>
            <div class="ui-actions">
                <button onclick="closeDeletePromptModal()" class="ui-btn ui-btn-ghost">Nein</button>
                <button onclick="confirmDeletePrompt()" class="ui-btn ui-btn-danger">Ja</button>
            </div>
        </div>
    </div>

    <div id="modal-prompt-edit" class="ui-backdrop z-[120] hidden">
        <div class="ui-modal ui-modal-sm">
            <h3 class="ui-modal-title mb-2">Prompt bearbeiten</h3>
            <p class="text-sm text-slate-400">Modal folgt im nÃ¤chsten Schritt.</p>
            <div class="ui-actions">
                <button onclick="closePromptEditModal()" class="ui-btn ui-btn-ghost">SchlieÃŸen</button>
            </div>
        </div>
    </div>

    <div id="modal-prompt-category" class="ui-backdrop z-[140] hidden">
        <div class="ui-modal ui-modal-lg">
            <div class="ui-modal-header">
                <h3 class="ui-modal-title">Kategorie anlegen</h3>
                <button onclick="closePromptCategoryModal()" class="ui-icon-btn">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <label class="ui-label">Name der Kategorie</label>
            <input id="prompt-category-name" type="text" class="ui-input"
                placeholder="z. B. Verwaltung, Workshop, ..." />
            <div class="ui-actions">
                <button onclick="closePromptCategoryModal()" class="ui-btn ui-btn-ghost">Abbrechen</button>
                <button onclick="savePromptCategoryFromModal()" class="ui-btn ui-btn-primary">Speichern</button>
            </div>
        </div>
    </div>

    <div id="modal-category-rename" class="ui-backdrop z-[120] hidden">
        <div class="ui-modal ui-modal-sm">
            <div class="ui-modal-header">
                <h3 class="ui-modal-title">Kategorie umbenennen</h3>
                <button onclick="closeRenameCategoryModal()" class="ui-icon-btn">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <label class="ui-label">Neuer Name</label>
            <input id="rename-category-name" type="text" class="ui-input"
                placeholder="z. B. Marketing, Workshop, ..." />
            <div class="ui-actions">
                <button onclick="closeRenameCategoryModal()" class="ui-btn ui-btn-ghost">Abbrechen</button>
                <button onclick="confirmRenameCategory()" class="ui-btn ui-btn-primary">Speichern</button>
            </div>
        </div>
    </div>

    <div id="modal-category-delete" class="ui-backdrop z-[120] hidden">
        <div class="ui-modal ui-modal-sm">
            <h3 class="ui-modal-title mb-3">Kategorie löschen</h3>
            <p class="text-sm text-slate-400 mb-4">Die Prompts in dieser Kategorie werden nicht gelöscht. Sie erscheinen
                anschließend unter „Ohne Kategorie“.</p>
            <div class="ui-actions">
                <button onclick="closeDeleteCategoryModal()" class="ui-btn ui-btn-ghost">Abbrechen</button>
                <button onclick="confirmDeleteCategory()" class="ui-btn ui-btn-danger">Löschen</button>
            </div>
        </div>
    </div>
    <div id="modal-save-prompt"
        class="fixed inset-0 z-[120] hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-navy-sidebar border border-navy-border w-full max-w-lg rounded-lg shadow-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white">Prompt speichern</h3>
                <button onclick="closeSavePromptModal()" class="text-slate-500 hover:text-white">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Name</label>
            <input id="save-prompt-name" type="text"
                class="w-full mt-2 rounded-md p-3 bg-navy-deep border border-navy-border text-slate-200 focus:border-brand-sky outline-none"
                placeholder="z.B. Workshop Auftakt" />

            <div id="save-prompt-category-field" class="mt-4 relative">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-wider block">Kategorie
                    (optional)</label>
                <button type="button" id="save-prompt-category-trigger"
                    class="w-full mt-2 rounded-md p-3 bg-navy-deep border border-navy-border text-slate-200 focus:border-brand-sky outline-none flex items-center justify-between"
                    onclick="openSavePromptCategoryMenu(event)">
                    <span id="save-prompt-category-value" class="truncate">Ohne Kategorie</span>
                    <i class="fa-solid fa-chevron-down text-xs text-slate-400"></i>
                </button>
                <div id="save-prompt-category-menu"
                    class="absolute left-0 right-0 mt-2 hidden bg-navy-sidebar border border-navy-border rounded-lg shadow-2xl overflow-hidden z-20">
                    <button
                        class="w-full flex items-center gap-2 px-4 py-2 text-left text-sm hover:bg-slate-800/60 text-brand-sky"
                        onclick="handleSavePromptCategoryCreate(event)">
                        Kategorie anlegen
                    </button>
                    <div class="h-px bg-navy-border"></div>
                    <div id="save-prompt-category-list" class="py-1"></div>
                </div>
            </div>

            <div id="save-prompt-error" class="hidden text-sm text-red-400 mt-3"></div>

            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeSavePromptModal()"
                    class="px-4 py-2 text-slate-400 hover:text-white">Abbrechen</button>
                <button onclick="confirmSavePromptModal()"
                    class="px-5 py-2 bg-brand-sky hover:bg-brand-hover text-navy-deep font-bold rounded-md">
                    Speichern
                </button>
            </div>
        </div>
    </div>

    <div id="modal-reset"
        class="fixed inset-0 z-[120] hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-navy-sidebar border border-navy-border w-full max-w-sm rounded-lg shadow-2xl p-6">
            <h3 class="text-xl font-bold text-white mb-3">Wirklich alles leeren?</h3>
            <p class="text-sm text-slate-400 mb-6">Der aktuelle Inhalt im Editor wird zurückgesetzt.</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeResetModal()" class="px-4 py-2 text-slate-400 hover:text-white">Abbrechen</button>
                <button onclick="confirmReset()"
                    class="px-5 py-2 bg-red-500 hover:bg-red-600 text-white font-bold rounded-md">Reset</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const FIELDS = [
            { id: 'role', label: 'Rolle & Funktion', icon: 'fa-user-tie', placeholder: 'Wer soll die KI sein? (z.B. Senior SEO Experte)' },
            { id: 'context', label: 'Kontext', icon: 'fa-earth-europe', placeholder: 'Hintergrundinfos (Zielgruppe, Kanal, Produkt...)' },
            { id: 'task', label: 'Aufgabe', icon: 'fa-bullseye', placeholder: 'Was soll getan werden? (Schreibe 3 Headlines...)' },
            { id: 'format', label: 'Format', icon: 'fa-list-check', placeholder: 'Ausgabeformat (Tabelle, Markdown, Liste...)' }
        ];
        const STRUCTURED_STORAGE_ORDER = ['role', 'context', 'task', 'style', 'format'];

        const SNIPPET_CATEGORIES = [
            { id: 'role', label: 'Rolle & Funktion', mode: 'structured' },
            { id: 'context', label: 'Kontext', mode: 'structured' },
            { id: 'task', label: 'Aufgabe', mode: 'structured' },
            { id: 'format', label: 'Format', mode: 'structured' },
            { id: 'free', label: 'Freie Bausteine', mode: 'free' }
        ];

        let currentMode = 'structured';
        let isLeftOpen = true;
        let isPromptsOpen = true;
        let isSnippetsOpen = true;
        let activeFieldId = null;
        let fieldFullscreenState = {};
        let snippetOpenState = { role: false, context: false, task: false, format: false, free: false };
        let snippetMenuOpen = false;
        let snippetMenuSnippetId = null;
        let snippetMenuCategoryId = null;
        let snippetMenuTriggerEl = null;
        let promptMenuTriggerEl = null;
        let sidebarMenuRaf = null;
        let snippetCacheById = {};
        let editingSnippetId = null;
        let pendingDeleteSnippetId = null;
        let pendingDeleteCategoryId = null;
        let promptOpenState = {};
        let promptCategoriesCache = [];
        let promptLibraryCache = [];
        let promptCategoryKeyToName = {};
        let promptMenuOpen = false;
        let promptMenuPromptId = null;
        let promptMenuCategoryKey = null;
        let pendingDeletePromptId = null;
        let pendingDeletePromptCategoryKey = null;
        let savePromptSelectedCategory = '';
        let savePromptCategoryMenuOpen = false;
        let settingsMenuOpen = false;
        let settingsCurrentPage = 'categories';
        let manageCategoryOpenState = {};
        window.manageCategoryOpenState = manageCategoryOpenState;
        let manageCategoryMenuOpen = false;
        let manageCategoryMenuId = null;
        let manageCategoryMenuName = '';
        let pendingRenameCategoryId = null;
        let pendingRenameCategoryName = '';
        let pendingDeleteManageCategoryId = null;
        let pendingDeleteManageCategoryName = '';
        let manageCategoriesCache = [];
        let managePromptsCache = [];
        let manageSnippetsOpenState = {};
        let manageSnippetsCacheByCat = {};
        let manageSnippetCacheById = {};
        let manageSnippetMenuOpen = false;
        let manageSnippetMenuSnippetId = null;
        let manageSnippetMenuCategoryId = null;
        let editingSnippetOriginalCategoryId = null;
        let freeActiveFormat = null;
        let freeMarkdownCache = '';
        let freeLastSelectionRange = null;
        let lastSidebarRefreshTs = 0;
        let historyCacheById = {};
        let historyFullscreenState = {};

        document.addEventListener('DOMContentLoaded', () => {
            const sidebarScroll = document.getElementById('sidebar-library');
            if (sidebarScroll) {
                sidebarScroll.addEventListener('scroll', scheduleSidebarMenuReposition, { passive: true });
            }
            window.addEventListener('resize', scheduleSidebarMenuReposition);
            renderStructuredFields();
            renderSnippetsAccordion();
            initFreeEditor();
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') safeRefreshSidebar();
            });
            window.addEventListener('focus', safeRefreshSidebar);
            document.addEventListener('click', (ev) => {
                if (snippetMenuOpen) closeSnippetItemMenu();
                if (promptMenuOpen) closePromptItemMenu();
                if (manageSnippetMenuOpen) closeManageSnippetMenu();
                if (savePromptCategoryMenuOpen) {
                    const field = document.getElementById('save-prompt-category-field');
                    if (!field || !field.contains(ev.target)) closeSavePromptCategoryMenu();
                }
                if (manageCategoryMenuOpen) closeManageCategoryMenu();
                if (settingsMenuOpen) closeSettingsMenu();
            });
            document.addEventListener('keydown', (ev) => {
                if (ev.key === 'Escape' && savePromptCategoryMenuOpen) closeSavePromptCategoryMenu();
                if (ev.key === 'Escape' && manageSnippetMenuOpen) closeManageSnippetMenu();
                if (ev.key === 'Escape' && manageCategoryMenuOpen) closeManageCategoryMenu();
                if (ev.key === 'Escape' && settingsMenuOpen) closeSettingsMenu();
            });

            // 1. Event Listener: Feuert sofort, wenn Supabase den Login bestätigt
            window.addEventListener('auth-state-changed', (event) => {
                const user = event.detail;
                console.log("🚀 Auth Status Update:", user ? "Eingeloggt" : "Gast");

                // UI und Bibliothek sofort aktualisieren
                updateUIAuth(user);
                loadLibrary();
            });

            // 2. Fallback Start: Versucht es einmalig kurz nach Start 
            // (Wichtig für Gast-Modus oder falls der Login extrem schnell war)
            setTimeout(() => {
                if (window.db && window.db.getScenarios) loadLibrary();
                if (window.currentUser) updateUIAuth(window.currentUser);
            }, 500);
        });

        // --- AUTH UI UPDATE ---
        function updateUIAuth(user) {
            const nameEl = document.getElementById('user-name-display');
            const subEl = document.getElementById('user-status-sub');
            if (nameEl && subEl) {
                if (user) {
                    nameEl.innerText = user.email.split('@')[0];
                    subEl.innerText = 'Pro Plan';
                    subEl.classList.add('text-brand-sky');
                } else {
                    nameEl.innerText = 'Gast';
                    subEl.innerText = 'Klicken zum Login';
                    subEl.classList.remove('text-brand-sky');
                }
            }
        }

        function closeAuthModal() {
            document.getElementById('modal-auth').classList.add('hidden');
        }

        function openAuthModal() {
            const remember = localStorage.getItem('promptomizer_remember') !== 'false';
            const cb = document.getElementById('auth-remember');
            if (cb) {
                cb.checked = remember;
                cb.onchange = () => {
                    if (window.setRememberPref) window.setRememberPref(cb.checked);
                };
            }

            const err = document.getElementById('auth-error');
            if (err) {
                err.classList.add('hidden');
                err.innerText = '';
            }

            document.getElementById('modal-auth').classList.remove('hidden');
        }

        async function handleEmailLogin() {
            const email = (document.getElementById('auth-email')?.value || '').trim();
            const password = (document.getElementById('auth-password')?.value || '').trim();
            const remember = !!document.getElementById('auth-remember')?.checked;

            const err = document.getElementById('auth-error');
            const showErr = (msg) => {
                if (!err) return;
                err.innerText = msg;
                err.classList.remove('hidden');
            };

            if (!email || !password) {
                showErr('Bitte E-Mail und Passwort eingeben.');
                return;
            }

            if (window.setRememberPref) window.setRememberPref(remember);

            const { data, error } = await loginUser(email, password);
            if (error) {
                showErr(error.message || 'Login fehlgeschlagen.');
                return;
            }

            closeAuthModal();
        }

        // --- RENDER ---
        function renderStructuredFields() {
            const container = document.getElementById('editor-structured');
            container.innerHTML = FIELDS.map(f => `
                <div class="group relative">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fa-solid ${f.icon} text-brand-sky"></i>
                        <label class="font-bold text-brand-sky text-xl">${f.label}</label>
                    </div>
                    <textarea id="input-${f.id}" 
                        class="w-full h-32 rounded-md p-4 text-slate-200 placeholder-slate-600 text-base leading-relaxed"
                        placeholder="${f.placeholder}"
                        onfocus="setActiveField('${f.id}')"></textarea>
                    <div class="absolute top-0 right-0 flex items-center gap-1">
                        <button class="group p-1.5 bg-transparent rounded-md hover:bg-slate-800/60 transition-colors" onclick="event.stopPropagation(); toggleFieldFullscreen('${f.id}')" title="Feld vergrößern">
                            <i id="field-fullscreen-icon-${f.id}" class="fa-solid fa-up-right-and-down-left-from-center text-brand-sky group-hover:text-brand-hover transition-colors"></i>
                        </button>
                        <button class="group p-1.5 bg-transparent rounded-md hover:bg-slate-800/60 transition-colors" onclick="event.stopPropagation(); openSnippetModalFromField('${f.id}')" title="Als Baustein speichern">
                            <i class="fa-solid fa-floppy-disk text-brand-sky group-hover:text-brand-hover transition-colors"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function toggleFieldFullscreen(fieldId) {
            const ta = document.getElementById(`input-${fieldId}`);
            const icon = document.getElementById(`field-fullscreen-icon-${fieldId}`);
            if (!ta || !icon) return;

            const isExpanded = !!fieldFullscreenState[fieldId];
            if (!isExpanded) {
                const baseHeight = ta.offsetHeight;
                ta.dataset.baseHeightPx = baseHeight;
                ta.style.height = (baseHeight * 3) + 'px';
                fieldFullscreenState[fieldId] = true;
                icon.classList.remove('fa-up-right-and-down-left-from-center');
                icon.classList.add('fa-down-left-and-up-right-to-center');
            } else {
                const baseHeight = parseFloat(ta.dataset.baseHeightPx || '0');
                ta.style.height = baseHeight ? (baseHeight + 'px') : '';
                fieldFullscreenState[fieldId] = false;
                icon.classList.remove('fa-down-left-and-up-right-to-center');
                icon.classList.add('fa-up-right-and-down-left-from-center');
            }
        }
        // --- LAYOUT LOGIC ---
        function toggleSidebar(side) {
            if (side === 'right') return;

            if (side === 'left') {
                if (isLeftOpen) {
                    document.body.classList.add('sidebar-collapsed');
                } else {
                    document.body.classList.remove('sidebar-collapsed');
                }
                isLeftOpen = !isLeftOpen;
            }
        }

        function togglePromptsSection() {
            isPromptsOpen = !isPromptsOpen;
            const body = document.getElementById('prompts-body');
            const icon = document.getElementById('prompts-toggle-icon');
            if (body) body.classList.toggle('hidden', !isPromptsOpen);
            if (icon) icon.classList.toggle('rotate-180', isPromptsOpen);
        }

        function toggleSnippetsSection() {
            isSnippetsOpen = !isSnippetsOpen;
            const body = document.getElementById('snippets-body');
            const icon = document.getElementById('snippets-toggle-icon');
            if (body) body.classList.toggle('hidden', !isSnippetsOpen);
            if (icon) icon.classList.toggle('rotate-180', isSnippetsOpen);
        }

        function toggleSettingsMenu(ev) {
            if (ev) ev.stopPropagation();
            const menu = document.getElementById('settings-nav-menu');
            const target = ev?.currentTarget;
            if (!menu || !target) return;

            if (settingsMenuOpen) {
                closeSettingsMenu();
                return;
            }

            if (snippetMenuOpen) closeSnippetItemMenu();
            if (promptMenuOpen) closePromptItemMenu();
            if (manageSnippetMenuOpen) closeManageSnippetMenu();
            if (savePromptCategoryMenuOpen) closeSavePromptCategoryMenu();
            if (manageCategoryMenuOpen) closeManageCategoryMenu();

            menu.classList.remove('hidden');
            const rect = target.getBoundingClientRect();
            const menuWidth = menu.offsetWidth || 220;
            const menuHeight = menu.offsetHeight || 120;
            const maxLeft = Math.max(8, window.innerWidth - menuWidth - 8);
            const maxTop = Math.max(8, window.innerHeight - menuHeight - 8);
            const left = Math.min(rect.right + 10, maxLeft);
            const top = Math.min(rect.top, maxTop);
            menu.style.left = left + 'px';
            menu.style.top = top + 'px';
            settingsMenuOpen = true;
            menu.onclick = (e) => e.stopPropagation();
        }

        function closeSettingsMenu() {
            const menu = document.getElementById('settings-nav-menu');
            if (menu) menu.classList.add('hidden');
            settingsMenuOpen = false;
        }

        function renderSettingsPage() {
            const titleEl = document.getElementById('settings-title');
            const contentEl = document.getElementById('settings-content');
            const actionEl = document.getElementById('settings-header-action');
            const map = {
                categories: 'Kategorien verwalten',
                snippets: 'Bausteine verwalten',
                help: 'Hilfe',
                import: 'Import & Export'
            };
            const title = map[settingsCurrentPage] || 'Einstellungen & Hilfe';
            if (titleEl) titleEl.textContent = title;
            if (actionEl) {
                if (settingsCurrentPage === 'categories') {
                    actionEl.innerHTML = `
                        <button onclick="openPromptCategoryModal()" class="flex items-center gap-2 p-2 rounded-md cursor-pointer hover:bg-slate-800/50">
                            <span class="text-brand-sky text-sm font-medium">Kategorie anlegen</span>
                        </button>
                    `;
                } else {
                    actionEl.innerHTML = '';
                }
            }
            if (contentEl) {
                if (settingsCurrentPage === 'categories') {
                    contentEl.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Lade...</div>';
                    loadManageCategoriesPage();
                    return;
                }
                if (settingsCurrentPage === 'snippets') {
                    contentEl.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Lade...</div>';
                    loadManageSnippetsPage();
                    return;
                }
                if (settingsCurrentPage === 'help') {
                    contentEl.innerHTML = `
                        <section class="help-doc space-y-6 text-slate-300 leading-relaxed">

                          <h2 class="text-2xl font-bold text-white">Hilfe: Promptomizer Beta</h2>
                          <p>
                            Der Promptomizer hilft dir, Prompts sauber aufzubauen, wiederzuverwenden und zu organisieren.
                            Du arbeitest in drei Hauptbereichen: <strong>Editor</strong>, <strong>Historie</strong> und <strong>Einstellungen &amp; Hilfe</strong>.
                          </p>

                          <hr class="border-navy-border" />

                          <h2 class="text-xl font-bold text-white">Schnellstart (in 60 Sekunden)</h2>
                          <ol class="list-decimal pl-6 space-y-2">
                            <li>Öffne den <strong>Editor</strong>.</li>
                            <li>Wähle oben den Modus: <strong>Strukturiert</strong> (empfohlen) oder <strong>Frei</strong>.</li>
                            <li>Fülle die Felder aus (z. B. Rolle, Kontext, Aufgabe, Format).</li>
                            <li>Klicke auf <strong>Kopieren</strong>, um den fertigen Prompt in die Zwischenablage zu kopieren.</li>
                            <li>Optional: Klicke auf <strong>Prompt speichern</strong>, um ihn mit Namen (und Kategorie) abzulegen.</li>
                          </ol>

                          <hr class="border-navy-border" />

                          <h2 class="text-xl font-bold text-white">1) Modus wählen: „Strukturiert“ oder „Frei“</h2>

                          <h3 class="text-lg font-semibold text-white">Strukturiert (empfohlen)</h3>
                          <p>
                            Du baust deinen Prompt Feld für Feld auf. Das ist ideal für Einsteiger, weil nichts Wichtiges vergessen wird.
                          </p>
                          <ul class="list-disc pl-6 space-y-2">
                            <li><strong>Rolle &amp; Funktion</strong>: Wer soll die KI sein und was ist ihre Aufgabe? (z. B. „Du bist …“)</li>
                            <li><strong>Kontext</strong>: Worum geht es, welche Rahmenbedingungen sind wichtig?</li>
                            <li><strong>Aufgabe</strong>: Was soll die KI konkret tun?</li>
                            <li><strong>Format</strong>: Wie soll die Ausgabe aussehen? (z. B. Liste, Tabelle, Schritte, Länge)</li>
                          </ul>

                          <h3 class="text-lg font-semibold text-white">Frei</h3>
                          <p>
                            Du schreibst den Prompt als Fließtext. Das ist praktisch, wenn du schon weißt, was du tust,
                            oder wenn du sehr eigene Strukturen nutzen willst.
                          </p>

                          <hr class="border-navy-border" />

                          <h2 class="text-xl font-bold text-white">2) Editor: Prompt erstellen</h2>
                          <p>
                            Im <strong>Editor</strong> schreibst du deinen Prompt. Unten findest du wichtige Aktionen:
                          </p>
                          <ul class="list-disc pl-6 space-y-2">
                            <li><strong>Kopieren</strong>: Kopiert den aktuellen Prompt in die Zwischenablage (zum Einfügen in ChatGPT &amp; Co.).</li>
                            <li>
                              <strong>Reset</strong>: Setzt den aktuellen Inhalt im Editor zurück.
                              Du wirst vorher gefragt („Wirklich alles leeren?“).
                            </li>
                            <li><strong>Prompt speichern</strong>: Speichert den Prompt in deiner Bibliothek (siehe nächster Abschnitt).</li>
                          </ul>

                          <h3 class="text-lg font-semibold text-white">Tipp</h3>
                          <p>
                            Arbeite im strukturierten Modus am besten von oben nach unten:
                            Rolle → Kontext → Aufgabe → Format. Das sorgt für klare, stabile Ergebnisse.
                          </p>

                          <hr class="border-navy-border" />

                          <h2 class="text-xl font-bold text-white">3) Prompts (Bibliothek): speichern &amp; wiederfinden</h2>
                          <p>
                            Im Bereich <strong>Prompts</strong> verwaltest du deine gespeicherten Prompts.
                          </p>

                          <h3 class="text-lg font-semibold text-white">Prompt speichern</h3>
                          <ol class="list-decimal pl-6 space-y-2">
                            <li>Klicke auf <strong>Prompt speichern</strong>.</li>
                            <li>Gib einen <strong>Namen</strong> ein (damit du ihn später schnell erkennst).</li>
                            <li>Optional: Wähle eine <strong>Kategorie</strong> (oder „Ohne Kategorie“).</li>
                            <li>Optional: Klicke auf <strong>Kategorie anlegen</strong>, wenn du eine neue Kategorie brauchst.</li>
                            <li>Klicke auf <strong>Speichern</strong>.</li>
                          </ol>

                          <h3 class="text-lg font-semibold text-white">Gespeicherte Prompts verwalten</h3>
                          <ul class="list-disc pl-6 space-y-2">
                            <li><strong>Löschen</strong>: Entfernt einen Prompt (mit Sicherheitsabfrage).</li>
                            <li><strong>Bearbeiten</strong>: Wenn verfügbar, kannst du Prompt-Daten anpassen.</li>
                          </ul>

                          <hr class="border-navy-border" />

                          <h2 class="text-xl font-bold text-white">4) Historie: Verlauf deiner Prompts</h2>
                          <p>
                            In der <strong>Historie</strong> findest du deine zuletzt erstellten bzw. genutzten Prompts.
                            Das ist praktisch, wenn du etwas schnell wieder brauchst.
                          </p>
                          <ul class="list-disc pl-6 space-y-2">
                            <li><strong>Löschen</strong>: Entfernt einen Eintrag (mit Sicherheitsabfrage).</li>
                            <li><strong>Bearbeiten</strong>: Wenn verfügbar, kannst du Einträge anpassen.</li>
                          </ul>

                          <hr class="border-navy-border" />

                          <h2 class="text-xl font-bold text-white">5) Bausteine: Textbausteine zum schnellen Einfügen</h2>
                          <p>
                            <strong>Bausteine</strong> sind wiederverwendbare Textstücke (z. B. Standard-Rollen, typische Formatvorgaben).
                            Sie lassen sich per Klick in den Editor einfügen.
                          </p>

                          <h3 class="text-lg font-semibold text-white">So nutzt du Bausteine</h3>
                          <ol class="list-decimal pl-6 space-y-2">
                            <li>Wähle zuerst ein Feld im Editor aus (z. B. „Kontext“).</li>
                            <li>Öffne den Bereich <strong>Bausteine</strong>.</li>
                            <li>Klicke auf einen Baustein, um ihn in das aktuell aktive Feld einzufügen.</li>
                          </ol>

                          <h3 class="text-lg font-semibold text-white">Neuen Baustein anlegen</h3>
                          <ol class="list-decimal pl-6 space-y-2">
                            <li>Klicke auf <strong>Neuer Baustein</strong>.</li>
                            <li>Vergib einen <strong>Namen</strong> (z. B. „Tabellen-Format kurz“).</li>
                            <li>Wähle die passende <strong>Kategorie</strong> (Rolle &amp; Funktion / Kontext / Aufgabe / Format / Freie Bausteine).</li>
                            <li>Füge den <strong>Baustein-Text</strong> ein.</li>
                            <li>Klicke auf <strong>Speichern</strong>.</li>
                          </ol>

                          <h3 class="text-lg font-semibold text-white">Bausteine verwalten</h3>
                          <ul class="list-disc pl-6 space-y-2">
                            <li><strong>Bearbeiten</strong>: Text oder Name ändern.</li>
                            <li><strong>Löschen</strong>: Entfernen (mit Sicherheitsabfrage).</li>
                          </ul>

                          <hr class="border-navy-border" />

                          <h2 class="text-xl font-bold text-white">6) Kategorien verwalten</h2>
                          <p>
                            Kategorien helfen dir, gespeicherte Prompts zu sortieren.
                          </p>

                          <h3 class="text-lg font-semibold text-white">Kategorie anlegen</h3>
                          <ol class="list-decimal pl-6 space-y-2">
                            <li>Öffne <strong>Einstellungen &amp; Hilfe</strong> → <strong>Kategorien verwalten</strong>.</li>
                            <li>Klicke auf <strong>Kategorie anlegen</strong>.</li>
                            <li>Name eingeben → <strong>Speichern</strong>.</li>
                          </ol>

                          <h3 class="text-lg font-semibold text-white">Kategorie umbenennen</h3>
                          <ol class="list-decimal pl-6 space-y-2">
                            <li>In <strong>Kategorien verwalten</strong> auf <strong>Umbenennen</strong> klicken.</li>
                            <li>Neuen Namen eingeben → <strong>Speichern</strong>.</li>
                          </ol>

                          <h3 class="text-lg font-semibold text-white">Kategorie löschen</h3>
                          <p>
                            Wenn du eine Kategorie löschst, werden die Prompts darin <strong>nicht</strong> gelöscht.
                            Sie erscheinen danach unter <strong>„Ohne Kategorie“</strong>.
                          </p>
                          <ol class="list-decimal pl-6 space-y-2">
                            <li>In <strong>Kategorien verwalten</strong> auf <strong>Löschen</strong> klicken.</li>
                            <li>Sicherheitsabfrage bestätigen.</li>
                          </ol>

                          <hr class="border-navy-border" />

                          <h2 class="text-xl font-bold text-white">7) Login</h2>
                          <p>
                            Du kannst den Promptomizer als <strong>Gast</strong> testen. Für dauerhaftes Speichern ist ein Login sinnvoll.
                          </p>
                          <ul class="list-disc pl-6 space-y-2">
                            <li><strong>E-Mail &amp; Passwort</strong>: Einloggen über das Login-Formular.</li>
                            <li><strong>Angemeldet bleiben</strong>: Wenn aktiviert, bleibst du eingeloggt.</li>
                            <li><strong>Google Login</strong>: Alternativ per Google anmelden.</li>
                          </ul>

                          <hr class="border-navy-border" />

                          <h2 class="text-xl font-bold text-white">FAQ</h2>

                          <details class="border border-navy-border rounded-md p-4 bg-slate-900/30">
                            <summary class="cursor-pointer text-slate-200"><strong>Warum passiert bei „Reset“ nichts?</strong></summary>
                            <p class="mt-2">
                              Beim Reset kommt eine Sicherheitsabfrage („Wirklich alles leeren?“).
                              Du musst dort bestätigen, sonst bleibt der Inhalt erhalten.
                            </p>
                          </details>

                          <details class="border border-navy-border rounded-md p-4 bg-slate-900/30">
                            <summary class="cursor-pointer text-slate-200"><strong>Wo sind meine Prompts nach dem Löschen einer Kategorie?</strong></summary>
                            <p class="mt-2">
                              Deine Prompts werden nicht gelöscht. Sie werden automatisch nach <strong>„Ohne Kategorie“</strong> verschoben.
                            </p>
                          </details>

                          <details class="border border-navy-border rounded-md p-4 bg-slate-900/30">
                            <summary class="cursor-pointer text-slate-200"><strong>Wie nutze ich Bausteine richtig?</strong></summary>
                            <p class="mt-2">
                              Wähle zuerst ein Feld im Editor aus. Erst dann lassen sich Bausteine gezielt in dieses Feld einfügen.
                            </p>
                          </details>

                        </section>
                    `;
                    return;
                }
                contentEl.innerHTML = '<div class="text-center text-slate-500 py-10">Inhalte folgen.</div>';
            }
        }

        function openSettingsPage(pageKey) {
            settingsCurrentPage = pageKey || 'categories';
            renderSettingsPage();
            closeSettingsMenu();
            switchView('settings');
        }
        function manageCategoryStateKey(name) {
            const normalized = normalizeCategoryName(name);
            return normalized ? normalized : '__uncat__';
        }

        async function loadManageCategoriesPage() {
            const contentEl = document.getElementById('settings-content');
            if (!contentEl) return;

            if (!window.currentUser) {
                contentEl.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Bitte einloggen, um Kategorien zu verwalten.</div>';
                return;
            }

            if (!window.db) {
                contentEl.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Datenbank nicht verfügbar.</div>';
                return;
            }

            manageCategoriesCache = window.db.getPromptCategories ? await window.db.getPromptCategories() : [];
            managePromptsCache = window.db.getScenarios ? await window.db.getScenarios() : [];

            renderManageCategoriesAccordion();
        }

        function renderManageCategoriesAccordion() {
            const container = document.getElementById('settings-content');
            if (!container) return;

            const categories = [
                { id: null, name: '', label: 'Ohne Kategorie', isPseudo: true },
                ...(manageCategoriesCache || []).map(c => ({ id: c.id, name: c.name, label: c.name, isPseudo: false }))
            ];

            if (!categories.length) {
                container.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Keine Kategorien.</div>';
                return;
            }

            container.innerHTML = categories.map(cat => {
                const key = manageCategoryStateKey(cat.name);
                if (manageCategoryOpenState[key] === undefined) manageCategoryOpenState[key] = false;

                const catName = normalizeCategoryName(cat.name);
                const filtered = (managePromptsCache || []).filter(p => {
                    const normalized = normalizeCategoryName(p.category);
                    if (!catName) return !normalized;
                    return normalized === catName;
                });

                const catKey = categoryKeyFromName(catName);
                const promptList = filtered.length ? `
                    <div class="space-y-0.5">
                        ${filtered.map(p => `
                            <div id="manage-prompt-${p.id}" class="group w-full py-1 px-1 rounded hover:bg-slate-800/50 cursor-pointer transition-colors" onclick="handlePromptClick(${p.id})">
                                <div class="flex items-center justify-between w-full">
                                    <div class="text-sm text-slate-300 group-hover:text-white truncate leading-tight min-w-0 flex-1" title=${JSON.stringify(p.name || '')}>${p.name}</div>
                                    <button class="p-1 rounded hover:bg-slate-800 text-slate-400 hover:text-white leading-none flex-none" onclick="openPromptItemMenu(event, '${catKey}', ${p.id})">
                                        <i class="fa-solid fa-ellipsis"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : '<div class="text-xs text-slate-600 italic py-2 pl-1">Keine Prompts.</div>';

                const menuButton = cat.isPseudo ? '' : `
                    <button type="button" class="p-1 rounded hover:bg-slate-800 text-slate-400 hover:text-white leading-none flex-none" onclick='return openManageCategoryMenu(event, ${JSON.stringify(cat.id)}, ${JSON.stringify(cat.name)})'>
                        <i class="fa-solid fa-ellipsis"></i>
                    </button>
                `;

                return `                    <div>
                        <div class="group w-full flex items-center justify-between p-2 text-left hover:bg-slate-800/50 rounded cursor-pointer" role="button" tabindex="0" onclick="toggleManageCategory('${key}')">
                            <div class="flex items-center gap-2 min-w-0 flex-1">
                                <i class="fa-regular fa-folder text-sm text-slate-400 group-hover:text-slate-200 transition-colors"></i>
                                <span class="truncate text-sm font-bold text-slate-300">${cat.label}</span>
                            </div>
                            <div class="flex items-center gap-2 shrink-0">
                                ${menuButton}
                                <i id="manage-cat-icon-${key}" class="fa-solid fa-chevron-down text-xs transition-transform ${manageCategoryOpenState[key] ? 'rotate-180' : ''}"></i>
                            </div>
                        </div>
                        <div id="manage-cat-body-${key}" class="${manageCategoryOpenState[key] ? '' : 'hidden'} pl-8 pr-0 pb-2">
                            ${promptList}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleManageCategory(key) {
            const body = document.getElementById(`manage-cat-body-${key}`);
            const icon = document.getElementById(`manage-cat-icon-${key}`);
            if (!body) return;

            manageCategoryOpenState[key] = !manageCategoryOpenState[key];
            body.classList.toggle('hidden', !manageCategoryOpenState[key]);
            if (icon) icon.classList.toggle('rotate-180', manageCategoryOpenState[key]);
        }

        async function loadManageSnippetsPage() {
            const contentEl = document.getElementById('settings-content');
            if (!contentEl) return;

            if (!window.currentUser) {
                contentEl.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Bitte einloggen, um Bausteine zu verwalten.</div>';
                return;
            }

            if (!window.db || !window.db.getSnippets) {
                contentEl.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Datenbank nicht verfügbar.</div>';
                return;
            }

            manageSnippetsCacheByCat = {};
            manageSnippetCacheById = {};

            for (const cat of SNIPPET_CATEGORIES) {
                if (manageSnippetsOpenState[cat.id] === undefined) manageSnippetsOpenState[cat.id] = false;
                const rows = await window.db.getSnippets({ mode: cat.mode, fieldId: cat.id });
                const list = Array.isArray(rows) ? rows : [];
                manageSnippetsCacheByCat[cat.id] = list;
                list.forEach(s => { manageSnippetCacheById[s.id] = s; });
            }

            renderManageSnippetsAccordion();
        }

        function renderManageSnippetsAccordion() {
            const container = document.getElementById('settings-content');
            if (!container) return;

            container.innerHTML = SNIPPET_CATEGORIES.map(cat => {
                if (manageSnippetsOpenState[cat.id] === undefined) manageSnippetsOpenState[cat.id] = false;
                const snippets = manageSnippetsCacheByCat[cat.id] || [];
                const snippetList = snippets.length ? `
                    <div class="space-y-0.5">
                        ${snippets.map(snippet => {
                    manageSnippetCacheById[snippet.id] = snippet;
                    return `
                                <div id="manage-snippet-${snippet.id}" class="group w-full py-1 px-1 rounded hover:bg-slate-800/50 transition-colors">
                                    <div class="flex items-center justify-between w-full">
                                        <div class="text-sm text-slate-300 group-hover:text-white truncate leading-tight min-w-0 flex-1" title=${JSON.stringify(snippet.name || '')}>${snippet.name}</div>
                                        <button class="p-1 rounded hover:bg-slate-800 text-slate-400 hover:text-white leading-none flex-none" onclick="openManageSnippetMenu(event, '${cat.id}', ${snippet.id})">
                                            <i class="fa-solid fa-ellipsis"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                }).join('')}
                    </div>
                ` : '<div class="text-xs text-slate-600 italic py-2 pl-1">Keine Bausteine.</div>';

                return `                    <div>
                        <div class="group w-full flex items-center justify-between p-2 text-left hover:bg-slate-800/50 rounded cursor-pointer" role="button" tabindex="0" onclick="toggleManageSnippetCategory('${cat.id}')">
                            <div class="flex items-center gap-2 min-w-0 flex-1">
                                <i class="fa-regular fa-folder text-sm text-slate-400 group-hover:text-slate-200 transition-colors"></i>
                                <span class="truncate text-sm font-bold text-slate-300">${cat.label}</span>
                            </div>
                            <i id="manage-snippet-icon-${cat.id}" class="fa-solid fa-chevron-down text-xs transition-transform ${manageSnippetsOpenState[cat.id] ? 'rotate-180' : ''}"></i>
                        </div>
                        <div id="manage-snippet-body-${cat.id}" class="${manageSnippetsOpenState[cat.id] ? '' : 'hidden'} pl-8 pr-0 pb-2">
                            ${snippetList}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleManageSnippetCategory(catId) {
            const body = document.getElementById(`manage-snippet-body-${catId}`);
            const icon = document.getElementById(`manage-snippet-icon-${catId}`);
            if (!body) return;

            manageSnippetsOpenState[catId] = !manageSnippetsOpenState[catId];
            body.classList.toggle('hidden', !manageSnippetsOpenState[catId]);
            if (icon) icon.classList.toggle('rotate-180', manageSnippetsOpenState[catId]);
        }

        async function refreshManageSnippetCategory(catId) {
            const cat = SNIPPET_CATEGORIES.find(c => c.id === catId);
            if (!cat || !window.db || !window.db.getSnippets) return;
            const rows = await window.db.getSnippets({ mode: cat.mode, fieldId: cat.id });
            const list = Array.isArray(rows) ? rows : [];
            manageSnippetsCacheByCat[cat.id] = list;
            list.forEach(s => { manageSnippetCacheById[s.id] = s; });
        }

        function openManageSnippetMenu(ev, catId, snippetId) {
            const e = ev || window.event;
            if (e) {
                if (e.stopPropagation) e.stopPropagation();
                if (e.preventDefault) e.preventDefault();
                if (e.stopImmediatePropagation) e.stopImmediatePropagation();
            }
            const menu = document.getElementById('manage-snippet-menu');
            if (!menu) return false;

            if (snippetMenuOpen) closeSnippetItemMenu();
            if (promptMenuOpen) closePromptItemMenu();
            if (manageCategoryMenuOpen) closeManageCategoryMenu();
            if (settingsMenuOpen) closeSettingsMenu();
            if (manageSnippetMenuOpen) closeManageSnippetMenu();

            manageSnippetMenuSnippetId = snippetId;
            manageSnippetMenuCategoryId = catId;

            const submenu = document.getElementById('manage-snippet-target-submenu');
            if (submenu) submenu.classList.add('hidden');
            const list = document.getElementById('manage-snippet-target-submenu-list');
            if (list) list.innerHTML = '<div class="px-3 py-2 text-xs text-slate-500 italic">Lade…</div>';

            menu.classList.remove('hidden');
            const target = e && e.currentTarget ? e.currentTarget : null;
            const positionMenu = (attempt = 0) => {
                if (!target) return;
                const rect = target.getBoundingClientRect();
                const menuWidth = menu.offsetWidth;
                const menuHeight = menu.offsetHeight;
                if ((!menuWidth || !menuHeight) && attempt < 2) {
                    requestAnimationFrame(() => positionMenu(attempt + 1));
                    return;
                }
                if (!menuWidth || !menuHeight) return;

                let left = rect.right - menuWidth;
                let top = rect.bottom + 6;

                if (rect.bottom + menuHeight + 8 > window.innerHeight && rect.top - menuHeight - 6 >= 8) {
                    top = rect.top - menuHeight - 6;
                }

                const maxLeft = window.innerWidth - menuWidth - 8;
                const maxTop = window.innerHeight - menuHeight - 8;
                left = Math.min(Math.max(8, left), Math.max(8, maxLeft));
                top = Math.min(Math.max(8, top), Math.max(8, maxTop));

                menu.style.left = left + 'px';
                menu.style.top = top + 'px';
            };
            requestAnimationFrame(() => positionMenu());
            manageSnippetMenuOpen = true;
            menu.onclick = (evt) => evt.stopPropagation();
            return false;
        }

        function closeManageSnippetMenu() {
            const menu = document.getElementById('manage-snippet-menu');
            const submenu = document.getElementById('manage-snippet-target-submenu');
            if (menu) menu.classList.add('hidden');
            if (submenu) submenu.classList.add('hidden');
            manageSnippetMenuOpen = false;
            manageSnippetMenuSnippetId = null;
            manageSnippetMenuCategoryId = null;
        }

        function openManageSnippetTargetSubmenu() {
            const menu = document.getElementById('manage-snippet-target-submenu');
            const list = document.getElementById('manage-snippet-target-submenu-list');
            const trigger = document.getElementById('manage-snippet-target-trigger');
            if (!menu || !list || !trigger) return;

            const items = SNIPPET_CATEGORIES.map(cat => `
                <button class="w-full px-4 py-2 text-left text-sm text-slate-200 hover:bg-slate-800/60 truncate"
                        title=${JSON.stringify(cat.label)}
                        onclick="selectManageSnippetTarget(event, '${cat.id}')">
                    ${escapeHtml(cat.label)}
                </button>
            `);
            list.innerHTML = items.join('');

            menu.classList.remove('hidden');
            menu.onclick = (evt) => evt.stopPropagation();

            requestAnimationFrame(() => {
                const rect = trigger.getBoundingClientRect();
                const menuWidth = menu.offsetWidth;
                const menuHeight = menu.offsetHeight;

                let left = rect.right + 8;
                let top = rect.top;

                if (rect.top + menuHeight + 8 > window.innerHeight && rect.bottom - menuHeight >= 8) {
                    top = rect.bottom - menuHeight;
                }

                const maxLeft = window.innerWidth - menuWidth - 8;
                const maxTop = window.innerHeight - menuHeight - 8;
                left = Math.min(Math.max(8, left), Math.max(8, maxLeft));
                top = Math.min(Math.max(8, top), Math.max(8, maxTop));

                menu.style.left = left + 'px';
                menu.style.top = top + 'px';
            });
        }

        function handleManageSnippetEdit() {
            const id = manageSnippetMenuSnippetId;
            const categoryId = manageSnippetMenuCategoryId;
            const snippet = manageSnippetCacheById[id];
            closeManageSnippetMenu();
            if (!snippet) return;
            openSnippetModalForEdit(categoryId, snippet);
        }

        function handleManageSnippetDelete() {
            const categoryId = manageSnippetMenuCategoryId;
            const snippetId = manageSnippetMenuSnippetId;
            closeManageSnippetMenu();
            openDeleteSnippetModal(categoryId, snippetId);
        }

        async function selectManageSnippetTarget(ev, targetCatId) {
            try {
                const e = ev || window.event;
                if (e && e.stopPropagation) e.stopPropagation();
            } catch (_) { }

            const snippetId = manageSnippetMenuSnippetId;
            const oldCatId = manageSnippetMenuCategoryId;
            if (!snippetId) return;

            if (!window.db || !window.db.updateSnippet) {
                console.error('window.db.updateSnippet fehlt');
                return;
            }

            const patch = targetCatId === 'free'
                ? { mode: 'free', field_id: 'free' }
                : { mode: 'structured', field_id: targetCatId };

            try {
                const ok = await window.db.updateSnippet(snippetId, patch);
                if (!ok) {
                    alert('Baustein konnte nicht verschoben werden.');
                    return;
                }
            } catch (err) {
                console.error('Baustein Update Fehler:', err);
                alert('Baustein konnte nicht verschoben werden. Bitte Konsole prüfen.');
                return;
            }

            await refreshManageSnippetCategory(oldCatId);
            if (oldCatId !== targetCatId) await refreshManageSnippetCategory(targetCatId);

            renderManageSnippetsAccordion();
            closeManageSnippetMenu();

            if (oldCatId) {
                const oldBody = document.getElementById(`snip-body-${oldCatId}`);
                if (oldBody) oldBody.dataset.loaded = 'false';
                if (snippetOpenState[oldCatId]) await loadSnippetSection(oldCatId);
            }
            const newBody = document.getElementById(`snip-body-${targetCatId}`);
            if (newBody) newBody.dataset.loaded = 'false';
            if (snippetOpenState[targetCatId]) await loadSnippetSection(targetCatId);
        }
        function openManageCategoryMenu(ev, categoryId, categoryName) {
            const e = ev || window.event;
            if (e) {
                if (e.stopPropagation) e.stopPropagation();
                if (e.preventDefault) e.preventDefault();
                if (e.stopImmediatePropagation) e.stopImmediatePropagation();
            }
            const menu = document.getElementById('manage-category-menu');
            if (!menu) return false;

            if (snippetMenuOpen) closeSnippetItemMenu();
            if (promptMenuOpen) closePromptItemMenu();
            if (manageSnippetMenuOpen) closeManageSnippetMenu();
            if (savePromptCategoryMenuOpen) closeSavePromptCategoryMenu();
            if (settingsMenuOpen) closeSettingsMenu();

            manageCategoryMenuId = categoryId;
            manageCategoryMenuName = categoryName || '';

            menu.classList.remove('hidden');
            const target = e && e.currentTarget ? e.currentTarget : null;
            const positionMenu = (attempt = 0) => {
                if (!target) return;
                const rect = target.getBoundingClientRect();
                const menuWidth = menu.offsetWidth;
                const menuHeight = menu.offsetHeight;
                if ((!menuWidth || !menuHeight) && attempt < 2) {
                    requestAnimationFrame(() => positionMenu(attempt + 1));
                    return;
                }
                if (!menuWidth || !menuHeight) return;

                let left = rect.right - menuWidth;
                let top = rect.bottom + 6;

                if (rect.bottom + menuHeight + 8 > window.innerHeight && rect.top - menuHeight - 6 >= 8) {
                    top = rect.top - menuHeight - 6;
                }

                const maxLeft = window.innerWidth - menuWidth - 8;
                const maxTop = window.innerHeight - menuHeight - 8;
                left = Math.min(Math.max(8, left), Math.max(8, maxLeft));
                top = Math.min(Math.max(8, top), Math.max(8, maxTop));

                menu.style.left = left + 'px';
                menu.style.top = top + 'px';
            };
            requestAnimationFrame(() => positionMenu());
            manageCategoryMenuOpen = true;
            menu.onclick = (evt) => evt.stopPropagation();
            return false;
        }

        function closeManageCategoryMenu() {
            const menu = document.getElementById('manage-category-menu');
            if (menu) menu.classList.add('hidden');
            manageCategoryMenuOpen = false;
            manageCategoryMenuId = null;
            manageCategoryMenuName = '';
        }

        function handleManageCategoryRename() {
            const id = manageCategoryMenuId;
            const name = manageCategoryMenuName;
            closeManageCategoryMenu();
            openManageCategoryRenameModal(id, name);
        }

        function handleManageCategoryDelete() {
            const id = manageCategoryMenuId;
            const name = manageCategoryMenuName;
            closeManageCategoryMenu();
            openManageCategoryDeleteModal(id, name);
        }

        function openManageCategoryRenameModal(categoryId, categoryName) {
            pendingRenameCategoryId = categoryId;
            pendingRenameCategoryName = categoryName || '';
            const modal = document.getElementById('modal-category-rename');
            const input = document.getElementById('rename-category-name');
            if (input) input.value = pendingRenameCategoryName;
            if (modal) modal.classList.remove('hidden');
            setTimeout(() => { if (input) input.focus(); }, 50);
        }

        function closeRenameCategoryModal() {
            const modal = document.getElementById('modal-category-rename');
            if (modal) modal.classList.add('hidden');
            pendingRenameCategoryId = null;
            pendingRenameCategoryName = '';
        }

        async function confirmRenameCategory() {
            const id = pendingRenameCategoryId;
            const oldName = (pendingRenameCategoryName || '').trim();
            const input = document.getElementById('rename-category-name');
            const newName = (input?.value || '').trim();

            if (!id) {
                closeRenameCategoryModal();
                return;
            }

            if (!newName) {
                alert('Bitte einen Namen eingeben.');
                return;
            }

            if (normalizeCategoryName(newName).toLowerCase() === normalizeCategoryName(oldName).toLowerCase()) {
                closeRenameCategoryModal();
                return;
            }

            const exists = (manageCategoriesCache || []).some(c => {
                const n = normalizeCategoryName(c.name).toLowerCase();
                return n === normalizeCategoryName(newName).toLowerCase() && c.id !== id;
            });

            if (exists) {
                alert('Kategorie existiert bereits.');
                return;
            }

            if (!window.db || !window.db.renamePromptCategory) {
                console.error('window.db.renamePromptCategory fehlt');
                return;
            }

            const ok = await window.db.renamePromptCategory(id, oldName, newName);
            if (!ok) {
                alert('Kategorie konnte nicht umbenannt werden. Bitte Konsole prüfen.');
                return;
            }

            closeRenameCategoryModal();
            await refreshPromptLibraryAndCategories();
            await loadManageCategoriesPage();
        }

        function openManageCategoryDeleteModal(categoryId, categoryName) {
            pendingDeleteManageCategoryId = categoryId;
            pendingDeleteManageCategoryName = categoryName || '';
            const modal = document.getElementById('modal-category-delete');
            if (modal) modal.classList.remove('hidden');
        }

        function closeDeleteCategoryModal() {
            const modal = document.getElementById('modal-category-delete');
            if (modal) modal.classList.add('hidden');
            pendingDeleteManageCategoryId = null;
            pendingDeleteManageCategoryName = '';
        }

        async function confirmDeleteCategory() {
            const id = pendingDeleteManageCategoryId;
            const name = (pendingDeleteManageCategoryName || '').trim();

            if (!id) {
                closeDeleteCategoryModal();
                return;
            }

            if (!window.db || !window.db.deletePromptCategory) {
                console.error('window.db.deletePromptCategory fehlt');
                return;
            }

            const ok = await window.db.deletePromptCategory(id, name);
            if (!ok) {
                alert('Kategorie konnte nicht gelöscht werden. Bitte Konsole prüfen.');
                return;
            }

            closeDeleteCategoryModal();
            await refreshPromptLibraryAndCategories();
            await loadManageCategoriesPage();
        }

        async function updateKontoView() {
            const nameEl = document.getElementById('konto-user-name');
            const emailEl = document.getElementById('konto-user-email');
            const planEl = document.getElementById('konto-plan-name');

            if (window.currentUser) {
                nameEl.innerText = window.currentUser.email.split('@')[0];
                emailEl.innerText = window.currentUser.email;
                planEl.innerText = 'Pro Plan';
            } else {
                nameEl.innerText = 'Gast';
                emailEl.innerText = 'Nicht eingeloggt';
                planEl.innerText = 'Free Plan';
            }

            // Load legal texts if not already loaded
            if (!document.getElementById('content-impressum').innerHTML.trim()) {
                await loadLegalContent();
            }
        }

        async function loadLegalContent(specificKey = null) {
            const legalFiles = {
                impressum: 'Impressum.md',
                datenschutz: 'Datenschutzerklaerung.md',
                agb: 'AGB.md'
            };

            const keysToLoad = specificKey ? [specificKey] : Object.keys(legalFiles);

            for (const key of keysToLoad) {
                const filename = legalFiles[key];
                const container = document.getElementById(`content-${key}`);
                if (!container || (container.innerHTML.trim() && !container.innerText.includes('Fehler'))) continue;

                try {
                    const response = await fetch(filename);
                    if (response.ok) {
                        const markdown = await response.text();
                        container.innerHTML = simpleMarkdownToHtml(markdown);
                    } else {
                        console.error(`Status ${response.status} beim Laden von ${filename}`);
                        container.innerHTML = `<div class="p-4 bg-red-50 border border-red-200 rounded text-red-600 text-sm">
                            <strong>Fehler beim Laden:</strong> ${filename} wurde nicht gefunden (Status: ${response.status}).<br>
                            Erscheint diese Meldung auf dem Live-Server? Prüfen Sie, ob die Datei im Ordner vorhanden ist.
                        </div>`;
                    }
                } catch (e) {
                    console.error(`Netzwerkfehler beim Laden von ${filename}:`, e);
                    container.innerHTML = `<div class="p-4 bg-red-50 border border-red-200 rounded text-red-600 text-sm">
                            <strong>Netzwerkfehler:</strong> Die Datei ${filename} konnte nicht geladen werden.<br>
                            Falls Sie die Datei direkt im Browser öffnen (ohne Server), erlaubt der Browser keinen Zugriff auf lokale Dateien (CORS). Nutzen Sie bitte "Live Server".
                        </div>`;
                }
            }
        }

        function simpleMarkdownToHtml(md) {
            if (!md) return '';
            return md
                .replace(/^# (.*$)/gm, '<h1 class="text-3xl font-bold mb-6">$1</h1>')
                .replace(/^## (.*$)/gm, '<h2 class="text-2xl font-bold mt-8 mb-4">$1</h2>')
                .replace(/^### (.*$)/gm, '<h3 class="text-xl font-bold mt-6 mb-3">$1</h3>')
                .replace(/^\* (.*$)/gm, '<li class="ml-4 list-disc">$1</li>')
                .replace(/^- (.*$)/gm, '<li class="ml-4 list-disc">$1</li>')
                .replace(/^\d\. (.*$)/gm, '<li class="ml-4 list-decimal">$1</li>')
                .replace(/\*\*(.*)\*\*/gm, '<strong>$1</strong>')
                .replace(/\*(.*)\*/gm, '<em>$1</em>')
                .replace(/^> (.*$)/gm, '<blockquote class="border-l-4 border-slate-200 pl-4 italic my-4">$1</blockquote>')
                .replace(/\n\n/g, '</p><p class="mb-4">')
                .replace(/\n/g, '<br>');
        }

        function switchView(viewId) {
            const legalViews = ['impressum', 'datenschutz', 'agb'];
            if (legalViews.includes(viewId)) {
                loadLegalContent(viewId);
            }

            ['view-editor', 'view-history', 'view-settings', 'view-konto', 'view-impressum', 'view-datenschutz', 'view-agb'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            document.getElementById(`view-${viewId}`).classList.remove('hidden');

            // Reset Nav Styles
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('active-nav');
                btn.classList.remove('bg-gray-800/50', 'border-brand-sky', 'text-white');
                btn.classList.add('text-slate-500', 'border-transparent');
            });

            // Set Active Style
            const indexTable = { editor: 0, history: 1, settings: 2 };
            const index = indexTable[viewId] !== undefined ? indexTable[viewId] : -1;
            const navItems = document.querySelectorAll('.nav-item');
            if (index !== -1 && navItems[index]) {
                navItems[index].classList.remove('text-slate-500', 'border-transparent');
                navItems[index].classList.add('active-nav');
            }

            if (viewId === 'konto') updateKontoView();

            const saveWrap = document.getElementById('footer-save-wrap');
            if (saveWrap) saveWrap.classList.toggle('hidden', viewId !== 'editor');

            if (viewId === 'history' && window.db) window.db.getHistory().then(renderHistoryList);
        }

        function setEditorMode(mode) {
            // If not in editor view, switch to it
            const editorView = document.getElementById('view-editor');
            if (editorView && editorView.classList.contains('hidden')) {
                switchView('editor');
            }

            currentMode = mode;
            const btnStruct = document.getElementById('btn-mode-structured');
            const btnFree = document.getElementById('btn-mode-free');
            const divStruct = document.getElementById('editor-structured');
            const divFree = document.getElementById('editor-free');

            if (mode === 'structured') {
                btnStruct.classList.add('bg-brand-sky', 'text-navy-deep', 'shadow-glow');
                btnStruct.classList.remove('text-slate-500', 'hover:text-slate-300');
                btnFree.classList.remove('bg-brand-sky', 'text-navy-deep', 'shadow-glow');
                btnFree.classList.add('text-slate-500', 'hover:text-slate-300');
                divStruct.classList.remove('hidden');
                divFree.classList.add('hidden');
            } else {
                btnFree.classList.add('bg-brand-sky', 'text-navy-deep', 'shadow-glow');
                btnFree.classList.remove('text-slate-500', 'hover:text-slate-300');
                btnStruct.classList.remove('bg-brand-sky', 'text-navy-deep', 'shadow-glow');
                btnStruct.classList.add('text-slate-500', 'hover:text-slate-300');
                divFree.classList.remove('hidden');
                divStruct.classList.add('hidden');
                freeSetMarkdown(freeGetMarkdown());
            }
        }

        function getFreeEditorEl() {
            return document.getElementById('input-free');
        }

        function getFreeMarkdownFromEditor() {
            const editor = getFreeEditorEl();
            if (!editor) return '';
            return freeHtmlToMarkdown(editor);
        }

        function setFreeEditorFromMarkdown(md) {
            const editor = getFreeEditorEl();
            if (!editor) return;
            const value = md || '';
            const html = freeMarkdownToHtml(value);
            editor.innerHTML = html || '<div><br></div>';
            freeMarkdownCache = value;
            freeActiveFormat = null;
            updateFreeToolbarUI();
        }

        function freeGetMarkdown() {
            const editor = getFreeEditorEl();
            if (editor) return getFreeMarkdownFromEditor();
            return freeMarkdownCache || '';
        }

        function freeSetMarkdown(md) {
            freeMarkdownCache = md || '';
            setFreeEditorFromMarkdown(freeMarkdownCache);
        }

        function initFreeEditor() {
            const editor = getFreeEditorEl();
            if (!editor) return;
            editor.addEventListener('input', () => freeSyncHtmlToMarkdown());
            editor.addEventListener('keydown', (ev) => handleFreeEditorKeydown(ev));
            editor.addEventListener('blur', () => freeSyncHtmlToMarkdown());
            editor.addEventListener('paste', (ev) => handleFreePaste(ev));
            const updateSelection = () => updateFreeSelection();
            editor.addEventListener('keyup', updateSelection);
            editor.addEventListener('mouseup', updateSelection);
            editor.addEventListener('select', updateSelection);
            editor.addEventListener('input', updateSelection);
            document.addEventListener('selectionchange', () => {
                if (document.activeElement === editor) updateFreeSelection();
            });
            setFreeEditorFromMarkdown(freeGetMarkdown());
        }

        function handleFreePaste(ev) {
            ev.preventDefault();
            const text = (ev.clipboardData || window.clipboardData).getData('text/plain');
            const editor = getFreeEditorEl();
            if (!editor) return;

            // Inserts plain text at cursor
            insertTextAtCursor(editor, text, freeLastSelectionRange);
        }

        function updateFreeSelection() {
            const editor = getFreeEditorEl();
            const sel = window.getSelection();
            if (!editor || !sel || !sel.rangeCount) return;
            const range = sel.getRangeAt(0);
            if (!editor.contains(range.startContainer)) return;
            freeLastSelectionRange = range.cloneRange();
            updateFreeActiveFormatFromSelection();
        }

        function updateFreeActiveFormatFromSelection() {
            const editor = getFreeEditorEl();
            const sel = window.getSelection();
            if (!editor || !sel || !sel.rangeCount) return;

            let node = sel.anchorNode;
            if (node.nodeType === 3) node = node.parentNode;

            let format = null;
            if (getClosestTag(node, ['H1'])) format = 'h1';
            else if (getClosestTag(node, ['H2'])) format = 'h2';
            else if (getClosestTag(node, ['H3'])) format = 'h3';
            else if (getClosestTag(node, ['BLOCKQUOTE'])) format = 'quote';
            else if (getClosestTag(node, ['UL'])) format = 'ul';
            else if (getClosestTag(node, ['OL'])) format = 'ol';
            else if (getClosestTag(node, ['CODE', 'PRE'])) format = 'code';

            freeActiveFormat = format;
            updateFreeToolbarUI();

            // Special check for Bold
            const btnBold = document.getElementById('btn-free-bold');
            if (btnBold) {
                const isBold = document.queryCommandState('bold');
                btnBold.classList.toggle('bg-slate-800', isBold);
                btnBold.classList.toggle('text-white', isBold);
                btnBold.classList.toggle('text-slate-400', !isBold);
            }
        }

        function updateFreeToolbarUI() {
            const buttons = document.querySelectorAll('.free-format-btn');
            buttons.forEach(btn => {
                btn.classList.remove('bg-slate-800', 'text-white');
                btn.classList.add('text-slate-400', 'hover:text-white', 'hover:bg-slate-800');
                if (btn.dataset.format === freeActiveFormat) {
                    btn.classList.add('bg-slate-800', 'text-white');
                    btn.classList.remove('text-slate-400');
                }
            });
        }

        function getClosestTag(node, tags) {
            let cur = node;
            while (cur) {
                if (cur.nodeType === 1 && tags.includes(cur.tagName)) return cur;
                cur = cur.parentNode;
            }
            return null;
        }

        function toggleFreeFormat(format) {
            const editor = getFreeEditorEl();
            if (!editor) return;
            focusEditorPreserveSelection(editor);

            if (freeActiveFormat === format) {
                deactivateFormat(format);
                freeActiveFormat = null;
                updateFreeToolbarUI();
                return;
            }

            deactivateFormat(freeActiveFormat);
            activateFormat(format);
            freeActiveFormat = format;
            updateFreeToolbarUI();
        }

        function deactivateFormat(format) {
            if (!format) return;
            if (format === 'bold') document.execCommand('bold');
            if (format === 'h1' || format === 'h2' || format === 'h3' || format === 'quote' || format === 'code') {
                document.execCommand('formatBlock', false, 'P');
            }
            if (format === 'ul') document.execCommand('insertUnorderedList');
            if (format === 'ol') document.execCommand('insertOrderedList');
        }

        function activateFormat(format) {
            if (format === 'bold') document.execCommand('bold');
            if (format === 'h1') document.execCommand('formatBlock', false, 'H1');
            if (format === 'h2') document.execCommand('formatBlock', false, 'H2');
            if (format === 'h3') document.execCommand('formatBlock', false, 'H3');
            if (format === 'quote') document.execCommand('formatBlock', false, 'BLOCKQUOTE');
            if (format === 'ul') document.execCommand('insertUnorderedList');
            if (format === 'ol') document.execCommand('insertOrderedList');
            if (format === 'code') document.execCommand('formatBlock', false, 'PRE');
        }

        function focusEditorPreserveSelection(editor) {
            if (!editor) return;
            editor.focus();
        }

        function handleFreeEditorKeydown(ev) {
            if (ev.key !== 'Enter') return;

            const sel = window.getSelection();
            const anchor = sel && sel.anchorNode ? sel.anchorNode : null;

            // PRE handling:
            // Shift + Enter -> Insert newline
            // Enter (alone) -> Exit code box
            const pre = getClosestTag(anchor, ['PRE']);
            if (pre) {
                ev.preventDefault();
                const range = sel.getRangeAt(0);

                if (ev.shiftKey) {
                    // NORMAL NEWLINE (Shift + Enter):
                    range.deleteContents();
                    const br = document.createElement('br');
                    range.insertNode(br);
                    range.setStartAfter(br);
                    range.setEndAfter(br);

                    // Force visibility: if we are at the end, we need a filler BR
                    const testRange = range.cloneRange();
                    if (pre.lastChild) {
                        testRange.setEndAfter(pre.lastChild);
                        testRange.setStart(range.endContainer, range.endOffset);
                        const frag = testRange.cloneContents();
                        const isAtEnd = frag.textContent.trim() === "" && !frag.querySelector(':not(br)');
                        if (isAtEnd) {
                            const filler = document.createElement('br');
                            range.insertNode(filler);
                            range.setStartBefore(filler);
                            range.setEndBefore(filler);
                        }
                    }

                    sel.removeAllRanges();
                    sel.addRange(range);
                } else {
                    // EXIT (Enter alone):
                    // Cleanup trailing BRs before exiting
                    while (pre.lastChild && pre.lastChild.tagName === 'BR') pre.lastChild.remove();

                    const nextBlock = document.createElement('div');
                    nextBlock.innerHTML = '<br>';
                    if (pre.nextSibling) pre.parentNode.insertBefore(nextBlock, pre.nextSibling);
                    else pre.parentNode.appendChild(nextBlock);

                    placeCaretAtStart(nextBlock);
                    freeActiveFormat = null;
                    updateFreeToolbarUI();
                }

                freeSyncHtmlToMarkdown();
                return;
            }

            if (freeActiveFormat === 'h1' || freeActiveFormat === 'h2' || freeActiveFormat === 'h3') {
                requestAnimationFrame(() => {
                    freeActiveFormat = null;
                    updateFreeToolbarUI();
                    freeSyncHtmlToMarkdown();
                });
            }

            const li = getClosestTag(anchor, ['LI']);
            if (!li) return;
            const list = getClosestTag(li, ['UL', 'OL']);
            if (!list) return;
            if (li.textContent.trim() === '') {
                ev.preventDefault();
                const listParent = list.parentNode;
                if (!listParent) return;
                const listNext = list.nextSibling;
                li.remove();
                if (!list.querySelector('li')) {
                    list.remove();
                }
                const block = document.createElement('div');
                block.appendChild(document.createElement('br'));
                if (listNext) {
                    listParent.insertBefore(block, listNext);
                } else {
                    listParent.appendChild(block);
                }
                placeCaretAtStart(block);
                if (freeActiveFormat === 'ul' || freeActiveFormat === 'ol') {
                    freeActiveFormat = null;
                    updateFreeToolbarUI();
                }
                freeSyncHtmlToMarkdown();
            }
        }

        function freeSyncHtmlToMarkdown() {
            freeMarkdownCache = getFreeMarkdownFromEditor();
            return freeMarkdownCache;
        }

        function placeCaretAtStart(el) {
            if (!el) return;
            const range = document.createRange();
            range.selectNodeContents(el);
            range.collapse(true);
            const sel = window.getSelection();
            if (sel) {
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }

        function getFreeInsertionRange(editor) {
            if (freeLastSelectionRange && editor.contains(freeLastSelectionRange.startContainer)) {
                return freeLastSelectionRange.cloneRange();
            }
            const sel = window.getSelection();
            if (sel && sel.rangeCount) {
                const r = sel.getRangeAt(0);
                if (editor.contains(r.startContainer)) return r.cloneRange();
            }
            const r = document.createRange();
            r.selectNodeContents(editor);
            r.collapse(false);
            return r;
        }

        function insertTextAtCursor(el, text, fallbackRange) {
            if (!el || !text) return;
            if (el.isContentEditable) {
                let rangeToUse = null;
                if (fallbackRange && el.contains(fallbackRange.startContainer)) {
                    rangeToUse = fallbackRange.cloneRange();
                }
                const sel = window.getSelection();
                if (!rangeToUse && sel && sel.rangeCount) {
                    const current = sel.getRangeAt(0);
                    if (el.contains(current.startContainer)) rangeToUse = current.cloneRange();
                }
                el.focus();
                const focusedSel = window.getSelection();
                if (rangeToUse && focusedSel) {
                    focusedSel.removeAllRanges();
                    focusedSel.addRange(rangeToUse);
                }
                if (!rangeToUse && focusedSel && focusedSel.rangeCount) {
                    const current = focusedSel.getRangeAt(0);
                    if (el.contains(current.startContainer)) rangeToUse = current;
                }
                if (!rangeToUse) {
                    el.appendChild(document.createTextNode(text));
                    el.dispatchEvent(new Event('input', { bubbles: true }));
                    return;
                }
                rangeToUse.deleteContents();
                const node = document.createTextNode(text);
                rangeToUse.insertNode(node);
                rangeToUse.setStartAfter(node);
                rangeToUse.setEndAfter(node);
                if (focusedSel) {
                    focusedSel.removeAllRanges();
                    focusedSel.addRange(rangeToUse);
                }
                freeLastSelectionRange = rangeToUse.cloneRange();
                el.dispatchEvent(new Event('input', { bubbles: true }));
                return;
            }
        }

        function freeHtmlToMarkdown(root) {
            const blockTags = ['H1', 'H2', 'H3', 'P', 'DIV', 'BLOCKQUOTE', 'UL', 'OL'];

            const inlineToMd = (node) => {
                if (node.nodeType === 3) return node.nodeValue;
                if (node.nodeType !== 1) return '';
                const tag = node.tagName;
                if (tag === 'BR') return '\n';
                const inner = Array.from(node.childNodes).map(inlineToMd).join('');
                if (tag === 'STRONG' || tag === 'B') return `**${inner}**`;
                if (tag === 'CODE') return `\`${inner}\``;
                return inner;
            };

            const isEmptyBlock = (node) => {
                if (!node || node.nodeType !== 1) return false;
                if (node.tagName !== 'DIV' && node.tagName !== 'P') return false;
                if (!node.childNodes || node.childNodes.length === 0) return true;
                return Array.from(node.childNodes).every(child => {
                    if (child.nodeType === 3) return !child.nodeValue.trim();
                    if (child.nodeType === 1) return child.tagName === 'BR';
                    return true;
                });
            };

            const hasBlockChild = (node) => {
                if (!node || node.nodeType !== 1) return false;
                return Array.from(node.childNodes).some(child => {
                    if (child.nodeType !== 1) return false;
                    if (blockTags.includes(child.tagName)) return true;
                    return hasBlockChild(child);
                });
            };

            const blockToMd = (node) => {
                if (node.nodeType === 3) {
                    const text = node.nodeValue || '';
                    return text.trim() ? text + '\n\n' : '';
                }
                if (node.nodeType !== 1) return '';
                const tag = node.tagName;
                if ((tag === 'DIV' || tag === 'P') && isEmptyBlock(node)) return '\n\n';
                if (tag === 'H1') return `# ${inlineToMd(node).trim()}\n\n`;
                if (tag === 'H2') return `## ${inlineToMd(node).trim()}\n\n`;
                if (tag === 'H3') return `### ${inlineToMd(node).trim()}\n\n`;
                if (tag === 'PRE' || tag === 'CODE') return `\`\`\`\n${inlineToMd(node).trim()}\n\`\`\`\n\n`;
                if (tag === 'BLOCKQUOTE') {
                    const text = inlineToMd(node).trimEnd();
                    const lines = text ? text.split('\n') : [''];
                    return lines.map(l => `> ${l}`.trimEnd()).join('\n') + '\n\n';
                }
                if (tag === 'UL') {
                    const items = Array.from(node.children).filter(c => c.tagName === 'LI');
                    const rows = items.map(li => `- ${inlineToMd(li).trim()}`);
                    return rows.join('\n') + '\n\n';
                }
                if (tag === 'OL') {
                    const items = Array.from(node.children).filter(c => c.tagName === 'LI');
                    const rows = items.map((li, idx) => `${idx + 1}. ${inlineToMd(li).trim()}`);
                    return rows.join('\n') + '\n\n';
                }
                if (tag === 'P' || tag === 'DIV') {
                    if (hasBlockChild(node)) {
                        return Array.from(node.childNodes).map(blockToMd).join('');
                    }
                    const text = inlineToMd(node).trimEnd();
                    if (!text.trim()) return '';
                    return text + '\n\n';
                }
                if (blockTags.includes(tag)) return inlineToMd(node).trim() + '\n\n';
                return inlineToMd(node).trim();
            };

            let out = '';
            root.childNodes.forEach(node => {
                out += blockToMd(node);
            });
            return out.trim();
        }

        function freeMarkdownToHtml(md) {
            const lines = (md || '').replace(/\r\n/g, '\n').split('\n');
            const blocks = [];
            let i = 0;

            const parseInline = (text) => {
                const safe = escapeHtml(text);
                return safe
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/`(.+?)`/g, '<code>$1</code>');
            };

            while (i < lines.length) {
                const line = lines[i];
                if (!line.trim()) {
                    // Skip single empty lines that act as paragraph separators
                    // But if there are consecutive ones, we might want to keep a spacer
                    let emptyCount = 0;
                    while (i < lines.length && !lines[i].trim()) {
                        emptyCount++;
                        i++;
                    }
                    if (emptyCount > 1) {
                        for (let k = 0; k < emptyCount - 1; k++) {
                            blocks.push('<div><br></div>');
                        }
                    }
                    continue;
                }
                if (/^#{1,3}\s+/.test(line)) {
                    const level = line.match(/^#{1,3}/)[0].length;
                    const content = line.replace(/^#{1,3}\s+/, '');
                    blocks.push(`<h${level}>${parseInline(content)}</h${level}>`);
                    i += 1;
                    continue;
                }
                if (/^```/.test(line)) {
                    const buf = [];
                    i += 1; // skip fence
                    while (i < lines.length && !/^```/.test(lines[i])) {
                        buf.push(lines[i]);
                        i += 1;
                    }
                    i += 1; // skip closing fence
                    blocks.push(`<pre>${escapeHtml(buf.join('\n'))}</pre>`);
                    continue;
                }
                if (/^>\s?/.test(line)) {
                    const buf = [];
                    while (i < lines.length && /^>\s?/.test(lines[i])) {
                        buf.push(lines[i].replace(/^>\s?/, ''));
                        i += 1;
                    }
                    const content = parseInline(buf.join('\n')).replace(/\n/g, '<br>');
                    blocks.push(`<blockquote>${content}</blockquote>`);
                    continue;
                }
                if (/^-\s+/.test(line)) {
                    const items = [];
                    while (i < lines.length && /^-\s+/.test(lines[i])) {
                        items.push(lines[i].replace(/^-+\s+/, ''));
                        i += 1;
                    }
                    blocks.push(`<ul>${items.map(it => `<li>${parseInline(it)}</li>`).join('')}</ul>`);
                    continue;
                }
                if (/^\d+\.\s+/.test(line)) {
                    const items = [];
                    while (i < lines.length && /^\d+\.\s+/.test(lines[i])) {
                        items.push(lines[i].replace(/^\d+\.\s+/, ''));
                        i += 1;
                    }
                    blocks.push(`<ol>${items.map(it => `<li>${parseInline(it)}</li>`).join('')}</ol>`);
                    continue;
                }
                const para = [];
                while (i < lines.length && lines[i].trim() && !/^#{1,3}\s+/.test(lines[i]) && !/^>\s?/.test(lines[i]) && !/^-\s+/.test(lines[i]) && !/^\d+\.\s+/.test(lines[i])) {
                    para.push(lines[i]);
                    i += 1;
                }
                const content = parseInline(para.join('\n')).replace(/\n/g, '<br>');
                blocks.push(`<p>${content}</p>`);
            }

            // JOIN WITHOUT EXTRA DIVS FOR EMPTY LINES (unless multiple)
            return blocks.join('');
        }

        async function handleCopyAndSave() {
            let finalText = "";
            if (currentMode === 'structured') {
                const headerMap = { 'role': '🎭 ROLLE', 'context': '🌍 KONTEXT', 'task': '🎯 AUFGABE', 'format': '🧪 VARIANTEN' };
                FIELDS.forEach(f => {
                    const val = document.getElementById(`input-${f.id}`).value.trim();
                    if (val) finalText += `**${headerMap[f.id]}**\n${val}\n\n`;
                });
            } else {
                const raw = getFreeMarkdownFromEditor().replace(/\r\n/g, '\n');
                if (!raw.trim()) {
                    alert("Bitte gib erst etwas ein!");
                    return;
                }
                finalText = raw;
            }

            if (!finalText || !finalText.trim()) {
                alert("Bitte gib erst etwas ein!");
                return;
            }

            try {
                await navigator.clipboard.writeText(finalText);
                if (window.db && window.db.savePrompt) {
                    await window.db.savePrompt({
                        text: finalText,
                        title: "Auto-Save",
                        mode: currentMode,
                        timestamp: new Date().toISOString()
                    });
                }
                const btn = document.getElementById('btn-copy');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> <span>COPIED!</span>';
                btn.classList.replace('bg-brand-sky', 'bg-green-500');
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.replace('bg-green-500', 'bg-brand-sky');
                }, 2000);
            } catch (err) {
                console.error('Copy failed', err);
            }
        }

        function openResetModal() {
            document.getElementById('modal-reset').classList.remove('hidden');
        }

        function closeResetModal() {
            document.getElementById('modal-reset').classList.add('hidden');
        }

        function confirmReset() {
            closeResetModal();
            resetFields();
        }

        function resetCurrentView() {
            openResetModal();
        }

        function resetFields() {
            if (currentMode === 'structured') {
                FIELDS.forEach(f => document.getElementById(`input-${f.id}`).value = '');
            } else {
                const editor = getFreeEditorEl();
                if (editor) editor.innerHTML = '<div><br></div>';
                freeMarkdownCache = '';
                freeActiveFormat = null;
                updateFreeToolbarUI();
            }
        }

        function safeRefreshSidebar() {
            const now = Date.now();
            if (now - lastSidebarRefreshTs < 1000) return;
            lastSidebarRefreshTs = now;
            if (window.db && window.db.getScenarios) loadLibrary();
        }

        async function loadLibrary() {
            if (!window.db) return;
            promptLibraryCache = await window.db.getScenarios();
            promptCategoriesCache = window.db.getPromptCategories ? await window.db.getPromptCategories() : [];
            renderPromptsAccordion();
        }

        async function refreshPromptLibraryAndCategories() {
            if (!window.db) return;
            promptLibraryCache = await window.db.getScenarios();
            promptCategoriesCache = window.db.getPromptCategories ? await window.db.getPromptCategories() : [];
            renderPromptsAccordion();

            if (promptMenuOpen) {
                const sub = document.getElementById('prompt-category-submenu');
                if (sub && !sub.classList.contains('hidden')) {
                    await openPromptCategorySubmenu();
                }
            }

            if (isSavePromptModalOpen()) {
                await refreshSavePromptCategoryMenu();
            }
        }

        function loadScenario(id) {
            window.db.getScenarios().then(scenarios => {
                const s = scenarios.find(x => x.id == id);
                if (!s) return;

                if (Array.isArray(s.fields)) {
                    setEditorMode('structured');
                    applyStructuredToEditor(s);
                    return;
                }

                if (!s.fields || typeof s.fields !== 'object') return;

                if (s.fields.mode === 'free') {
                    setEditorMode('free');
                    setFreeEditorFromMarkdown(s.fields.text || '');
                    setActiveField('free');
                    return;
                }

                if (s.fields.mode === 'structured') {
                    setEditorMode('structured');
                    applyStructuredToEditor(s);
                }
            });
        }

        function isFreePrompt(s) {
            if (!s || !s.fields) return false;
            if (typeof s.fields === 'object' && s.fields.mode === 'free') return true;
            if (typeof s.fields === 'object' && typeof s.fields.text === 'string') return true;
            return false;
        }

        function extractStructuredFields(s) {
            const out = { role: '', context: '', task: '', format: '' };

            if (Array.isArray(s.fields)) {
                s.fields.forEach((val, idx) => {
                    const key = STRUCTURED_STORAGE_ORDER[idx];
                    if (key && Object.prototype.hasOwnProperty.call(out, key)) {
                        out[key] = val ?? '';
                    }
                });
                return out;
            }

            if (!s.fields || typeof s.fields !== 'object') return out;

            if (s.fields.mode === 'structured') {
                if (Array.isArray(s.fields.fields)) {
                    s.fields.fields.forEach((val, idx) => {
                        const key = STRUCTURED_STORAGE_ORDER[idx];
                        if (key && Object.prototype.hasOwnProperty.call(out, key)) {
                            out[key] = val ?? '';
                        }
                    });
                    return out;
                }
                if (s.fields.fields && typeof s.fields.fields === 'object') {
                    Object.keys(out).forEach(key => {
                        if (s.fields.fields[key] !== undefined) out[key] = s.fields.fields[key] ?? '';
                    });
                    return out;
                }
            }

            return out;
        }

        function applyStructuredToEditor(s) {
            const data = extractStructuredFields(s);
            FIELDS.forEach(f => {
                const el = document.getElementById(`input-${f.id}`);
                if (el) el.value = data[f.id] ?? '';
            });
        }

        function structuredPromptToText(s) {
            const headerMap = { role: 'ðŸŽ­ ROLLE', context: 'ðŸŒ KONTEXT', task: 'ðŸŽ¯ AUFGABE', format: 'ðŸ§ª VARIANTEN' };
            const data = extractStructuredFields(s);
            let finalText = '';
            FIELDS.forEach(f => {
                const val = (data[f.id] ?? '').toString().trim();
                if (val) finalText += `**${headerMap[f.id]}**\n${val}\n\n`;
            });
            return finalText.trim();
        }

        async function handlePromptClick(id) {
            let scenarios = [];
            if (Array.isArray(promptLibraryCache) && promptLibraryCache.length) {
                scenarios = promptLibraryCache;
            } else {
                scenarios = await window.db.getScenarios();
                promptLibraryCache = scenarios;
            }

            const s = scenarios.find(x => x.id == id);
            if (!s) return;

            const freePrompt = isFreePrompt(s);

            if (currentMode === 'structured') {
                if (!freePrompt) {
                    applyStructuredToEditor(s);
                    return;
                }
                setEditorMode('free');
                freeSetMarkdown(s.fields.text || '');
                setActiveField('free');
                return;
            }

            if (freePrompt) {
                freeSetMarkdown(s.fields.text || '');
                setActiveField('free');
                return;
            }

            freeSetMarkdown(structuredPromptToText(s));
            setActiveField('free');
        }

        function loadSnippetsForFieldDemo(fieldId) {
            const container = document.getElementById('library-snippets');
            const fieldLabel = FIELDS.find(f => f.id === fieldId)?.label || 'Feld';
            container.innerHTML = `
                <div class="text-[10px] text-brand-sky font-bold mb-1 uppercase tracking-wider opacity-70">Passend für: ${fieldLabel}</div>
                <div class="group flex items-center p-2 rounded hover:bg-slate-800/50 cursor-pointer transition-colors" onclick="insertSnippet('${fieldId}', 'Beispiel Textbaustein')">
                    <div class="text-sm text-slate-300 group-hover:text-white truncate">Beispiel Baustein</div>
                </div>
            `;
        }

        function insertSnippet(fieldId, text) {
            insertSnippetText(text, fieldId);
        }

        function insertSnippetText(text, targetFieldId = null) {
            if (currentMode === 'free') {
                const editor = getFreeEditorEl();
                if (!editor) { alert('Freies Textfeld nicht gefunden.'); return; }
                const range = getFreeInsertionRange(editor);
                insertTextAtCursor(editor, text, range);
                freeSyncHtmlToMarkdown();
                return;
            }

            let target = targetFieldId;

            if (target === 'free') {
                target = (activeFieldId && activeFieldId !== 'free') ? activeFieldId : 'context';
            }

            if (!target) {
                target = (activeFieldId && activeFieldId !== 'free') ? activeFieldId : 'context';
            }

            const ta = document.getElementById(`input-${target}`);
            if (!ta) { alert('Zielfeld nicht gefunden: ' + target); return; }
            ta.focus();
            const start = (ta.selectionStart ?? ta.value.length);
            const end = (ta.selectionEnd ?? ta.value.length);
            ta.value = ta.value.slice(0, start) + text + ta.value.slice(end);
            const pos = start + text.length;
            ta.setSelectionRange(pos, pos);
        }

        async function loadSnippetsForField(fieldId) {
            const container = document.getElementById('library-snippets');
            activeFieldId = fieldId;

            if (!isLeftOpen) toggleSidebar('left');

            if (currentMode === 'structured' && (!fieldId || fieldId === 'free')) {
                container.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Wähle ein Feld im Editor.</div>';
                return;
            }

            if (!window.db || !window.db.getSnippets) {
                container.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Keine Bausteine.</div>';
                return;
            }

            const snippets = await window.db.getSnippets({ mode: currentMode, fieldId: activeFieldId });
            const fieldLabel = FIELDS.find(f => f.id === fieldId)?.label || 'Feld';
            const headerLabel = currentMode === 'free' ? 'Bausteine (Frei)' : `Passend für: ${fieldLabel}`;

            if (!snippets || snippets.length === 0) {
                container.innerHTML = `
                    <div class="text-[10px] text-brand-sky font-bold mb-1 uppercase tracking-wider opacity-70">${headerLabel}</div>
                    <div class="text-xs text-slate-600 italic py-2">Keine Bausteine.</div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="text-[10px] text-brand-sky font-bold mb-1 uppercase tracking-wider opacity-70">${headerLabel}</div>
                ${snippets.map(snippet => `
                    <div class="group flex items-center p-2 rounded hover:bg-slate-800/50 cursor-pointer transition-colors" onclick='insertSnippetText(${JSON.stringify(snippet.content)}, ${JSON.stringify(fieldId)})'>
                        <div class="text-sm text-slate-300 group-hover:text-white truncate">${snippet.name}</div>
                    </div>
                `).join('')}
            `;
        }

        function setActiveField(fieldId) {
            activeFieldId = fieldId;
        }

        function normalizeCategoryName(v) {
            return (v || '').trim();
        }

        function categoryKeyFromName(name) {
            const normalized = normalizeCategoryName(name);
            if (!normalized) return '__uncat__';
            return 'cat_' + encodeURIComponent(normalized).replace(/%/g, '_');
        }

        function buildPromptCategoryMeta() {
            const meta = [];
            const seen = {};
            promptCategoryKeyToName = {};

            const addCategory = (name, labelOverride = null) => {
                const normalized = normalizeCategoryName(name);
                const key = categoryKeyFromName(normalized);
                if (seen[key]) return;
                seen[key] = true;
                const label = labelOverride !== null ? labelOverride : normalized;
                meta.push({ key, name: normalized, label });
                promptCategoryKeyToName[key] = normalized;
                if (promptOpenState[key] === undefined) promptOpenState[key] = false;
            };

            addCategory('', 'Ohne Kategorie');
            (promptCategoriesCache || []).forEach(c => addCategory(c.name));
            (promptLibraryCache || []).forEach(s => {
                const name = normalizeCategoryName(s.category);
                if (name) addCategory(name);
            });

            return meta;
        }

        function renderPromptsAccordion() {
            const container = document.getElementById('library-scenarios');
            if (!container) return;

            const meta = buildPromptCategoryMeta();
            container.innerHTML = meta.map(cat => `
                <div>
                    <button class="group w-full flex items-center justify-between p-2 text-left hover:bg-slate-800/50 rounded" onclick="togglePromptCategory('${cat.key}')">
                        <div class="flex items-center gap-2 min-w-0">
                            <i class="fa-regular fa-folder text-sm text-slate-400 group-hover:text-slate-200 transition-colors"></i>
                            <span class="truncate text-sm font-bold text-slate-300">${cat.label}</span>
                        </div>
                        <i id="prompt-icon-${cat.key}" class="fa-solid fa-chevron-down text-xs transition-transform ${promptOpenState[cat.key] ? 'rotate-180' : ''}"></i>
                    </button>
                    <div id="prompt-body-${cat.key}" class="${promptOpenState[cat.key] ? '' : 'hidden'} pl-2 pr-0 pb-2" data-loaded="false">
                        <div class="text-xs text-slate-600 italic py-2">Noch nicht geladen.</div>
                    </div>
                </div>
            `).join('');
            (async () => {
                for (const cat of meta) {
                    if (!promptOpenState[cat.key]) continue;
                    const body = document.getElementById(`prompt-body-${cat.key}`);
                    if (body && body.dataset.loaded !== 'true') {
                        await loadPromptCategory(cat.key);
                    }
                }
            })();
        }

        async function togglePromptCategory(catKey) {
            const body = document.getElementById(`prompt-body-${catKey}`);
            const icon = document.getElementById(`prompt-icon-${catKey}`);
            if (!body) return;

            promptOpenState[catKey] = !promptOpenState[catKey];
            if (promptOpenState[catKey]) {
                body.classList.remove('hidden');
                if (icon) icon.classList.add('rotate-180');
                if (body.dataset.loaded !== 'true') {
                    await loadPromptCategory(catKey);
                }
            } else {
                body.classList.add('hidden');
                if (icon) icon.classList.remove('rotate-180');
            }
        }

        async function loadPromptCategory(catKey) {
            const body = document.getElementById(`prompt-body-${catKey}`);
            if (!body) return;

            body.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Lade...</div>';

            if (!window.currentUser) {
                body.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Bitte einloggen, um Prompts zu sehen.</div>';
                body.dataset.loaded = 'false';
                return;
            }

            const categoryName = promptCategoryKeyToName[catKey] || '';
            const prompts = promptLibraryCache || [];
            const filtered = prompts.filter(s => {
                const normalized = normalizeCategoryName(s.category);
                if (catKey === '__uncat__' || !categoryName) {
                    return !normalized;
                }
                return normalized === categoryName;
            });

            if (!filtered.length) {
                body.innerHTML = '<div class="text-xs text-slate-600 italic py-2 pl-1">Keine Prompts.</div>';
                body.dataset.loaded = 'true';
                return;
            }

            body.innerHTML = `
                <div class="space-y-0.5">
                    ${filtered.map(s => `
                        <div id="prompt-item-${s.id}" class="group w-full py-1 px-2 rounded hover:bg-slate-800/50 cursor-pointer transition-colors" onclick="handlePromptClick(${s.id})">
                            <div class="flex items-center justify-between w-full">
                                <div class="text-sm text-slate-300 group-hover:text-white truncate leading-tight min-w-0 flex-1" title=${JSON.stringify(s.name || '')}>${s.name}</div>
                                <button class="p-1 rounded hover:bg-slate-800 text-slate-400 hover:text-white leading-none flex-none" onclick="openPromptItemMenu(event, '${catKey}', ${s.id})">
                                    <i class="fa-solid fa-ellipsis"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            body.dataset.loaded = 'true';
        }

        function scheduleSidebarMenuReposition() {
            if (sidebarMenuRaf) return;
            sidebarMenuRaf = requestAnimationFrame(() => {
                sidebarMenuRaf = null;
                if (snippetMenuOpen) repositionSnippetItemMenu();
                if (promptMenuOpen) repositionPromptItemMenu();
            });
        }

        function positionMenuNextToTrigger(menu, triggerEl) {
            if (!menu || !triggerEl) return;

            const rect = triggerEl.getBoundingClientRect();

            // Wenn Trigger komplett außerhalb des Viewports: Menü schließen
            if (rect.bottom < 0 || rect.top > window.innerHeight) return false;

            const menuWidth = menu.offsetWidth || 180;
            const menuHeight = menu.offsetHeight || 140;

            // Standard: rechts neben dem Eintrag öffnen
            let left = rect.right + 8;
            let top = rect.top;

            // Wenn rechts kein Platz: links öffnen
            if (left + menuWidth + 8 > window.innerWidth) {
                left = rect.left - menuWidth - 8;
            }

            // Wenn unten kein Platz: nach oben schieben
            if (top + menuHeight + 8 > window.innerHeight) {
                top = Math.max(8, rect.bottom - menuHeight);
            }

            // Clamp
            const maxLeft = Math.max(8, window.innerWidth - menuWidth - 8);
            const maxTop = Math.max(8, window.innerHeight - menuHeight - 8);
            left = Math.min(Math.max(8, left), maxLeft);
            top = Math.min(Math.max(8, top), maxTop);

            menu.style.left = left + 'px';
            menu.style.top = top + 'px';
            return true;
        }

        function repositionSnippetItemMenu() {
            const menu = document.getElementById('snippet-item-menu');
            if (!menu || !snippetMenuTriggerEl) return;
            const ok = positionMenuNextToTrigger(menu, snippetMenuTriggerEl);
            if (ok === false) closeSnippetItemMenu();
        }

        function repositionPromptItemMenu() {
            const menu = document.getElementById('prompt-item-menu');
            if (!menu || !promptMenuTriggerEl) return;
            const ok = positionMenuNextToTrigger(menu, promptMenuTriggerEl);
            if (ok === false) closePromptItemMenu();
        }

        function openPromptItemMenu(ev, catKey, promptId) {
            ev.stopPropagation();
            const menu = document.getElementById('prompt-item-menu');
            if (!menu) return;

            promptMenuPromptId = promptId;
            promptMenuCategoryKey = catKey;
            promptMenuTriggerEl = ev.currentTarget;

            menu.classList.remove('hidden');

            const sub = document.getElementById('prompt-category-submenu');
            if (sub) sub.classList.add('hidden');
            const list = document.getElementById('prompt-category-submenu-list');
            if (list) list.innerHTML = '<div class="px-3 py-2 text-xs text-slate-500 italic">Lade…</div>';

            promptMenuOpen = true;
            menu.onclick = (e) => e.stopPropagation();

            requestAnimationFrame(() => {
                repositionPromptItemMenu();
                scheduleSidebarMenuReposition();
            });
        }

        function closePromptItemMenu() {
            const menu = document.getElementById('prompt-item-menu');
            if (menu) menu.classList.add('hidden');
            const sub = document.getElementById('prompt-category-submenu');
            if (sub) sub.classList.add('hidden');
            const list = document.getElementById('prompt-category-submenu-list');
            if (list) list.innerHTML = '<div class="px-3 py-2 text-xs text-slate-500 italic">Lade…</div>';
            promptMenuOpen = false;
            promptMenuTriggerEl = null;
            promptMenuPromptId = null;
            promptMenuCategoryKey = null;
        }

        function handleEditPrompt() {
            const id = promptMenuPromptId;
            closePromptItemMenu();
            openPromptEditModal(id);
        }

        function handlePromptCategoryPlaceholder() {
            closePromptItemMenu();
            alert('Kategorie-Funktion folgt im nÃ¤chsten Schritt.');
        }

        function handleAskDeletePrompt() {
            const catKey = promptMenuCategoryKey;
            const id = promptMenuPromptId;
            closePromptItemMenu();
            openDeletePromptModal(catKey, id);
        }

        function openDeletePromptModal(catKey, promptId) {
            pendingDeletePromptCategoryKey = catKey;
            pendingDeletePromptId = promptId;
            const modal = document.getElementById('modal-prompt-delete');
            if (modal) modal.classList.remove('hidden');
        }

        function closeDeletePromptModal() {
            const modal = document.getElementById('modal-prompt-delete');
            if (modal) modal.classList.add('hidden');
            pendingDeletePromptCategoryKey = null;
            pendingDeletePromptId = null;
        }

        async function confirmDeletePrompt() {
            const id = pendingDeletePromptId;
            const catKey = pendingDeletePromptCategoryKey;

            if (!id || !window.db || !window.db.deleteScenario) {
                closeDeletePromptModal();
                return;
            }

            await window.db.deleteScenario(id);

            const el = document.getElementById(`prompt-item-${id}`);
            if (el) el.remove();

            if (Array.isArray(promptLibraryCache)) {
                promptLibraryCache = promptLibraryCache.filter(p => p.id != id);
            }

            closeDeletePromptModal();

            if (catKey) {
                await loadPromptCategory(catKey);
            }
        }

        function openPromptEditModal(id) {
            const modal = document.getElementById('modal-prompt-edit');
            if (modal) modal.classList.remove('hidden');
        }

        function closePromptEditModal() {
            const modal = document.getElementById('modal-prompt-edit');
            if (modal) modal.classList.add('hidden');
        }

        function openPromptCategoryModal(prefill = '') {
            if (!window.currentUser) {
                alert('Bitte einloggen.');
                openAuthModal();
                return;
            }
            const modal = document.getElementById('modal-prompt-category');
            const inp = document.getElementById('prompt-category-name');
            if (inp) inp.value = prefill || '';
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.zIndex = '140';
            }
            setTimeout(() => { if (inp) inp.focus(); }, 50);
        }

        function closePromptCategoryModal() {
            const modal = document.getElementById('modal-prompt-category');
            if (modal) modal.classList.add('hidden');
        }

        async function savePromptCategoryFromModal() {
            const inp = document.getElementById('prompt-category-name');
            const name = (inp?.value || '').trim();
            if (!name) {
                alert('Bitte einen Namen eingeben.');
                return;
            }
            const ok = await window.db.createPromptCategory(name);
            if (!ok) {
                alert('Fehler beim Speichern.');
                return;
            }
            await refreshPromptLibraryAndCategories();
            if (isSavePromptModalOpen()) {
                setSavePromptCategory(name);
            }
            closePromptCategoryModal();
        }

        async function openPromptCategorySubmenu() {
            const menu = document.getElementById('prompt-category-submenu');
            const list = document.getElementById('prompt-category-submenu-list');
            if (!menu || !list) return;

            menu.classList.remove('hidden');

            const names1 = (promptCategoriesCache || [])
                .map(x => (typeof x === 'string' ? x : x.name))
                .filter(Boolean)
                .map(s => s.trim())
                .filter(Boolean);
            const names2 = Array.isArray(promptLibraryCache)
                ? [...new Set(promptLibraryCache.map(p => (p.category || '').trim()).filter(Boolean))]
                : [];

            const all = [...new Set([...names1, ...names2])].sort((a, b) => a.localeCompare(b, 'de'));

            const items = [];
            items.push(`
                <button class="w-full px-4 py-2 text-left text-sm text-slate-200 hover:bg-slate-800/60 truncate"
                        onclick="selectPromptCategory(event, '')">
                    Ohne Kategorie
                </button>
            `);

            if (!all.length) {
                items.push('<div class="px-3 py-2 text-xs text-slate-500 italic">Keine Kategorien.</div>');
                list.innerHTML = items.join('');
                return;
            }

            items.push(all.map(n => `
                <button class="w-full px-4 py-2 text-left text-sm text-slate-200 hover:bg-slate-800/60 truncate"
                        title=${JSON.stringify(n)}
                        onclick='selectPromptCategory(event, ${JSON.stringify(n)})'>
                    ${escapeHtml(n)}
                </button>
            `).join(''));

            list.innerHTML = items.join('');
        }

        function handlePromptCategoryCreateFromMenu(ev) {
            ev.stopPropagation();
            closePromptItemMenu();
            openPromptCategoryModal();
        }

        async function selectPromptCategory(ev, categoryName) {
            try {
                const e = ev || window.event;
                if (e && e.stopPropagation) e.stopPropagation();
            } catch (_) { }

            const id = promptMenuPromptId;
            const oldKey = promptMenuCategoryKey;
            if (!id) return;

            if (!window.db || !window.db.updateScenario) {
                console.error('window.db.updateScenario fehlt');
                return;
            }

            const normalized = (categoryName || '').trim();
            const catVal = normalized ? normalized : null;
            const newKey = categoryKeyFromName(catVal || '');

            try {
                console.log('move prompt', id, 'to category', catVal);
                const ok = await window.db.updateScenario(id, { category: catVal });
                if (!ok) {
                    console.error('Kategorie konnte nicht gespeichert werden.');
                    alert('Kategorie konnte nicht gespeichert werden. Bitte Konsole prüfen.');
                    return;
                }
            } catch (err) {
                console.error('Kategorie Update Fehler:', err);
                alert('Kategorie konnte nicht gespeichert werden. Bitte Konsole prüfen.');
                return;
            }

            if (oldKey) promptOpenState[oldKey] = true;
            promptOpenState[newKey] = true;

            promptLibraryCache = await window.db.getScenarios();
            renderPromptsAccordion();

            if (settingsCurrentPage === 'categories') {
                managePromptsCache = promptLibraryCache;
                manageCategoriesCache = window.db.getPromptCategories ? await window.db.getPromptCategories() : manageCategoriesCache;

                const oldName = oldKey ? (promptCategoryKeyToName[oldKey] || '') : '';
                const oldManageKey = manageCategoryStateKey(oldName);
                const newManageKey = manageCategoryStateKey(catVal || '');
                manageCategoryOpenState[oldManageKey] = true;
                manageCategoryOpenState[newManageKey] = true;

                renderManageCategoriesAccordion();
            }

            const oldBody = oldKey ? document.getElementById(`prompt-body-${oldKey}`) : null;
            const newBody = document.getElementById(`prompt-body-${newKey}`);
            if (oldBody) oldBody.dataset.loaded = 'false';
            if (newBody) newBody.dataset.loaded = 'false';

            closePromptItemMenu();

            if (oldKey && oldKey !== newKey) await loadPromptCategory(oldKey);
            await loadPromptCategory(newKey);
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderSnippetsAccordion() {
            const container = document.getElementById('library-snippets');
            if (!container) return;

            container.innerHTML = SNIPPET_CATEGORIES.map(cat => `
                <div>
                    <button class="group w-full flex items-center justify-between p-2 text-left hover:bg-slate-800/50 rounded" onclick="toggleSnippetSection('${cat.id}')">
                        <div class="flex items-center gap-2 min-w-0">
                            <i class="fa-regular fa-folder text-sm text-slate-400 group-hover:text-slate-200 transition-colors"></i>
                            <span class="truncate text-sm font-bold text-slate-300">${cat.label}</span>
                        </div>
                        <i id="snip-icon-${cat.id}" class="fa-solid fa-chevron-down text-xs transition-transform ${snippetOpenState[cat.id] ? 'rotate-180' : ''}"></i>
                    </button>
                    <div id="snip-body-${cat.id}" class="${snippetOpenState[cat.id] ? '' : 'hidden'} pl-2 pr-0 pb-2" data-loaded="false">
                        <div class="text-xs text-slate-600 italic py-2">Noch nicht geladen.</div>
                    </div>
                </div>
            `).join('');
        }

        async function toggleSnippetSection(catId) {
            const body = document.getElementById(`snip-body-${catId}`);
            const icon = document.getElementById(`snip-icon-${catId}`);
            if (!body) return;

            snippetOpenState[catId] = !snippetOpenState[catId];
            if (snippetOpenState[catId]) {
                body.classList.remove('hidden');
                if (icon) icon.classList.add('rotate-180');
                if (body.dataset.loaded !== 'true') {
                    await loadSnippetSection(catId);
                }
            } else {
                body.classList.add('hidden');
                if (icon) icon.classList.remove('rotate-180');
            }
        }

        async function loadSnippetSection(catId) {
            const body = document.getElementById(`snip-body-${catId}`);
            if (!body) return;

            body.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Lade...</div>';

            if (!window.currentUser) {
                body.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Bitte einloggen, um Bausteine zu sehen.</div>';
                body.dataset.loaded = 'false';
                return;
            }

            const cat = SNIPPET_CATEGORIES.find(c => c.id === catId);
            if (!cat || !window.db || !window.db.getSnippets) {
                body.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Keine Bausteine.</div>';
                body.dataset.loaded = 'true';
                return;
            }

            const snippets = await window.db.getSnippets({ mode: cat.mode, fieldId: cat.id });
            if (!snippets || snippets.length === 0) {
                body.innerHTML = '<div class="text-xs text-slate-600 italic py-2">Keine Bausteine.</div>';
                body.dataset.loaded = 'true';
                return;
            }

            body.innerHTML = `
                <div class="space-y-0.5">
                    ${snippets.map(snippet => {
                snippetCacheById[snippet.id] = snippet;
                const encoded = encodeURIComponent(snippet.content || '');
                return `
                            <div id="snippet-item-${snippet.id}" class="group w-full py-1 px-2 rounded hover:bg-slate-800/50 cursor-pointer transition-colors" onclick="insertSnippetEncoded('${encoded}','${cat.id}')">
                                <div class="flex items-center justify-between w-full">
                                    <div class="text-sm text-slate-300 group-hover:text-white truncate leading-tight min-w-0 flex-1" title=${JSON.stringify(snippet.name || '')}>${snippet.name}</div>
                                    <button class="p-1 rounded hover:bg-slate-800 text-slate-400 hover:text-white leading-none flex-none" onclick="openSnippetItemMenu(event, '${cat.id}', ${snippet.id})">
                                        <i class="fa-solid fa-ellipsis"></i>
                                    </button>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
            body.dataset.loaded = 'true';
        }

        function insertSnippetEncoded(encoded, targetFieldId) {
            const text = decodeURIComponent(encoded || '');
            insertSnippetText(text, targetFieldId);
        }

        function openSnippetItemMenu(ev, categoryId, snippetId) {
            ev.stopPropagation();
            const menu = document.getElementById('snippet-item-menu');
            if (!menu) return;

            snippetMenuSnippetId = snippetId;
            snippetMenuCategoryId = categoryId;
            snippetMenuTriggerEl = ev.currentTarget;

            menu.classList.remove('hidden');
            snippetMenuOpen = true;
            menu.onclick = (e) => e.stopPropagation();

            requestAnimationFrame(() => {
                repositionSnippetItemMenu();
                scheduleSidebarMenuReposition();
            });
        }

        function closeSnippetItemMenu() {
            const menu = document.getElementById('snippet-item-menu');
            if (menu) menu.classList.add('hidden');
            snippetMenuOpen = false;
            snippetMenuTriggerEl = null;
            snippetMenuSnippetId = null;
            snippetMenuCategoryId = null;
        }

        function handleEditSnippet() {
            const snippet = snippetCacheById[snippetMenuSnippetId];
            const categoryId = snippetMenuCategoryId;
            closeSnippetItemMenu();
            if (!snippet) return;
            openSnippetModalForEdit(categoryId, snippet);
        }

        function handleAskDeleteSnippet() {
            const categoryId = snippetMenuCategoryId;
            const snippetId = snippetMenuSnippetId;
            closeSnippetItemMenu();
            openDeleteSnippetModal(categoryId, snippetId);
        }

        function openSnippetModalForEdit(categoryId, snippet) {
            openSnippetModal({
                id: snippet.id,
                name: snippet.name,
                categoryId: categoryId,
                content: snippet.content
            });
        }

        function openSnippetModalFromField(fieldId) {
            const ta = document.getElementById(`input-${fieldId}`);
            const text = ta ? ta.value : '';
            openSnippetModal({
                id: null,
                name: '',
                categoryId: fieldId,
                content: text
            });
        }

        function openFreeSnippetSaveModal() {
            freeSyncHtmlToMarkdown();
            const text = freeGetMarkdown();
            openSnippetModal({
                id: null,
                name: '',
                categoryId: 'free',
                content: text
            });
        }

        function openDeleteSnippetModal(categoryId, snippetId) {
            pendingDeleteCategoryId = categoryId;
            pendingDeleteSnippetId = snippetId;
            const modal = document.getElementById('modal-snippet-delete');
            if (modal) modal.classList.remove('hidden');
        }

        function closeDeleteSnippetModal() {
            const modal = document.getElementById('modal-snippet-delete');
            if (modal) modal.classList.add('hidden');
            pendingDeleteCategoryId = null;
            pendingDeleteSnippetId = null;
        }

        async function confirmDeleteSnippet() {
            if (!pendingDeleteSnippetId || !window.db || !window.db.deleteSnippet) {
                closeDeleteSnippetModal();
                return;
            }
            const ok = await window.db.deleteSnippet(pendingDeleteSnippetId);
            if (ok) {
                const el = document.getElementById(`snippet-item-${pendingDeleteSnippetId}`);
                if (el) el.remove();
                if (snippetCacheById && snippetCacheById[pendingDeleteSnippetId]) {
                    delete snippetCacheById[pendingDeleteSnippetId];
                }
            }
            closeDeleteSnippetModal();
            if (ok && pendingDeleteCategoryId) {
                await loadSnippetSection(pendingDeleteCategoryId);
            }
            if (ok && settingsCurrentPage === 'snippets') {
                await loadManageSnippetsPage();
            }
        }

        async function openSnippetCategory(id) {
            if (!isLeftOpen) toggleSidebar('left');
            activeFieldId = id;
            snippetOpenState[id] = true;
            renderSnippetsAccordion();
            await loadSnippetSection(id);
            const header = document.getElementById(`snip-body-${id}`)?.previousElementSibling;
            if (header && header.scrollIntoView) header.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function loadSnippetsForField(fieldId) {
            await openSnippetCategory(fieldId);
        }

        function loadSnippetsForFieldDemo(fieldId) {
            openSnippetCategory(fieldId);
        }

        function historyGetTimestamp(item) {
            return item?.timestamp || item?.created_at || item?.createdAt || item?.created || null;
        }

        function historyGetMode(item) {
            if (!item) return null;
            if (item.mode) return item.mode;
            const f = item.fields;
            if (f && typeof f === 'object' && f.mode) return f.mode;
            return null;
        }

        function historyInferModeFromText(text) {
            const t = (text || '').toUpperCase();
            const hasRole = t.includes('ROLLE');
            const hasContext = t.includes('KONTEXT');
            const hasTask = t.includes('AUFGABE');
            if (hasRole && hasContext && hasTask) return 'structured';
            return 'free';
        }

        function historyParseStructuredFromText(text) {
            const out = { role: '', context: '', task: '', format: '' };
            const buckets = { role: [], context: [], task: [], format: [] };

            const lines = (text || '').replace(/\r\n/g, '\n').split('\n');
            let cur = null;

            const detect = (line) => {
                const norm = String(line || '').replace(/\*/g, '').trim().toUpperCase();
                if (!norm) return null;
                if (norm.includes('ROLLE')) return 'role';
                if (norm.includes('KONTEXT')) return 'context';
                if (norm.includes('AUFGABE')) return 'task';
                if (norm.includes('VARIANTEN') || norm.includes('FORMAT')) return 'format';
                return null;
            };

            for (const line of lines) {
                const key = detect(line);
                if (key) {
                    cur = key;
                    continue;
                }
                if (cur) buckets[cur].push(line);
            }

            for (const k of Object.keys(out)) {
                out[k] = buckets[k].join('\n').trim();
            }
            return out;
        }

        function handleHistoryLoad(historyId) {
            const id = String(historyId);
            const item = historyCacheById[id];
            if (!item) return;

            const text = (item.text ?? '').toString();
            let mode = historyGetMode(item);
            if (!mode) mode = historyInferModeFromText(text);

            // in den Editor wechseln
            switchView('editor');

            if (mode === 'free') {
                setEditorMode('free');
                freeSetMarkdown(text);
                setActiveField('free');
                return;
            }

            // structured
            setEditorMode('structured');
            const fields = historyParseStructuredFromText(text);
            FIELDS.forEach(f => {
                const el = document.getElementById(`input-${f.id}`);
                if (el) el.value = fields[f.id] ?? '';
            });
            setActiveField('context');
        }

        function toggleHistoryItemFullscreen(historyId) {
            const id = String(historyId);
            const box = document.getElementById(`history-text-${id}`);
            const icon = document.getElementById(`history-fullscreen-icon-${id}`);
            if (!box || !icon) return;

            const isExpanded = !!historyFullscreenState[id];

            if (!isExpanded) {
                // base inline style merken (meist leer) und dann "3x" vergrößern
                box.dataset.baseInlineMaxHeight = box.style.maxHeight || '';
                const base = box.offsetHeight || 96;
                box.style.maxHeight = (base * 3) + 'px';

                historyFullscreenState[id] = true;
                icon.classList.remove('fa-up-right-and-down-left-from-center');
                icon.classList.add('fa-down-left-and-up-right-to-center');
            } else {
                // zurücksetzen auf Tailwind-Klasse
                box.style.maxHeight = box.dataset.baseInlineMaxHeight || '';
                historyFullscreenState[id] = false;
                icon.classList.remove('fa-down-left-and-up-right-to-center');
                icon.classList.add('fa-up-right-and-down-left-from-center');
            }
        }

        function renderHistoryList(history) {
            const container = document.getElementById('history-list');
            if (!container) return;

            historyCacheById = {};

            if (!history || history.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-10">Keine Einträge.</div>';
                return;
            }

            container.innerHTML = history.map((item, idx) => {
                const id = String(item.id ?? idx);
                historyCacheById[id] = item;

                const ts = historyGetTimestamp(item);
                const dateStr = ts ? new Date(ts).toLocaleString('de-DE') : '';

                const text = escapeHtml((item.text ?? '').toString());

                return `
                    <div class="bg-navy-sidebar rounded-md border border-navy-border p-4 hover:border-slate-500 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs font-bold text-slate-500">${dateStr}</span>
                            <div class="flex items-center gap-1">
                                <button class="group p-1.5 bg-transparent rounded-md hover:bg-slate-800/60 transition-colors"
                                        onclick="toggleHistoryItemFullscreen('${id}')"
                                        title="Box vergrößern">
                                    <i id="history-fullscreen-icon-${id}"
                                       class="fa-solid fa-up-right-and-down-left-from-center text-brand-sky group-hover:text-brand-hover transition-colors"></i>
                                </button>
                                <button class="group p-1.5 bg-transparent rounded-md hover:bg-slate-800/60 transition-colors"
                                        onclick="handleHistoryLoad('${id}')"
                                        title="Prompt laden">
                                    <i class="fa-solid fa-copy text-brand-sky group-hover:text-brand-hover transition-colors"></i>
                                </button>
                            </div>
                        </div>

                        <div id="history-text-${id}"
                             class="text-sm font-mono text-slate-400 max-h-24 overflow-y-auto whitespace-pre-wrap break-words pr-2 overscroll-contain">
                            ${text}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadHistory() {
            if (!window.db) return;
            const history = await window.db.getHistory();
            renderHistoryList(history);
        }

        function renderFavoritesList(history) {
            const favs = history.filter(h => h.favorite);
            const container = document.getElementById('favorites-list');
            if (favs.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-10">Keine Favoriten.</div>';
                return;
            }
            container.innerHTML = favs.map(item => `
                <div class="bg-navy-sidebar rounded-md border border-navy-border p-4 border-l-4 border-l-brand-sky">
                    <div class="text-sm font-mono text-slate-300">
                        ${item.text.substring(0, 100)}...
                    </div>
                </div>
            `).join('');
        }

        function openSnippetModal(prefill = {}) {
            if (!window.currentUser) {
                alert("Bitte einloggen...");
                openAuthModal();
                return;
            }
            const modal = document.getElementById('modal-snippet');
            const titleEl = document.getElementById('snippet-modal-title');
            const nameEl = document.getElementById('snippet-name');
            const categoryEl = document.getElementById('snippet-category');
            const contentEl = document.getElementById('snippet-content');

            editingSnippetId = prefill.id || null;
            editingSnippetOriginalCategoryId = editingSnippetId ? (prefill.categoryId || null) : null;
            if (titleEl) titleEl.innerText = editingSnippetId ? 'Baustein bearbeiten' : 'Neuer Baustein';

            if (nameEl) nameEl.value = prefill.name || '';
            if (categoryEl) categoryEl.value = prefill.categoryId || 'context';
            if (contentEl) contentEl.value = prefill.content || '';

            if (modal) modal.classList.remove('hidden');
            if (nameEl) nameEl.focus();
        }

        function closeSnippetModal() {
            const modal = document.getElementById('modal-snippet');
            if (modal) modal.classList.add('hidden');
            editingSnippetId = null;
            editingSnippetOriginalCategoryId = null;
        }

        async function saveSnippetFromModal() {
            const nameEl = document.getElementById('snippet-name');
            const categoryEl = document.getElementById('snippet-category');
            const contentEl = document.getElementById('snippet-content');

            const name = nameEl?.value.trim();
            const content = contentEl?.value.trim();
            const category = categoryEl?.value;

            if (!name || !content) {
                alert("Name und Text sind Pflicht.");
                return;
            }

            let mode = 'structured';
            let field_id = category;
            if (category === 'free') {
                mode = 'free';
                field_id = 'free';
            }

            let success = false;
            if (editingSnippetId && window.db && window.db.updateSnippet) {
                success = await window.db.updateSnippet(editingSnippetId, { name, content, mode, field_id });
            } else if (window.db && window.db.saveSnippet) {
                success = await window.db.saveSnippet({ name, content, mode, field_id });
            }

            if (success) {
                closeSnippetModal();
                const oldCategory = editingSnippetOriginalCategoryId;
                editingSnippetOriginalCategoryId = null;
                snippetOpenState[category] = true;
                renderSnippetsAccordion();
                if (oldCategory && oldCategory !== category) {
                    const oldBody = document.getElementById(`snip-body-${oldCategory}`);
                    if (oldBody) oldBody.dataset.loaded = 'false';
                    if (snippetOpenState[oldCategory]) {
                        await loadSnippetSection(oldCategory);
                    }
                }
                await loadSnippetSection(category);
                if (settingsCurrentPage === 'snippets') {
                    await loadManageSnippetsPage();
                }
            } else {
                alert("Fehler beim Speichern.");
            }
        }

        function isSavePromptModalOpen() {
            const modal = document.getElementById('modal-save-prompt');
            return !!(modal && !modal.classList.contains('hidden'));
        }

        function setSavePromptCategory(value) {
            savePromptSelectedCategory = (value || '').trim();
            const label = savePromptSelectedCategory || 'Ohne Kategorie';
            const el = document.getElementById('save-prompt-category-value');
            if (el) el.textContent = label;
            closeSavePromptCategoryMenu();
        }

        function renderSavePromptCategoryMenu(categories) {
            const list = document.getElementById('save-prompt-category-list');
            if (!list) return;
            const items = [];
            items.push(`
                <button class="w-full px-4 py-2 text-left text-sm text-slate-200 hover:bg-slate-800/60 truncate"
                        onclick="setSavePromptCategory('')">
                    Ohne Kategorie
                </button>
            `);
            (categories || []).forEach(n => {
                items.push(`
                    <button class="w-full px-4 py-2 text-left text-sm text-slate-200 hover:bg-slate-800/60 truncate"
                            title=${JSON.stringify(n)}
                            onclick='setSavePromptCategory(${JSON.stringify(n)})'>
                        ${escapeHtml(n)}
                    </button>
                `);
            });
            list.innerHTML = items.join('');
        }

        function openSavePromptCategoryMenu(ev) {
            if (ev) ev.stopPropagation();
            const menu = document.getElementById('save-prompt-category-menu');
            const trigger = document.getElementById('save-prompt-category-trigger');
            if (!menu || !trigger) return;
            menu.classList.remove('hidden');
            savePromptCategoryMenuOpen = true;
            menu.onclick = (e) => e.stopPropagation();
            requestAnimationFrame(() => {
                const rect = trigger.getBoundingClientRect();
                const menuHeight = menu.offsetHeight;
                const spaceBelow = window.innerHeight - rect.bottom;
                const spaceAbove = rect.top;
                if (spaceBelow < menuHeight && spaceAbove > spaceBelow) {
                    menu.style.top = 'auto';
                    menu.style.bottom = 'calc(100% + 6px)';
                } else {
                    menu.style.bottom = 'auto';
                    menu.style.top = 'calc(100% + 6px)';
                }
            });
        }

        function closeSavePromptCategoryMenu() {
            const menu = document.getElementById('save-prompt-category-menu');
            if (menu) menu.classList.add('hidden');
            savePromptCategoryMenuOpen = false;
        }

        async function refreshSavePromptCategoryMenu() {
            try {
                const rows = window.db.getPromptCategories ? await window.db.getPromptCategories() : [];
                const names = (rows || [])
                    .map(r => (typeof r === 'string' ? r : r.name))
                    .filter(Boolean)
                    .map(s => s.trim())
                    .filter(Boolean);
                const unique = [...new Set(names)].sort((a, b) => a.localeCompare(b, 'de'));
                renderSavePromptCategoryMenu(unique);
            } catch (e) {
                console.error('Kategorie Dropdown Laden Fehler', e);
                renderSavePromptCategoryMenu([]);
            }
        }

        function handleSavePromptCategoryCreate(ev) {
            if (ev) ev.stopPropagation();
            closeSavePromptCategoryMenu();
            openPromptCategoryModal();
        }

        async function openSavePromptModal() {
            const modal = document.getElementById('modal-save-prompt');
            const inp = document.getElementById('save-prompt-name');
            const err = document.getElementById('save-prompt-error');
            if (err) {
                err.classList.add('hidden');
                err.innerText = '';
            }
            if (inp) inp.value = '';
            setSavePromptCategory('');
            await refreshSavePromptCategoryMenu();
            if (modal) modal.classList.remove('hidden');
            setTimeout(() => inp && inp.focus(), 50);
        }

        function closeSavePromptModal() {
            const modal = document.getElementById('modal-save-prompt');
            if (modal) modal.classList.add('hidden');
            closeSavePromptCategoryMenu();
        }

        async function confirmSavePromptModal() {
            const name = (document.getElementById('save-prompt-name')?.value || '').trim();
            const err = document.getElementById('save-prompt-error');
            if (!name) {
                if (err) {
                    err.innerText = 'Bitte einen Namen eingeben.';
                    err.classList.remove('hidden');
                }
                return;
            }
            closeSavePromptModal();
            await saveCurrentToLibraryWithName(name);
        }

        async function saveCurrentToLibrary() {
            if (!window.currentUser) {
                openAuthModal();
                return;
            }
            openSavePromptModal();
        }

        async function saveCurrentToLibraryWithName(name) {
            if (!window.currentUser) {
                openAuthModal();
                return;
            }

            const catVal = (savePromptSelectedCategory || '').trim() || null;

            if (currentMode === 'structured') {
                const fieldsData = [
                    document.getElementById('input-role')?.value || '',
                    document.getElementById('input-context')?.value || '',
                    document.getElementById('input-task')?.value || '',
                    '',
                    document.getElementById('input-format')?.value || ''
                ];
                if (window.db && window.db.saveScenario) {
                    const success = await window.db.saveScenario({
                        name: name,
                        category: catVal,
                        fields: fieldsData
                    });

                    if (success) {
                        loadLibrary();
                    } else {
                        alert("Fehler beim Speichern.");
                    }
                }
            } else {
                const raw = getFreeMarkdownFromEditor().replace(/\r\n/g, '\n');
                if (!raw.trim()) {
                    alert("Bitte Text eingeben.");
                    return;
                }
                if (window.db && window.db.saveScenario) {
                    const success = await window.db.saveScenario({
                        name: name,
                        category: catVal,
                        fields: { mode: 'free', text: raw }
                    });

                    if (success) {
                        loadLibrary();
                    } else {
                        alert("Fehler beim Speichern.");
                    }
                }
            }
        }

        window.openSnippets = (id) => {
            openSnippetCategory(id);
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="db.js"></script>
</body>

</html>